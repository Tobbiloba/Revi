import e from"react";const t=e,s=t.createContext({monitor:null,isInitialized:!1,sessionId:""});var i=function({children:e,apiKey:i,apiUrl:n="https://api.revi.dev",environment:r="production",debug:a=!1,userId:o,userEmail:c,sampleRate:d=1,sessionSampleRate:l=1}){const[h,u]=t.useState(null),[p,g]=t.useState(!1),[m,v]=t.useState(""),f=t.useRef(!1);t.useEffect(()=>{if(!f.current&&(f.current=!0,"undefined"!=typeof window))return async function(){try{let e;if("undefined"!=typeof window&&window.ReviMonitor)e=window.ReviMonitor.Monitor;else try{e=(await Promise.resolve().then(function(){return k})).Monitor}catch(e){return void(a&&console.error("Revi: Failed to import Monitor class",e))}if(!e)return void(a&&console.error("Revi: Monitor class not found"));const t=new e({apiKey:i,apiUrl:n,environment:r,debug:a,userId:o,sampleRate:d,sessionSampleRate:l,maxBreadcrumbs:50,privacy:{maskInputs:!0,maskPasswords:!0,maskCreditCards:!0},performance:{captureWebVitals:!0,captureResourceTiming:!1,captureNavigationTiming:!0},replay:{enabled:!0,maskAllInputs:!1,maskAllText:!1}});u(t),v(t.getSessionId()),g(!0),(o||c)&&t.setUserContext({id:o,email:c}),a&&console.log("Revi: Initialized successfully",{sessionId:t.getSessionId()})}catch(e){a&&console.error("Revi: Failed to initialize",e)}}(),()=>{if(h)try{h.destroy()}catch(e){}}},[i,n,r,a,o,c,d,l]);const y={monitor:h,isInitialized:p,sessionId:m};return t.createElement(s.Provider,{value:y},e)},n=()=>t.useContext(s);function r(){return"xxxx-xxxx-4xxx-yxxx-xxxx".replace(/[xy]/g,function(e){const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})}function a(e){return e.stack?e.stack.split("\n").map(e=>e.trim()).filter(e=>e.length>0).join("\n"):""}class o{constructor(){this.spanCounter=0,this.spanData=new Map,this.generateNewTrace()}generateNewTrace(){return this.currentTraceId=this.generateTraceId(),this.currentSpanId=void 0,this.spanCounter=0,this.currentTraceId}startSpan(e){const t=this.currentSpanId;return this.currentSpanId=this.generateSpanId(),this.spanCounter++,e&&this.setSpanData(e,{parentSpanId:t,operationName:e,startTime:Date.now()}),this.currentSpanId}finishSpan(e,t){e&&this.currentSpanId===e&&t&&this.setSpanData(e,{...this.getSpanData(e),...t,endTime:Date.now()})}getCurrentTraceId(){return this.currentTraceId}getCurrentSpanId(){return this.currentSpanId}getTraceContext(){return{traceId:this.currentTraceId,spanId:this.currentSpanId,parentSpanId:this.getParentSpanId()}}extractTraceFromHeaders(e){var t,s,i,n;return{traceId:e["x-trace-id"]||(null===(t=e.traceparent)||void 0===t?void 0:t.split("-")[1])||e["b3-traceid"]||(null===(s=e["uber-trace-id"])||void 0===s?void 0:s.split(":")[0]),spanId:e["x-span-id"]||(null===(i=e.traceparent)||void 0===i?void 0:i.split("-")[2])||e["b3-spanid"]||(null===(n=e["uber-trace-id"])||void 0===n?void 0:n.split(":")[1])}}injectTraceHeaders(){if(!this.currentTraceId)return{};const e={};return e["x-trace-id"]=this.currentTraceId,this.currentSpanId&&(e["x-span-id"]=this.currentSpanId,e["x-parent-span-id"]=this.getParentSpanId()||""),this.currentSpanId&&(e.traceparent=`00-${this.currentTraceId}-${this.currentSpanId}-01`),e}correlateWithBackendTrace(e,t){e&&(this.currentTraceId=e),t&&(this.currentSpanId=t)}generateTraceId(){return this.generateRandomHex(32)}generateSpanId(){return this.generateRandomHex(16)}generateRandomHex(e){const t=new Uint8Array(e/2);if("undefined"!=typeof crypto&&crypto.getRandomValues)crypto.getRandomValues(t);else for(let e=0;e<t.length;e++)t[e]=Math.floor(256*Math.random());return Array.from(t,e=>e.toString(16).padStart(2,"0")).join("")}getParentSpanId(){var e;return null===(e=this.spanData.get(this.currentSpanId||""))||void 0===e?void 0:e.parentSpanId}setSpanData(e,t){this.spanData.set(e,t)}getSpanData(e){return this.spanData.get(e)||{}}cleanupSpanData(){const e=Date.now()-3e5;for(const[t,s]of this.spanData.entries())s.endTime&&s.endTime<e&&this.spanData.delete(t)}}class c{constructor(e,t){this.breadcrumbs=[],this.userContext={},this.config=e,this.traceManager=t||new o,this.setupGlobalHandlers()}setupGlobalHandlers(){if("undefined"==typeof window)return;window.addEventListener("error",e=>{this.captureError({message:e.message,filename:e.filename,lineno:e.lineno,colno:e.colno,error:e.error})}),window.addEventListener("unhandledrejection",e=>{const t=e.reason;let s="Unhandled Promise Rejection",i="";t instanceof Error?(s=t.message,i=a(t)):s="string"==typeof t?t:JSON.stringify(t),this.captureError({message:s,stack:i,error:t})});const e=console.error;console.error=(...t)=>{this.addBreadcrumb({timestamp:Date.now(),message:t.join(" "),category:"console",level:"error"}),e.apply(console,t)};const t=console.warn;console.warn=(...e)=>{this.addBreadcrumb({timestamp:Date.now(),message:e.join(" "),category:"console",level:"warning"}),t.apply(console,e)}}captureError(e){var t,s;if(this.config.sampleRate&&Math.random()>this.config.sampleRate)return"";const i=r(),n=this.traceManager.startSpan(`error:${e.message}`),o=this.traceManager.getTraceContext(),c={id:i,timestamp:Date.now(),message:e.message,stack:e.stack||(e.error?a(e.error):void 0),url:e.filename||window.location.href,lineno:e.lineno,colno:e.colno,filename:e.filename,userId:this.config.userId||this.userContext.id,sessionId:"",userAgent:navigator.userAgent,environment:this.config.environment,release:this.config.release,tags:e.tags,extra:e.extra,breadcrumbs:[...this.breadcrumbs],level:e.level||"error",traceId:o.traceId,spanId:n,parentSpanId:o.parentSpanId};return(null===(s=(t=this.config).beforeSend)||void 0===s?void 0:s.call(t,c))||c?i:""}captureException(e,t={}){return this.captureError({message:e.message,stack:a(e),error:e,level:t.level,tags:t.tags,extra:t.extra})}captureMessage(e,t={}){return this.captureError({message:e,level:t.level||"info",tags:t.tags,extra:t.extra})}addBreadcrumb(e){this.breadcrumbs.push(e);const t=this.config.maxBreadcrumbs||50;this.breadcrumbs.length>t&&this.breadcrumbs.splice(0,this.breadcrumbs.length-t)}setUserContext(e){this.userContext={...this.userContext,...e}}setTags(e){}setExtra(e){}getBreadcrumbs(){return[...this.breadcrumbs]}clearBreadcrumbs(){this.breadcrumbs=[]}}class d{constructor(e,t){this.events=[],this.config=e,this.traceManager=t,this.storage=function(){try{if("undefined"!=typeof window&&window.sessionStorage)return window.sessionStorage.setItem("test","test"),window.sessionStorage.removeItem("test"),window.sessionStorage}catch(e){}return null}(),this.sessionId=this.getOrCreateSessionId(),this.startTime=Date.now(),this.setupEventListeners(),this.trackPageLoad()}getOrCreateSessionId(){const e="revi_session_id";if(this.storage){const t=this.storage.getItem(e);if(t)return t}const t=r();return this.storage&&this.storage.setItem(e,t),t}getSessionId(){return this.sessionId}setupEventListeners(){if("undefined"==typeof window)return;let e,t;["click","input","change","submit","focus","blur"].forEach(e=>{document.addEventListener(e,t=>{this.captureEvent(e,this.serializeDOMEvent(t))},{capture:!0,passive:!0})}),window.addEventListener("popstate",()=>{this.captureEvent("navigation",{type:"popstate",url:window.location.href,timestamp:Date.now()})}),document.addEventListener("visibilitychange",()=>{this.captureEvent("visibility",{hidden:document.hidden,timestamp:Date.now()})}),window.addEventListener("scroll",()=>{clearTimeout(e),e=setTimeout(()=>{this.captureEvent("scroll",{x:window.scrollX,y:window.scrollY,timestamp:Date.now()})},100)},{passive:!0}),window.addEventListener("resize",()=>{clearTimeout(t),t=setTimeout(()=>{this.captureEvent("resize",{width:window.innerWidth,height:window.innerHeight,timestamp:Date.now()})},100)},{passive:!0}),window.addEventListener("beforeunload",()=>{this.captureEvent("beforeunload",{timestamp:Date.now(),duration:Date.now()-this.startTime}),this.flush()})}serializeDOMEvent(e){var t;const s=e.target;if(!s)return{};const i={type:e.type,timestamp:Date.now(),target:{tagName:s.tagName,id:s.id,className:s.className,textContent:this.shouldMaskText(s)?"[Masked]":null===(t=s.textContent)||void 0===t?void 0:t.slice(0,100)}};if("click"===e.type){const t=e;i.coordinates={x:t.clientX,y:t.clientY}}if("input"===e.type||"change"===e.type){const t=e.target;t&&void 0!==t.value&&(i.value=this.shouldMaskInput(t)?"[Masked]":t.value)}return i}shouldMaskInput(e){var t,s,i;if(!(null===(t=this.config.privacy)||void 0===t?void 0:t.maskInputs))return!1;if(["password","email","tel","credit-card-number"].includes(e.type))return!0;const n=(null===(s=e.name)||void 0===s?void 0:s.toLowerCase())||"",r=(null===(i=e.id)||void 0===i?void 0:i.toLowerCase())||"";return["password","email","phone","credit","card","ssn"].some(e=>n.includes(e)||r.includes(e))}shouldMaskText(e){var t,s;if(!(null===(t=this.config.replay)||void 0===t?void 0:t.maskAllText))return!1;if(null===(s=this.config.replay)||void 0===s?void 0:s.maskSelector)try{return e.matches(this.config.replay.maskSelector)}catch(e){return!1}return!1}trackPageLoad(){if("undefined"==typeof window)return;const e=()=>{this.captureEvent("page_load",{url:window.location.href,title:document.title,referrer:document.referrer,timestamp:Date.now(),loadTime:performance.now()})};"complete"===document.readyState?e():window.addEventListener("load",e)}captureEvent(e,t){var s,i,n,r;if(this.config.sessionSampleRate&&Math.random()>this.config.sessionSampleRate)return;const a=null===(s=this.traceManager)||void 0===s?void 0:s.getTraceContext(),o=null===(i=this.traceManager)||void 0===i?void 0:i.startSpan(`session:${e}`),c={sessionId:this.sessionId,timestamp:Date.now(),type:e,data:t,traceId:null==a?void 0:a.traceId,spanId:o},d=(null===(r=(n=this.config).beforeSendSession)||void 0===r?void 0:r.call(n,c))||c;d&&(this.events.push(d),this.events.length>=100&&this.flush())}getEvents(){return[...this.events]}clearEvents(){this.events=[]}flush(){const e=this.getEvents();return this.clearEvents(),e}endSession(){this.captureEvent("session_end",{timestamp:Date.now(),duration:Date.now()-this.startTime}),this.storage&&this.storage.removeItem("revi_session_id")}}class l{constructor(e,t){this.events=[],this.config=e,this.traceManager=t||new o,this.originalFetch=window.fetch,this.originalXHROpen=XMLHttpRequest.prototype.open,this.originalXHRSend=XMLHttpRequest.prototype.send,this.setupInterceptors()}setupInterceptors(){"undefined"!=typeof window&&(this.interceptFetch(),this.interceptXHR())}interceptFetch(){window.fetch=async(...e)=>{var t,s,i;const n=Date.now(),r="string"==typeof e[0]?e[0]:e[0].url,a=((null===(t=e[1])||void 0===t?void 0:t.method)||"GET").toUpperCase();if(!this.shouldMonitorRequest(r))return await this.originalFetch.apply(window,e);const o=this.traceManager.startSpan(`http:${a} ${r}`),c=this.traceManager.injectTraceHeaders(),d={...(null===(s=e[1])||void 0===s?void 0:s.headers)||{},...c},l=[e[0],{...e[1],headers:d}];let h,u=0;(null===(i=e[1])||void 0===i?void 0:i.body)&&(h=this.serializeRequestBody(e[1].body),u=this.calculateBodySize(e[1].body));try{const t=await this.originalFetch.apply(window,l),s=Date.now();let i,c=0;if(this.shouldCaptureResponseBody(r)){const s=t.clone();try{i=await this.extractResponseBody(s),c=this.calculateResponseSize(i)}catch(e){}}const p=this.traceManager.extractTraceFromHeaders(this.extractResponseHeaders(t.headers));p.traceId&&this.traceManager.correlateWithBackendTrace(p.traceId,p.spanId),this.traceManager.finishSpan(o,{statusCode:t.status,responseTime:s-n});const g=this.traceManager.getTraceContext();return this.captureNetworkEvent({method:a,url:r,statusCode:t.status,responseTime:s-n,requestSize:u,responseSize:c,requestHeaders:this.extractHeaders(d),responseHeaders:this.extractResponseHeaders(t.headers),requestBody:h,responseBody:i,timestamp:n,traceId:g.traceId,spanId:o,parentSpanId:g.parentSpanId}),t}catch(e){const t=Date.now();this.traceManager.finishSpan(o,{statusCode:0,responseTime:t-n,error:e instanceof Error?e.message:String(e)});const s=this.traceManager.getTraceContext();throw this.captureNetworkEvent({method:a,url:r,statusCode:0,responseTime:t-n,requestSize:u,responseSize:0,requestHeaders:this.extractHeaders(d),requestBody:h,timestamp:n,traceId:s.traceId,spanId:o,parentSpanId:s.parentSpanId}),e}}}interceptXHR(){const e=this;XMLHttpRequest.prototype.open=function(t,s,...i){return this._reviData={method:t.toUpperCase(),url:s,startTime:Date.now(),shouldMonitor:e.shouldMonitorRequest(s)},e.originalXHROpen.call(this,t,s,...i)},XMLHttpRequest.prototype.send=function(t){const s=this._reviData;return s&&s.shouldMonitor?(s.requestBody=e.serializeRequestBody(t),s.requestSize=e.calculateBodySize(t),this.addEventListener("loadend",()=>{const t=Date.now();let i;try{""===this.responseType||"text"===this.responseType?i=this.responseText:"json"===this.responseType&&(i=this.response)}catch(e){}e.captureNetworkEvent({method:s.method,url:s.url,statusCode:this.status,responseTime:t-s.startTime,requestSize:s.requestSize,responseSize:e.calculateResponseSize(i),requestBody:s.requestBody,responseBody:e.shouldCaptureResponseBody(s.url)?i:void 0,timestamp:s.startTime})}),e.originalXHRSend.call(this,t)):e.originalXHRSend.call(this,t)}}serializeRequestBody(e){if(e){if("string"==typeof e)return e;if(e instanceof FormData){const t={};return e.forEach((e,s)=>{t[s]=e instanceof File?`[File: ${e.name}]`:e}),t}if(e instanceof URLSearchParams)return Object.fromEntries(e);try{return JSON.parse(JSON.stringify(e))}catch(e){return"[Unserializable]"}}}async extractResponseBody(e){const t=e.headers.get("content-type")||"";return t.includes("application/json")?await e.json():t.includes("text/")?await e.text():"[Binary Data]"}extractHeaders(e){if(!e)return{};if(e instanceof Headers){const t={};return e.forEach((e,s)=>{t[s]=e}),t}if(Array.isArray(e)){const t={};return e.forEach(([e,s])=>{t[e]=s}),t}return e}extractResponseHeaders(e){const t={};return e.forEach((e,s)=>{t[s]=e}),t}calculateBodySize(e){if(!e)return 0;if("string"==typeof e)return e.length;if(e instanceof ArrayBuffer)return e.byteLength;if(e instanceof Blob)return e.size;try{return JSON.stringify(e).length}catch(e){return 0}}calculateResponseSize(e){if(!e)return 0;try{return JSON.stringify(e).length}catch(e){return 0}}shouldCaptureResponseBody(e){return[/\/api\//,/\/graphql/].some(t=>t.test(e))}shouldMonitorRequest(e){var t,s;const i=this.config.apiUrl||"https://api.revi.dev",n=i.replace(/\/$/,""),r=e.replace(/\/$/,"");if(this.config.debug&&console.log("[Revi Debug] Network filter check:",{url:e,normalizedUrl:r,apiUrl:i,normalizedApiUrl:n}),r.startsWith(n))return this.config.debug&&console.log("[Revi Debug] Filtering API URL:",e,"(matches configured apiUrl)"),!1;const a=(this.config.developmentHosts||[/^https?:\/\/localhost:\d+/,/^https?:\/\/127\.0\.0\.1:\d+/,/^https?:\/\/0\.0\.0\.0:\d+/,/^https?:\/\/.*\.local:\d+/]).find(t=>t.test(e));if(a)return this.config.debug&&console.log("[Revi Debug] Filtering development host URL:",e,"(matched pattern:",a,")"),!1;const o=[/\/api\/capture\//,/\/api\/errors/,/\/api\/session/,/\/api\/projects/,/\/api\/database/,/\/api\/analytics/,/\/health$/].find(t=>t.test(e));if(o)return this.config.debug&&console.log("[Revi Debug] Filtering API endpoint:",e,"(matched pattern:",o,")"),!1;if(this.config.excludeUrls&&this.config.excludeUrls.some(t=>t.test(e)))return this.config.debug&&console.log("[Revi Debug] Filtering excluded URL:",e),!1;if((null===(t=this.config.privacy)||void 0===t?void 0:t.denyUrls)&&this.config.privacy.denyUrls.some(t=>new RegExp(t).test(e)))return this.config.debug&&console.log("[Revi Debug] Filtering denied URL:",e),!1;if(null===(s=this.config.privacy)||void 0===s?void 0:s.allowUrls){const t=this.config.privacy.allowUrls.some(t=>new RegExp(t).test(e));return this.config.debug&&console.log("[Revi Debug] Allow list result for:",e,"- allowed:",t),t}return this.config.debug&&console.log("[Revi Debug] Monitoring URL:",e,"(no filters matched)"),!0}captureNetworkEvent(e){const t={sessionId:"",timestamp:e.timestamp,method:e.method,url:e.url,statusCode:e.statusCode,responseTime:e.responseTime,requestSize:e.requestSize,responseSize:e.responseSize,requestHeaders:e.requestHeaders,responseHeaders:e.responseHeaders,requestBody:e.requestBody,responseBody:e.responseBody};this.events.push(t),this.events.length>=50&&this.flush()}getEvents(){return[...this.events]}clearEvents(){this.events=[]}flush(){const e=this.getEvents();return this.clearEvents(),e}destroy(){this.originalFetch&&(window.fetch=this.originalFetch),XMLHttpRequest.prototype.open=this.originalXHROpen,XMLHttpRequest.prototype.send=this.originalXHRSend}}class h{constructor(e){var t,s,i;this.webVitals={},this.performanceEntries=[],this.config=e,(null===(t=this.config.performance)||void 0===t?void 0:t.captureWebVitals)&&this.setupWebVitals(),(null===(s=this.config.performance)||void 0===s?void 0:s.captureResourceTiming)&&this.setupResourceTiming(),(null===(i=this.config.performance)||void 0===i?void 0:i.captureNavigationTiming)&&this.setupNavigationTiming()}setupWebVitals(){if("undefined"!=typeof window&&"PerformanceObserver"in window){try{new PerformanceObserver(e=>{const t=e.getEntries(),s=t[t.length-1];this.webVitals.lcp=s.startTime}).observe({entryTypes:["largest-contentful-paint"]})}catch(e){}try{new PerformanceObserver(e=>{e.getEntries().forEach(e=>{this.webVitals.fid=e.processingStart-e.startTime})}).observe({entryTypes:["first-input"]})}catch(e){}try{let e=0;new PerformanceObserver(t=>{t.getEntries().forEach(t=>{t.hadRecentInput||(e+=t.value,this.webVitals.cls=e)})}).observe({entryTypes:["layout-shift"]})}catch(e){}try{new PerformanceObserver(e=>{e.getEntries().forEach(e=>{"first-contentful-paint"===e.name&&(this.webVitals.fcp=e.startTime)})}).observe({entryTypes:["paint"]})}catch(e){}this.calculateTTFB()}}calculateTTFB(){if("undefined"!=typeof window&&window.performance)try{const e=performance.getEntriesByType("navigation")[0];e&&(this.webVitals.ttfb=e.responseStart-e.requestStart)}catch(e){}}setupResourceTiming(){if("undefined"!=typeof window&&window.performance)try{new PerformanceObserver(e=>{e.getEntries().forEach(e=>{this.performanceEntries.push({name:e.name,entryType:e.entryType,startTime:e.startTime,duration:e.duration,transferSize:e.transferSize,encodedBodySize:e.encodedBodySize,decodedBodySize:e.decodedBodySize})})}).observe({entryTypes:["resource"]})}catch(e){}}setupNavigationTiming(){"undefined"!=typeof window&&window.performance&&window.addEventListener("load",()=>{try{const e=performance.getEntriesByType("navigation")[0];e&&this.performanceEntries.push({name:"navigation",entryType:"navigation",startTime:e.startTime,duration:e.duration,domContentLoadedEventEnd:e.domContentLoadedEventEnd,domContentLoadedEventStart:e.domContentLoadedEventStart,loadEventEnd:e.loadEventEnd,loadEventStart:e.loadEventStart,domComplete:e.domComplete,domInteractive:e.domInteractive})}catch(e){}})}getWebVitals(){return{...this.webVitals}}getPerformanceEntries(){return[...this.performanceEntries]}clearPerformanceEntries(){this.performanceEntries=[]}mark(e){if("undefined"!=typeof window&&window.performance&&window.performance.mark)try{performance.mark(e)}catch(e){}}measure(e,t,s){if("undefined"==typeof window||!window.performance||!window.performance.measure)return null;try{performance.measure(e,t,s);const i=performance.getEntriesByName(e,"measure")[0];return i?i.duration:null}catch(e){return null}}}class u{constructor(){this.db=null,this.dbName="revi-storage",this.version=1,this.storeName="queue",this.maxQueueSize=1e3,this.maxAge=6048e5}async initialize(){if("undefined"==typeof window||!window.indexedDB)throw new Error("IndexedDB not supported");return new Promise((e,t)=>{const s=indexedDB.open(this.dbName,this.version);s.onerror=()=>{t(new Error("Failed to open IndexedDB"))},s.onsuccess=()=>{this.db=s.result,e()},s.onupgradeneeded=e=>{const t=e.target.result;if(!t.objectStoreNames.contains(this.storeName)){const e=t.createObjectStore(this.storeName,{keyPath:"id"});e.createIndex("timestamp","timestamp",{unique:!1}),e.createIndex("type","type",{unique:!1})}}})}async store(e,t){this.db||await this.initialize(),await this.cleanupExpiredItems(),await this.getQueueSize()>=this.maxQueueSize&&await this.removeOldestItems(100);const s={id:this.generateId(),type:e,data:await this.compress(t),timestamp:Date.now(),compressed:!0};return new Promise((e,t)=>{if(!this.db)return void t(new Error("Database not initialized"));const i=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName).add(s);i.onsuccess=()=>e(),i.onerror=()=>t(new Error("Failed to store item"))})}async getAll(){return this.db||await this.initialize(),new Promise((e,t)=>{if(!this.db)return void t(new Error("Database not initialized"));const s=this.db.transaction([this.storeName],"readonly").objectStore(this.storeName).getAll();s.onsuccess=async()=>{const t=s.result,i={errors:[],sessionEvents:[],networkEvents:[]};for(const e of t){const t=await this.decompress(e.data);switch(e.type){case"error":i.errors.push(...Array.isArray(t)?t:[t]);break;case"session":i.sessionEvents.push(...Array.isArray(t)?t:[t]);break;case"network":i.networkEvents.push(...Array.isArray(t)?t:[t])}}e(i)},s.onerror=()=>t(new Error("Failed to retrieve items"))})}async clear(){return this.db||await this.initialize(),new Promise((e,t)=>{if(!this.db)return void t(new Error("Database not initialized"));const s=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName).clear();s.onsuccess=()=>e(),s.onerror=()=>t(new Error("Failed to clear storage"))})}async getQueueSize(){return this.db||await this.initialize(),new Promise((e,t)=>{if(!this.db)return void t(new Error("Database not initialized"));const s=this.db.transaction([this.storeName],"readonly").objectStore(this.storeName).count();s.onsuccess=()=>e(s.result),s.onerror=()=>t(new Error("Failed to get queue size"))})}async cleanupExpiredItems(){if(!this.db)return;const e=Date.now()-this.maxAge;return new Promise(t=>{if(!this.db)return void t();const s=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName).index("timestamp"),i=IDBKeyRange.upperBound(e),n=s.openCursor(i);n.onsuccess=e=>{const s=e.target.result;s?(s.delete(),s.continue()):t()},n.onerror=()=>t()})}async removeOldestItems(e){if(this.db)return new Promise(t=>{if(!this.db)return void t();const s=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName).index("timestamp").openCursor();let i=0;s.onsuccess=s=>{const n=s.target.result;n&&i<e?(n.delete(),i++,n.continue()):t()},s.onerror=()=>t()})}async compress(e){try{const t=JSON.stringify(e);return btoa(unescape(encodeURIComponent(t)))}catch(t){return JSON.stringify(e)}}async decompress(e){try{const t=decodeURIComponent(escape(atob(e)));return JSON.parse(t)}catch(t){try{return JSON.parse(e)}catch(t){return e}}}generateId(){return`revi-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}}class p{constructor(){this.storageKey="revi_upload_queue";const e=function(){try{if("undefined"!=typeof window&&window.localStorage)return window.localStorage.setItem("test","test"),window.localStorage.removeItem("test"),window.localStorage}catch(e){}return null}();if(!e)throw new Error("No storage available");this.storage=e}async store(e,t){try{const s=await this.getAll();switch(e){case"error":s.errors.push(...Array.isArray(t)?t:[t]);break;case"session":s.sessionEvents.push(...Array.isArray(t)?t:[t]);break;case"network":s.networkEvents.push(...Array.isArray(t)?t:[t])}this.storage.setItem(this.storageKey,JSON.stringify(s))}catch(e){throw new Error("Failed to store data")}}async getAll(){try{const e=this.storage.getItem(this.storageKey);if(e)return JSON.parse(e)}catch(e){}return{errors:[],sessionEvents:[],networkEvents:[]}}async clear(){try{this.storage.removeItem(this.storageKey)}catch(e){}}}class g{constructor(){this.storage=null,this.isInitialized=!1}async initialize(){if(!this.isInitialized){try{const e=new u;await e.initialize(),this.storage=e,console.log("[Revi] Using IndexedDB for offline storage")}catch(e){try{this.storage=new p,console.log("[Revi] Using localStorage for offline storage")}catch(e){console.warn("[Revi] No storage available, data will not persist offline"),this.storage=new m}}this.isInitialized=!0}}async storeErrors(e){await this.ensureInitialized(),e.length>0&&await this.storage.store("error",e)}async storeSessionEvents(e){await this.ensureInitialized(),e.length>0&&await this.storage.store("session",e)}async storeNetworkEvents(e){await this.ensureInitialized(),e.length>0&&await this.storage.store("network",e)}async getAllData(){return await this.ensureInitialized(),await this.storage.getAll()}async clearAll(){await this.ensureInitialized(),await this.storage.clear()}async getQueueSize(){if(await this.ensureInitialized(),this.storage&&"getQueueSize"in this.storage&&this.storage.getQueueSize)return await this.storage.getQueueSize();{const e=await this.getAllData();return e.errors.length+e.sessionEvents.length+e.networkEvents.length}}async ensureInitialized(){this.isInitialized||await this.initialize()}}class m{async store(){}async getAll(){return{errors:[],sessionEvents:[],networkEvents:[]}}async clear(){}}class v{constructor(){this.isOnline="undefined"==typeof navigator||navigator.onLine,this.connectionType="unknown",this.listeners=[],"undefined"!=typeof window&&(window.addEventListener("online",()=>{this.isOnline=!0,this.notifyListeners(!0)}),window.addEventListener("offline",()=>{this.isOnline=!1,this.notifyListeners(!1)}),this.detectConnectionType())}getConnectionStatus(){return{online:this.isOnline,connectionType:this.connectionType}}onConnectionChange(e){return this.listeners.push(e),()=>{const t=this.listeners.indexOf(e);t>-1&&this.listeners.splice(t,1)}}getBatchSize(){if(!this.isOnline)return 0;switch(this.connectionType){case"slow-2g":return 5;case"2g":return 10;case"3g":default:return 25;case"4g":return 50}}getUploadDelay(){if(!this.isOnline)return 0;switch(this.connectionType){case"slow-2g":return 3e4;case"2g":return 15e3;case"3g":default:return 1e4;case"4g":return 5e3}}shouldRetry(e){return!!this.isOnline&&e<5}getRetryDelay(e){return Math.min(1e3*Math.pow(2,e),16e3)}detectConnectionType(){if("connection"in navigator){const e=navigator.connection;this.connectionType=e.effectiveType||e.type||"unknown",e.addEventListener("change",()=>{this.connectionType=e.effectiveType||e.type||"unknown"})}}notifyListeners(e){this.listeners.forEach(t=>{try{t(e)}catch(e){console.error("[Revi] Error in connection change callback:",e)}})}async testConnectivity(e){if(!this.isOnline)return!1;try{const t=e||"https://api.revi.dev/health";return await fetch(t,{method:"HEAD",mode:"no-cors",cache:"no-cache"}),!0}catch(e){return!1}}}class f{constructor(e){this.uploadTimer=null,this.isUploading=!1,this.retryAttempts=new Map,this.uploadQueue={errors:[],sessionEvents:[],networkEvents:[]},this.config=e,this.storageManager=new g,this.networkManager=new v,this.initialize()}async initialize(){try{await this.storageManager.initialize(),await this.loadQueueFromStorage(),this.startNetworkAwareUploadTimer(),this.setupBeforeUnloadHandler(),this.setupNetworkChangeHandler()}catch(e){console.error("[Revi] Failed to initialize data manager:",e)}}async loadQueueFromStorage(){try{const e=await this.storageManager.getAllData();this.uploadQueue=e}catch(e){console.error("[Revi] Failed to load queue from storage:",e)}}async saveQueueToStorage(){try{await this.storageManager.clearAll(),this.uploadQueue.errors.length>0&&await this.storageManager.storeErrors(this.uploadQueue.errors),this.uploadQueue.sessionEvents.length>0&&await this.storageManager.storeSessionEvents(this.uploadQueue.sessionEvents),this.uploadQueue.networkEvents.length>0&&await this.storageManager.storeNetworkEvents(this.uploadQueue.networkEvents)}catch(e){console.error("[Revi] Failed to save queue to storage:",e)}}startNetworkAwareUploadTimer(){const e=()=>{this.uploadTimer&&clearTimeout(this.uploadTimer);const t=this.networkManager.getUploadDelay();t>0&&(this.uploadTimer=setTimeout(()=>{!this.isUploading&&this.hasQueuedData()?this.uploadData().finally(()=>{e()}):e()},t))};e()}setupNetworkChangeHandler(){this.networkManager.onConnectionChange(e=>{e?(console.log("[Revi] Network connection restored, resuming uploads"),this.hasQueuedData()&&!this.isUploading&&setTimeout(()=>{this.uploadData()},1e3)):console.log("[Revi] Network connection lost, uploads paused")})}setupBeforeUnloadHandler(){"undefined"!=typeof window&&window.addEventListener("beforeunload",()=>{this.hasQueuedData()&&this.uploadDataSync()})}queueError(e){this.uploadQueue.errors.push(e),this.saveQueueToStorage().catch(e=>{console.error("[Revi] Failed to save error to storage:",e)})}queueSessionEvents(e){this.uploadQueue.sessionEvents.push(...e),this.saveQueueToStorage().catch(e=>{console.error("[Revi] Failed to save session events to storage:",e)})}queueNetworkEvents(e){this.uploadQueue.networkEvents.push(...e),this.saveQueueToStorage().catch(e=>{console.error("[Revi] Failed to save network events to storage:",e)})}hasQueuedData(){return this.uploadQueue.errors.length>0||this.uploadQueue.sessionEvents.length>0||this.uploadQueue.networkEvents.length>0}async uploadData(){if(this.isUploading||!this.hasQueuedData())return;const{online:e}=this.networkManager.getConnectionStatus();if(!e)return void console.log("[Revi] Skipping upload - device is offline");this.isUploading=!0;const t=this.config.apiUrl||"https://api.revi.dev",s=this.networkManager.getBatchSize();try{if(this.uploadQueue.errors.length>0){const e=this.createBatches(this.uploadQueue.errors,s);for(const s of e)await this.uploadErrorsWithRetry(t,s);this.uploadQueue.errors=[]}if(this.uploadQueue.sessionEvents.length>0){const e=this.createBatches(this.uploadQueue.sessionEvents,s);for(const s of e)await this.uploadSessionEventsWithRetry(t,s);this.uploadQueue.sessionEvents=[]}if(this.uploadQueue.networkEvents.length>0){const e=this.createBatches(this.uploadQueue.networkEvents,s);for(const s of e)await this.uploadNetworkEventsWithRetry(t,s);this.uploadQueue.networkEvents=[]}await this.saveQueueToStorage(),this.retryAttempts.clear()}catch(e){this.config.debug&&console.error("Revi: Failed to upload data",e)}finally{this.isUploading=!1}}createBatches(e,t){if(t<=0)return[];const s=[];for(let i=0;i<e.length;i+=t)s.push(e.slice(i,i+t));return s}uploadDataSync(){var e;if(!this.hasQueuedData())return;const t=this.config.apiUrl||"https://api.revi.dev";if(navigator.sendBeacon){if(this.uploadQueue.errors.length>0){const e=JSON.stringify({errors:this.uploadQueue.errors});navigator.sendBeacon(`${t}/api/capture/error`,e)}if(this.uploadQueue.sessionEvents.length>0){const s=JSON.stringify({session_id:null===(e=this.uploadQueue.sessionEvents[0])||void 0===e?void 0:e.sessionId,events:this.uploadQueue.sessionEvents.map(e=>({event_type:e.type,data:e.data,timestamp:e.timestamp,session_id:e.sessionId}))});navigator.sendBeacon(`${t}/api/capture/session-event`,s)}if(this.uploadQueue.networkEvents.length>0){const e=JSON.stringify({events:this.uploadQueue.networkEvents});navigator.sendBeacon(`${t}/api/capture/network-event`,e)}}}async uploadErrors(e,t){const s=await fetch(`${e}/api/capture/error`,{method:"POST",headers:{"Content-Type":"application/json","X-API-Key":this.config.apiKey},body:JSON.stringify({errors:t.map(e=>({message:e.message,stack_trace:e.stack,url:e.url,user_agent:e.userAgent,session_id:e.sessionId,metadata:{id:e.id,userId:e.userId,environment:e.environment,release:e.release,tags:e.tags,extra:e.extra,breadcrumbs:e.breadcrumbs,level:e.level,lineno:e.lineno,colno:e.colno,filename:e.filename}}))})});if(!s.ok)throw new Error(`Upload failed: ${s.status}`)}async uploadSessionEvents(e,t){if(0===t.length)return;const s=t[0].sessionId,i=await fetch(`${e}/api/capture/session-event`,{method:"POST",headers:{"Content-Type":"application/json","X-API-Key":this.config.apiKey},body:JSON.stringify({session_id:s,events:t.map(e=>({event_type:e.type,data:e.data,timestamp:e.timestamp,session_id:e.sessionId}))})});if(!i.ok)throw new Error(`Upload failed: ${i.status}`)}async uploadNetworkEvents(e,t){const s=t.map(t=>fetch(`${e}/api/capture/network-event`,{method:"POST",headers:{"Content-Type":"application/json","X-API-Key":this.config.apiKey},body:JSON.stringify({session_id:t.sessionId,events:[{method:t.method,url:t.url,status_code:t.statusCode,response_time:t.responseTime,timestamp:t.timestamp,session_id:t.sessionId,request_data:{headers:t.requestHeaders||{},body:t.requestBody||null,size:t.requestSize||0},response_data:{headers:t.responseHeaders||{},body:t.responseBody||null,size:t.responseSize||0}}]})})),i=(await Promise.allSettled(s)).filter(e=>"rejected"===e.status);if(i.length>0)throw new Error(`${i.length} network event uploads failed`)}async uploadErrorsWithRetry(e,t){return this.executeWithRetry("errors",()=>this.uploadErrors(e,t))}async uploadSessionEventsWithRetry(e,t){return this.executeWithRetry("session_events",()=>this.uploadSessionEvents(e,t))}async uploadNetworkEventsWithRetry(e,t){return this.executeWithRetry("network_events",()=>this.uploadNetworkEvents(e,t))}async executeWithRetry(e,t){const s=this.retryAttempts.get(e)||0;if(!this.networkManager.shouldRetry(s))throw new Error(`Max retry attempts exceeded for ${e}`);try{const s=await t();return this.retryAttempts.delete(e),s}catch(i){if(this.retryAttempts.set(e,s+1),this.networkManager.shouldRetry(s+1)){const i=this.networkManager.getRetryDelay(s+1);return console.log(`[Revi] Upload failed for ${e}, retrying in ${i}ms (attempt ${s+2})`),await new Promise(e=>setTimeout(e,i)),this.executeWithRetry(e,t)}throw console.error(`[Revi] Max retry attempts exceeded for ${e}:`,i),i}}async clearQueue(){this.uploadQueue={errors:[],sessionEvents:[],networkEvents:[]},await this.storageManager.clearAll()}destroy(){this.uploadTimer&&(clearTimeout(this.uploadTimer),this.uploadTimer=null),this.hasQueuedData()&&this.uploadDataSync()}}class y{constructor(e){this.journeyEvents=[],this.isTracking=!1,this.config=e,this.deviceFingerprint=this.generateDeviceFingerprint(),this.sessionStartTime=Date.now(),this.currentPageStartTime=Date.now(),"undefined"!=typeof window&&this.setupJourneyTracking()}startTracking(e){this.userId=e,this.isTracking=!0,this.trackPageView(),this.config.debug&&console.log("Revi: User journey tracking started",{userId:e,deviceFingerprint:this.deviceFingerprint})}stopTracking(){this.isTracking=!1,this.flush()}setUserId(e){this.userId=e}trackPageView(){if(!this.isTracking)return;const e={event_type:"page_view",url:window.location.href,referrer:document.referrer||void 0,timestamp:Date.now(),metadata:{title:document.title,viewport:{width:window.innerWidth,height:window.innerHeight},scroll_position:{x:window.scrollX,y:window.scrollY},device_fingerprint:this.deviceFingerprint,user_agent:navigator.userAgent,language:navigator.language,timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,connection_type:this.getConnectionType()}};this.addJourneyEvent(e)}trackClick(e,t){if(!this.isTracking)return;const s={event_type:"click",url:window.location.href,timestamp:Date.now(),metadata:{element:{tag:e.tagName.toLowerCase(),id:e.id,class:e.className,text:this.getElementText(e),attributes:this.getRelevantAttributes(e)},coordinates:{x:t.clientX,y:t.clientY,page_x:t.pageX,page_y:t.pageY},viewport:{width:window.innerWidth,height:window.innerHeight},scroll_position:{x:window.scrollX,y:window.scrollY}}};this.addJourneyEvent(s)}trackFormSubmit(e){var t;if(!this.isTracking)return;const s=new FormData(e),i={};s.forEach((t,s)=>{const n=e.querySelector(`[name="${s}"]`);i[s]={type:(null==n?void 0:n.type)||"unknown",has_value:!!t,value_length:"string"==typeof t?t.length:0}});const n={event_type:"form_submit",url:window.location.href,timestamp:Date.now(),metadata:{form:{id:e.id,class:e.className,method:e.method,action:e.action,field_count:s.entries().length},fields:(null===(t=this.config.privacy)||void 0===t?void 0:t.maskInputs)?{}:i}};this.addJourneyEvent(n)}trackApiCall(e,t,s,i,n){if(!this.isTracking)return;const r={event_type:"api_call",url:window.location.href,timestamp:Date.now(),duration_ms:i,metadata:{api:{url:e,method:t,status:s,duration:i,size:n||0,success:s>=200&&s<300},page_context:{title:document.title,time_on_page:Date.now()-this.currentPageStartTime}}};this.addJourneyEvent(r)}trackError(e,t){var s;if(!this.isTracking)return;const i={event_type:"error",url:window.location.href,timestamp:Date.now(),metadata:{error:{message:e.message,name:e.name,stack:null===(s=e.stack)||void 0===s?void 0:s.split("\n").slice(0,5).join("\n")},user_context:{time_on_page:Date.now()-this.currentPageStartTime,session_duration:Date.now()-this.sessionStartTime,page_interactions:this.countPageInteractions()},custom_context:t||{}}};this.addJourneyEvent(i)}setupJourneyTracking(){let e=window.location.href;const t=()=>{if(window.location.href!==e){const t=Date.now()-this.currentPageStartTime;this.updateLastPageViewDuration(t),e=window.location.href,this.currentPageStartTime=Date.now(),this.trackPageView()}};window.addEventListener("popstate",t);const s=history.pushState,i=history.replaceState;history.pushState=function(...e){s.apply(history,e),setTimeout(t,0)},history.replaceState=function(...e){i.apply(history,e),setTimeout(t,0)},document.addEventListener("click",e=>{const t=e.target;t&&this.shouldTrackClick(t)&&this.trackClick(t,e)},{capture:!0,passive:!0}),document.addEventListener("submit",e=>{const t=e.target;t&&"FORM"===t.tagName&&this.trackFormSubmit(t)},{capture:!0,passive:!0}),window.addEventListener("beforeunload",()=>{const e=Date.now()-this.currentPageStartTime;this.updateLastPageViewDuration(e),this.flush()}),setInterval(()=>{this.journeyEvents.length>0&&this.flush()},3e4)}generateDeviceFingerprint(){if("undefined"==typeof window)return"server";const e=[navigator.userAgent,navigator.language,screen.width+"x"+screen.height,screen.colorDepth,Intl.DateTimeFormat().resolvedOptions().timeZone,navigator.platform,navigator.cookieEnabled,void 0!==window.localStorage,void 0!==window.sessionStorage];try{const t=document.createElement("canvas"),s=t.getContext("2d");s&&(s.textBaseline="top",s.font="14px Arial",s.fillText("Device fingerprint",2,2),e.push(t.toDataURL()))}catch(e){}const t=e.join("|");let s=0;for(let e=0;e<t.length;e++)s=(s<<5)-s+t.charCodeAt(e),s&=s;return Math.abs(s).toString(36)}addJourneyEvent(e){this.journeyEvents.push(e),this.journeyEvents.length>=50&&this.flush()}flush(){if(0===this.journeyEvents.length)return;const e=[...this.journeyEvents];this.journeyEvents=[],this.sendJourneyEvents(e).catch(t=>{this.config.debug&&console.error("Revi: Failed to send journey events",t),this.journeyEvents.unshift(...e)})}async sendJourneyEvents(e){const t=this.config.apiUrl||"https://api.revi.dev",s=e.map(e=>fetch(`${t}/api/analytics/user-event`,{method:"POST",headers:{"Content-Type":"application/json","X-API-Key":this.config.apiKey},body:JSON.stringify({user_id:this.userId,session_id:this.getSessionId(),...e})}));await Promise.allSettled(s)}shouldTrackClick(e){const t=e.tagName.toLowerCase();return(!["input","textarea"].includes(t)||!["password","hidden"].includes(e.type))&&!e.hasAttribute("data-revi-ignore")}getElementText(e){return(e.textContent||e.innerText||"").trim().substring(0,100)}getRelevantAttributes(e){const t={};return["href","src","alt","title","data-testid","role"].forEach(s=>{const i=e.getAttribute(s);i&&(t[s]=i)}),t}getConnectionType(){if("connection"in navigator){const e=navigator.connection;return(null==e?void 0:e.effectiveType)||(null==e?void 0:e.type)||"unknown"}return"unknown"}countPageInteractions(){return this.journeyEvents.filter(e=>["click","form_submit"].includes(e.event_type)).length}updateLastPageViewDuration(e){if(this.journeyEvents.length>0){const t=this.journeyEvents[this.journeyEvents.length-1];"page_view"===t.event_type&&(t.duration_ms=e)}}getSessionId(){return"session-"+Date.now()}}class w{constructor(e){this.nodeIdMap=new WeakMap,this.nodeMap=new Map,this.nextNodeId=1,this.isObserving=!1,this.config=e}takeSnapshot(){const e={timestamp:Date.now(),url:window.location.href,viewport:{width:window.innerWidth,height:window.innerHeight},scroll:{x:window.scrollX,y:window.scrollY},nodes:[],stylesheets:[],resources:[]};return e.nodes=this.serializeDocument(document),e.stylesheets=this.serializeStylesheets(),e.resources=this.serializeResources(),e}startObserving(e){this.isObserving||(this.onDOMChange=e,this.observer=new MutationObserver(this.handleMutations.bind(this)),this.observer.observe(document,{childList:!0,attributes:!0,characterData:!0,subtree:!0,attributeOldValue:!0,characterDataOldValue:!0}),this.isObserving=!0)}stopObserving(){this.observer&&(this.observer.disconnect(),this.observer=void 0),this.isObserving=!1,this.onDOMChange=void 0}serializeDocument(e){const t=e.doctype,s=[];if(t&&s.push({type:"document",tagName:"DOCTYPE",attributes:{name:t.name,publicId:t.publicId,systemId:t.systemId},id:this.getNodeId(t)}),e.documentElement){const t=this.serializeNode(e.documentElement);t&&s.push(t)}return s}serializeNode(e){if(this.shouldIgnoreNode(e))return null;const t=this.getNodeId(e),s={type:this.getNodeType(e),id:t};switch(e.nodeType){case Node.ELEMENT_NODE:const t=e;s.tagName=t.tagName.toLowerCase(),s.attributes=this.serializeAttributes(t),s.children=this.serializeChildren(t);break;case Node.TEXT_NODE:const i=e;s.textContent=this.shouldMaskText(i)?"[Masked]":i.textContent||"";break;case Node.COMMENT_NODE:const n=e;s.textContent=n.textContent||"";break;default:return null}return s}serializeAttributes(e){const t={};for(let s=0;s<e.attributes.length;s++){const i=e.attributes[s],n=i.name.toLowerCase();this.shouldIgnoreAttribute(n,i.value)||(this.shouldMaskAttribute(n,e)?t[n]="[Masked]":t[n]=i.value)}return t}serializeChildren(e){const t=[];for(let s=0;s<e.childNodes.length;s++){const i=e.childNodes[s],n=this.serializeNode(i);n&&t.push(n)}return t}serializeStylesheets(){const e=[];for(let t=0;t<document.styleSheets.length;t++){const s=document.styleSheets[t];try{let t="";s.href?t=`/* External stylesheet: ${s.href} */`:s.cssRules&&(t=Array.from(s.cssRules).map(e=>e.cssText).join("\n")),e.push({href:s.href||void 0,cssText:t,disabled:s.disabled})}catch(t){s.href&&e.push({href:s.href,cssText:`/* Could not access stylesheet: ${s.href} */`,disabled:s.disabled})}}return e}serializeResources(){const e=[];return document.querySelectorAll("img").forEach(t=>{t.src&&!this.shouldIgnoreResource(t.src)&&e.push({url:t.src,type:"image",failed:!t.complete||0===t.naturalWidth})}),document.querySelectorAll("*").forEach(t=>{const s=window.getComputedStyle(t).backgroundImage;if(s&&"none"!==s){const t=s.match(/url\(['"]?([^'")]+)['"]?\)/);t&&t[1]&&!this.shouldIgnoreResource(t[1])&&e.push({url:t[1],type:"image"})}}),e}handleMutations(e){e.forEach(e=>{const t=this.nodeIdMap.get(e.target);if(!t)return;const s={timestamp:Date.now(),type:e.type,target:t};switch(e.type){case"childList":e.addedNodes.length>0&&(s.addedNodes=Array.from(e.addedNodes).map(e=>this.serializeNode(e)).filter(e=>null!==e)),e.removedNodes.length>0&&(s.removedNodes=Array.from(e.removedNodes).map(e=>this.nodeIdMap.get(e)).filter(e=>void 0!==e));break;case"attributes":if(s.attributeName=e.attributeName||void 0,e.target.nodeType===Node.ELEMENT_NODE){const t=e.target,i=t.getAttribute(e.attributeName||"");s.attributeValue=this.shouldMaskAttribute(e.attributeName||"",t)?"[Masked]":i||""}s.oldValue=e.oldValue||void 0;break;case"characterData":s.attributeValue=this.shouldMaskText(e.target)?"[Masked]":e.target.textContent||"",s.oldValue=e.oldValue||void 0}this.onDOMChange&&this.onDOMChange(s)})}getNodeId(e){if(this.nodeIdMap.has(e))return this.nodeIdMap.get(e);const t=this.nextNodeId++;return this.nodeIdMap.set(e,t),this.nodeMap.set(t,e),t}getNodeType(e){switch(e.nodeType){case Node.ELEMENT_NODE:return"element";case Node.TEXT_NODE:return"text";case Node.COMMENT_NODE:return"comment";case Node.DOCUMENT_NODE:return"document";default:return"element"}}shouldIgnoreNode(e){var t;if(e.nodeType===Node.ELEMENT_NODE){const s=e,i=s.tagName.toLowerCase();if(["script","noscript","meta"].includes(i))return!0;if(s.hasAttribute("data-revi-ignore"))return!0;if(null===(t=this.config.replay)||void 0===t?void 0:t.blockSelector)try{if(s.matches(this.config.replay.blockSelector))return!0}catch(e){}}return!1}shouldIgnoreAttribute(e,t){return["data-revi-ignore","data-password","data-sensitive"].includes(e)}shouldMaskAttribute(e,t){var s;return!!(null===(s=this.config.privacy)||void 0===s?void 0:s.maskInputs)&&(!("input"!==t.tagName.toLowerCase()||!["password","email","tel"].includes(t.type))&&"value"===e)}shouldMaskText(e){var t,s,i,n;if(!(null===(t=this.config.replay)||void 0===t?void 0:t.maskAllText)&&!(null===(s=this.config.privacy)||void 0===s?void 0:s.maskInputs))return!1;const r=e.parentElement;if(!r)return!1;if(["input","textarea"].includes(r.tagName.toLowerCase()))return!0;if(null===(i=this.config.replay)||void 0===i?void 0:i.maskSelector)try{return r.matches(this.config.replay.maskSelector)}catch(e){return!1}return(null===(n=this.config.replay)||void 0===n?void 0:n.maskAllText)||!1}shouldIgnoreResource(e){try{const t=new URL(e,window.location.href);if("data:"===t.protocol)return!0;if(e.includes("?")){const e=new URLSearchParams(t.search),s=e.get("w")||e.get("width"),i=e.get("h")||e.get("height");if(s&&parseInt(s)>2e3)return!0;if(i&&parseInt(i)>2e3)return!0}return!1}catch(e){return!0}}}class E{constructor(e,t={}){this.originalMethods={},this.entries=[],this.isRecording=!1,this.sessionId=e,this.config={maxEntries:1e3,captureStackTrace:!0,serializeObjects:!0,maxObjectDepth:3,maxStringLength:1e4,ignoredLevels:[],...t}}start(){this.isRecording||(["log","info","warn","error","debug","trace"].forEach(e=>{if(this.config.ignoredLevels.includes(e))return;const t=console[e];this.originalMethods[e]=t,console[e]=(...s)=>{t.apply(console,s),this.recordEntry(e,s)}}),this.isRecording=!0)}stop(){this.isRecording&&(Object.entries(this.originalMethods).forEach(([e,t])=>{console[e]=t}),this.originalMethods={},this.isRecording=!1)}recordEntry(e,t){var s,i;try{const i={id:this.generateId(),timestamp:Date.now(),level:e,args:this.serializeArgs(t)};if(("error"===e||"warn"===e)&&this.config.captureStackTrace){const e=new Error;e.stack&&(i.stack=this.cleanStackTrace(e.stack))}if("error"===e&&t[0]instanceof Error){const e=((null===(s=t[0].stack)||void 0===s?void 0:s.split("\n"))||[]).find(e=>e.includes(".js:")||e.includes(".ts:")||e.includes(".tsx:"));if(e){const t=e.match(/([^/]+):(\d+):(\d+)/);t&&(i.url=t[1],i.lineNumber=parseInt(t[2]),i.columnNumber=parseInt(t[3]))}}this.addEntry(i)}catch(e){null===(i=this.originalMethods.warn)||void 0===i||i.call(console,"ConsoleRecorder error:",e)}}serializeArgs(e){return e.map(e=>this.serializeValue(e,0))}serializeValue(e,t){if(t>this.config.maxObjectDepth)return"[Object too deep]";if(null==e)return e;if("string"==typeof e)return e.length>this.config.maxStringLength?e.substring(0,this.config.maxStringLength)+"...":e;if("number"==typeof e||"boolean"==typeof e)return e;if("function"==typeof e)return`[Function: ${e.name||"anonymous"}]`;if(e instanceof Error)return{name:e.name,message:e.message,stack:this.config.captureStackTrace?this.cleanStackTrace(e.stack||""):void 0};if(e instanceof Date)return{__type:"Date",value:e.toISOString()};if(e instanceof RegExp)return{__type:"RegExp",value:e.toString()};if(Array.isArray(e))return this.config.serializeObjects?e.slice(0,100).map(e=>this.serializeValue(e,t+1)):"[Array]";if("object"==typeof e){if(!this.config.serializeObjects)return"[Object]";try{const s={},i=Object.keys(e).slice(0,50);for(const n of i)try{s[n]=this.serializeValue(e[n],t+1)}catch(e){s[n]="[Unserializable]"}return Object.keys(e).length>50&&(s["..."]=`[${Object.keys(e).length-50} more keys]`),s}catch(e){return"[Unserializable Object]"}}return String(e)}cleanStackTrace(e){return e.split("\n").filter(e=>!e.includes("console-recorder.ts")&&!e.includes("ConsoleRecorder")).slice(0,10).join("\n")}addEntry(e){this.entries.push(e),this.entries.length>this.config.maxEntries&&(this.entries=this.entries.slice(.8*-this.config.maxEntries))}generateId(){return`console-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}getEntries(e,t){let s=this.entries;return e&&(s=s.filter(t=>t.timestamp>=e)),t&&(s=s.filter(e=>e.timestamp<=t)),[...s]}getEntriesByLevel(e){return this.entries.filter(t=>t.level===e)}clear(){this.entries=[]}toSessionEvents(){return this.entries.map(e=>({session_id:this.sessionId,event_type:"console",data:{level:e.level,args:e.args,stack:e.stack,url:e.url,lineNumber:e.lineNumber,columnNumber:e.columnNumber,consoleId:e.id},timestamp:e.timestamp,url:e.url||window.location.href,user_agent:navigator.userAgent}))}exportData(){const e={};let t=1/0,s=-1/0;return this.entries.forEach(i=>{e[i.level]=(e[i.level]||0)+1,t=Math.min(t,i.timestamp),s=Math.max(s,i.timestamp)}),{sessionId:this.sessionId,config:this.config,entries:[...this.entries],stats:{totalEntries:this.entries.length,levelCounts:e,errorCount:e.error||0,warningCount:e.warn||0,timeRange:{start:t===1/0?0:t,end:s===-1/0?0:s}}}}generateInsights(){return{errorPatterns:this.findErrorPatterns(),performanceIssues:this.detectPerformanceIssues(),recommendations:this.generateRecommendations()}}findErrorPatterns(){const e=this.entries.filter(e=>"error"===e.level),t={};return e.forEach(e=>{let s="Unknown Error";if(e.args.length>0){const t=e.args[0];"string"==typeof t?s=t.replace(/\d+/g,"N").replace(/["'][^"']*["']/g,"STRING").replace(/\b\w+@\w+\.\w+/g,"EMAIL").replace(/https?:\/\/[^\s]+/g,"URL").substring(0,100):"object"==typeof t&&t.name&&(s=`${t.name}: ${t.message}`.substring(0,100))}t[s]||(t[s]=[]),t[s].push(e)}),Object.entries(t).sort(([,e],[,t])=>t.length-e.length).slice(0,10).map(([e,t])=>({pattern:e,count:t.length,examples:t.slice(0,3)}))}detectPerformanceIssues(){const e=[],t=this.entries.filter(e=>e.timestamp>Date.now()-6e4);t.length>100&&e.push({type:"Excessive Logging",severity:"medium",details:`${t.length} console entries in the last minute may impact performance`});const s={};return this.entries.filter(e=>"error"===e.level).forEach(e=>{const t=JSON.stringify(e.args);s[t]=(s[t]||0)+1}),Object.entries(s).forEach(([t,s])=>{s>10&&e.push({type:"Repeated Error",severity:s>50?"high":"medium",details:`Same error occurred ${s} times`})}),this.entries.filter(e=>e.args.some(e=>"object"==typeof e&&null!==e&&!Array.isArray(e))).length>.5*this.entries.length&&e.push({type:"Object Logging",severity:"low",details:"High percentage of object logging may indicate memory leaks"}),e}generateRecommendations(){const e=[],t=this.exportData().stats;return t.errorCount>0&&e.push(`Found ${t.errorCount} console errors. Review error patterns and fix underlying issues.`),t.warningCount>2*t.errorCount&&e.push("High warning-to-error ratio suggests proactive error handling could prevent issues."),t.totalEntries>500&&e.push("Consider reducing console logging in production to improve performance."),t.levelCounts.debug&&t.levelCounts.debug>100&&e.push("Debug logs should be disabled in production environments."),0===e.length&&e.push("Console logging patterns look healthy."),e}}class b{constructor(e,t={}){this.data=[],this.config={radius:20,maxIntensity:100,gradient:{.4:"blue",.6:"cyan",.7:"lime",.8:"yellow",1:"red"},blur:15,minOpacity:0,maxOpacity:.6,...t},this.canvas=document.createElement("canvas"),this.canvas.style.position="absolute",this.canvas.style.top="0",this.canvas.style.left="0",this.canvas.style.pointerEvents="none",this.canvas.style.zIndex="9999",e.appendChild(this.canvas);const s=this.canvas.getContext("2d");if(!s)throw new Error("Failed to get canvas context");this.ctx=s,this.resizeCanvas(),window.addEventListener("resize",()=>this.resizeCanvas())}resizeCanvas(){const e=this.canvas.parentElement.getBoundingClientRect();this.canvas.width=e.width,this.canvas.height=e.height,this.canvas.style.width=e.width+"px",this.canvas.style.height=e.height+"px"}addDataPoint(e,t,s,i){this.data.push({x:e,y:t,intensity:s,event_type:i,timestamp:Date.now()}),this.data.length>1e4&&(this.data=this.data.slice(-8e3))}generateFromEvents(e){this.data=[],e.forEach(e=>{var t,s,i,n,r,a;"click"===e.event_type&&(null===(t=e.data)||void 0===t?void 0:t.x)&&(null===(s=e.data)||void 0===s?void 0:s.y)?this.addDataPoint(e.data.x,e.data.y,10,"click"):"mousemove"===e.event_type&&(null===(i=e.data)||void 0===i?void 0:i.x)&&(null===(n=e.data)||void 0===n?void 0:n.y)?this.addDataPoint(e.data.x,e.data.y,2,"move"):"scroll"===e.event_type&&void 0!==(null===(r=e.data)||void 0===r?void 0:r.scrollX)&&void 0!==(null===(a=e.data)||void 0===a?void 0:a.scrollY)&&this.addDataPoint(e.data.scrollX||0,e.data.scrollY||0,5,"scroll")})}render(e){if(this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),0===this.data.length)return;const t=e?this.data.filter(t=>e.includes(t.event_type)):this.data,s=this.createIntensityMap(t),i=this.createGradient();this.renderHeatmap(s,i)}createIntensityMap(e){const t=document.createElement("canvas");t.width=this.canvas.width,t.height=this.canvas.height;const s=t.getContext("2d");return e.forEach(e=>{const t=this.config.radius,i=s.createRadialGradient(e.x,e.y,0,e.x,e.y,t),n=Math.min(e.intensity/this.config.maxIntensity,1);i.addColorStop(0,`rgba(0, 0, 0, ${n})`),i.addColorStop(1,"rgba(0, 0, 0, 0)"),s.fillStyle=i,s.fillRect(e.x-t,e.y-t,2*t,2*t)}),s.filter=`blur(${this.config.blur}px)`,s.drawImage(t,0,0),s.getImageData(0,0,t.width,t.height)}createGradient(){const e=document.createElement("canvas");e.width=256,e.height=1;const t=e.getContext("2d"),s=t.createLinearGradient(0,0,256,0);return Object.entries(this.config.gradient).forEach(([e,t])=>{s.addColorStop(parseFloat(e),t)}),t.fillStyle=s,t.fillRect(0,0,256,1),t.getImageData(0,0,256,1)}renderHeatmap(e,t){const s=this.ctx.createImageData(e.width,e.height);for(let i=0;i<e.data.length;i+=4){const n=e.data[i+3];if(n>0){const e=4*Math.floor(n/255*255);s.data[i]=t.data[e],s.data[i+1]=t.data[e+1],s.data[i+2]=t.data[e+2],s.data[i+3]=Math.floor(n*this.config.maxOpacity)}}this.ctx.putImageData(s,0,0)}clear(){this.data=[],this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)}destroy(){this.clear(),this.canvas.parentElement&&this.canvas.parentElement.removeChild(this.canvas),window.removeEventListener("resize",()=>this.resizeCanvas())}exportData(){const e={};let t=1/0,s=-1/0,i=1/0,n=-1/0,r=1/0,a=-1/0;return this.data.forEach(o=>{e[o.event_type]=(e[o.event_type]||0)+1,t=Math.min(t,o.x),s=Math.max(s,o.x),i=Math.min(i,o.y),n=Math.max(n,o.y),r=Math.min(r,o.timestamp),a=Math.max(a,o.timestamp)}),{config:this.config,data:[...this.data],stats:{totalEvents:this.data.length,eventTypes:e,timeRange:{start:r,end:a},bounds:{minX:t,maxX:s,minY:i,maxY:n}}}}generateInsights(){return{hotSpots:this.findHotSpots(),clickPatterns:this.analyzeClickPatterns(),userBehavior:this.analyzeUserBehavior()}}findHotSpots(){const e=[],t=2*this.config.radius;return this.data.forEach(s=>{let i=!1;for(const n of e)if(Math.sqrt(Math.pow(s.x-n.x,2)+Math.pow(s.y-n.y,2))<=t){n.x=(n.x*n.count+s.x)/(n.count+1),n.y=(n.y*n.count+s.y)/(n.count+1),n.intensity+=s.intensity,n.count++,i=!0;break}i||e.push({x:s.x,y:s.y,intensity:s.intensity,count:1})}),e.filter(e=>e.count>=3).sort((e,t)=>t.intensity-e.intensity).slice(0,10).map(e=>({x:Math.round(e.x),y:Math.round(e.y),intensity:Math.round(e.intensity),radius:Math.min(t,5*e.count)}))}analyzeClickPatterns(){const e=this.data.filter(e=>"click"===e.event_type),t={};for(let s=0;s<e.length-1;s++){const i=e[s],n=e[s+1];if(n.timestamp-i.timestamp<5e3){const e=`(${Math.round(i.x)},${Math.round(i.y)}) -> (${Math.round(n.x)},${Math.round(n.y)})`;t[e]=(t[e]||0)+1}}return Object.entries(t).sort(([,e],[,t])=>t-e).slice(0,5).map(([e,t])=>({pattern:e,frequency:t}))}analyzeUserBehavior(){const e=this.data.filter(e=>"click"===e.event_type),t=this.data.filter(e=>"scroll"===e.event_type),s=[...this.data].sort((e,t)=>t.intensity-e.intensity),i=s.slice(0,Math.floor(.5*s.length)),n=Math.min(...i.map(e=>e.x)),r=Math.max(...i.map(e=>e.x)),a=Math.min(...i.map(e=>e.y)),o=Math.max(...i.map(e=>e.y)),c=t.length>0?Math.max(...t.map(e=>e.y))/this.canvas.height:0,d=Math.min(100,2*e.length+50*c+.1*this.data.filter(e=>"move"===e.event_type).length);return{mostActiveArea:{x:Math.round(n),y:Math.round(a),width:Math.round(r-n),height:Math.round(o-a)},averageClicksPerSession:Math.round(e.length),scrollDepth:Math.round(100*c)/100,engagementScore:Math.round(d)}}}class S{constructor(e,t){var s,i,n,r,a,o,c,d,l,h,u,p,g,m,v,f,y;if(this.heatmapGenerator=null,this.events=[],this.consoleLogs=[],this.networkRequests=new Map,this.isRecording=!1,this.originalConsole={},this.config=e,this.sessionId=t,this.startTime=Date.now(),this.domSerializer=new w(e),this.consoleRecorder=new E(t,{maxEntries:(null===(s=e.replay)||void 0===s?void 0:s.maxConsoleEntries)||1e3,captureStackTrace:!1!==(null===(i=e.replay)||void 0===i?void 0:i.captureStackTrace),serializeObjects:!1!==(null===(n=e.replay)||void 0===n?void 0:n.serializeObjects),maxObjectDepth:(null===(r=e.replay)||void 0===r?void 0:r.maxObjectDepth)||3,maxStringLength:(null===(a=e.replay)||void 0===a?void 0:a.maxStringLength)||1e4,ignoredLevels:(null===(o=e.replay)||void 0===o?void 0:o.ignoredConsoleLevels)||[]}),(null===(c=this.config.replay)||void 0===c?void 0:c.enabled)&&(this.setupReplay(),(null===(l=null===(d=this.config.replay)||void 0===d?void 0:d.heatmaps)||void 0===l?void 0:l.enabled)&&"undefined"!=typeof document)){const t=document.body||document.documentElement;t&&(this.heatmapGenerator=new b(t,{radius:(null===(u=null===(h=e.replay)||void 0===h?void 0:h.heatmaps)||void 0===u?void 0:u.radius)||20,maxIntensity:(null===(g=null===(p=e.replay)||void 0===p?void 0:p.heatmaps)||void 0===g?void 0:g.maxIntensity)||100,blur:(null===(v=null===(m=e.replay)||void 0===m?void 0:m.heatmaps)||void 0===v?void 0:v.blur)||15,maxOpacity:(null===(y=null===(f=e.replay)||void 0===f?void 0:f.heatmaps)||void 0===y?void 0:y.maxOpacity)||.6}))}}startRecording(){var e;!this.isRecording&&(null===(e=this.config.replay)||void 0===e?void 0:e.enabled)&&(this.isRecording=!0,this.takeFullSnapshot(),this.domSerializer.startObserving(this.handleDOMChange.bind(this)),this.consoleRecorder.start(),this.setupNetworkCapture(),this.setupInteractionTracking(),setInterval(()=>{this.isRecording&&this.takeFullSnapshot()},6e4),this.config.debug&&console.log("Revi: Session replay started"))}stopRecording(){this.isRecording&&(this.isRecording=!1,this.domSerializer.stopObserving(),this.consoleRecorder.stop(),this.restoreOriginalNetwork(),this.heatmapGenerator&&(this.heatmapGenerator.destroy(),this.heatmapGenerator=null),this.config.debug&&console.log("Revi: Session replay stopped"))}getReplayData(){const e=this.consoleRecorder.getEntries(),t=this.consoleRecorder.generateInsights();let s,i;return this.heatmapGenerator&&(s=this.heatmapGenerator.exportData().data,i=this.heatmapGenerator.generateInsights()),{events:[...this.events],console_logs:e,network_requests:Array.from(this.networkRequests.values()),heatmap_data:s,session_info:{session_id:this.sessionId,start_time:this.startTime,duration:Date.now()-this.startTime,page_url:window.location.href},analytics:{console_insights:t,heatmap_insights:i}}}clearReplayData(){this.events=[],this.consoleLogs=[],this.networkRequests.clear(),this.consoleRecorder.clear(),this.heatmapGenerator&&this.heatmapGenerator.clear()}setupReplay(){if("undefined"==typeof window)return;let e;document.addEventListener("visibilitychange",()=>{this.addCustomEvent("visibility_change",{hidden:document.hidden})}),window.addEventListener("focus",()=>{this.addCustomEvent("window_focus",{})}),window.addEventListener("blur",()=>{this.addCustomEvent("window_blur",{})}),window.addEventListener("resize",()=>{this.addCustomEvent("viewport_change",{width:window.innerWidth,height:window.innerHeight})}),window.addEventListener("scroll",()=>{clearTimeout(e),e=setTimeout(()=>{this.heatmapGenerator&&this.heatmapGenerator.addDataPoint(window.scrollX||0,window.scrollY||0,5,"scroll"),this.addCustomEvent("scroll",{x:window.scrollX,y:window.scrollY})},100)},{passive:!0})}takeFullSnapshot(){if(this.isRecording)try{const e=this.domSerializer.takeSnapshot();this.addEvent({type:"full_snapshot",timestamp:Date.now(),data:e})}catch(e){this.config.debug&&console.error("Revi: Failed to take DOM snapshot",e)}}handleDOMChange(e){this.isRecording&&this.addEvent({type:"incremental_snapshot",timestamp:e.timestamp,data:{source:"mutation",...e}})}renderHeatmap(e){this.heatmapGenerator&&this.heatmapGenerator.render(e)}toggleHeatmap(e){this.heatmapGenerator&&(e?this.heatmapGenerator.render():this.heatmapGenerator.clear())}getHeatmapInsights(){var e;return(null===(e=this.heatmapGenerator)||void 0===e?void 0:e.generateInsights())||null}setupNetworkCapture(){if(void 0!==window.fetch&&(this.originalFetch=window.fetch,window.fetch=async(e,t)=>{const s=Date.now(),i=this.generateRequestId(),n=e instanceof Request?e.url:e.toString(),r=(null==t?void 0:t.method)||(e instanceof Request?e.method:"GET");this.isRecording&&this.networkRequests.set(i,{timestamp:s,id:i,method:r,url:n,requestHeaders:this.getRequestHeaders(t,e),requestBody:await this.serializeRequestBody(t,e)});try{const n=await this.originalFetch(e,t),r=Date.now()-s;if(this.isRecording){const t=this.networkRequests.get(i);if(t&&(t.status=n.status,t.duration=r,t.responseHeaders=this.getResponseHeaders(n),this.shouldCaptureResponseBody(n)))try{const e=n.clone();t.responseBody=await e.text()}catch(e){}}return n}catch(e){const t=Date.now()-s;if(this.isRecording){const e=this.networkRequests.get(i);e&&(e.duration=t,e.failed=!0)}throw e}}),"undefined"!=typeof XMLHttpRequest){this.originalXMLHttpRequest=XMLHttpRequest;const e=this;window.XMLHttpRequest=function(){const t=new e.originalXMLHttpRequest,s=e.generateRequestId();let i="GET",n="",r=0;const a=t.open,o=t.send;return t.open=function(e,t,...s){return i=e,n=t.toString(),a.call(this,e,t,...s)},t.send=function(t){return r=Date.now(),e.isRecording&&e.networkRequests.set(s,{timestamp:r,id:s,method:i,url:n,requestBody:t}),o.call(this,t)},t.addEventListener("loadend",()=>{const i=Date.now()-r;if(e.isRecording){const n=e.networkRequests.get(s);n&&(n.status=t.status,n.duration=i,n.failed=0===t.status||t.status>=400,e.shouldCaptureXHRResponse(t)&&(n.responseBody=t.responseText))}}),t}}}setupInteractionTracking(){["mousedown","mouseup","click","dblclick","mousemove"].forEach(e=>{document.addEventListener(e,t=>{if(this.isRecording&&!("mousemove"===e&&Math.random()>.1)){if(this.heatmapGenerator){let s=1;"click"===e?s=10:"mousemove"===e?s=2:"mousedown"===e&&(s=5),this.heatmapGenerator.addDataPoint(t.clientX,t.clientY,s,"click"===e?"click":"move")}this.addEvent({type:"incremental_snapshot",timestamp:Date.now(),data:{source:"mouse",type:e,x:t.clientX,y:t.clientY,id:this.getElementId(t.target)}})}},{capture:!0,passive:!0})}),document.addEventListener("keydown",e=>{this.isRecording&&(this.shouldIgnoreKeystroke(e)||this.addEvent({type:"incremental_snapshot",timestamp:Date.now(),data:{source:"keyboard",type:"keydown",key:this.sanitizeKey(e.key),code:e.code,id:this.getElementId(e.target)}}))},{capture:!0,passive:!0})}addEvent(e){this.events.push(e),this.events.length>1e4&&(this.events=this.events.slice(-8e3))}addCustomEvent(e,t){this.addEvent({type:"custom",timestamp:Date.now(),data:{type:e,...t}})}serializeConsoleArgs(e){return e.map(e=>{try{return"object"==typeof e&&null!==e?JSON.parse(JSON.stringify(e)):e}catch(e){return"[Unserializable Object]"}})}generateRequestId(){return Date.now().toString(36)+Math.random().toString(36).substr(2)}getRequestHeaders(e,t){const s={};return(null==e?void 0:e.headers)&&(e.headers instanceof Headers?e.headers.forEach((e,t)=>{s[t]=e}):Array.isArray(e.headers)?e.headers.forEach(([e,t])=>{s[e]=t}):Object.assign(s,e.headers)),t instanceof Request&&t.headers.forEach((e,t)=>{s[t]=e}),s}getResponseHeaders(e){const t={};return e.headers.forEach((e,s)=>{t[s]=e}),t}async serializeRequestBody(e,t){let s=null==e?void 0:e.body;if(t instanceof Request&&!s)try{s=await t.clone().text()}catch(e){return null}if(!s)return null;if("string"==typeof s)return s.length>1e4?s.substring(0,1e4)+"...[truncated]":s;if(s instanceof FormData){const e={};return s.forEach((t,s)=>{e[s]=t instanceof File?`[File: ${t.name}]`:t}),e}return"[Binary Data]"}shouldCaptureResponseBody(e){const t=e.headers.get("content-type")||"",s=parseInt(e.headers.get("content-length")||"0");return t.includes("application/json")||t.includes("text/")||s>0&&s<1e5}shouldCaptureXHRResponse(e){const t=e.getResponseHeader("content-type")||"";return t.includes("application/json")||t.includes("text/")||e.responseText&&e.responseText.length<1e5}getElementId(e){return e?Math.random():void 0}shouldIgnoreKeystroke(e){const t=e.target;if(t&&t.tagName){const e=t.tagName.toLowerCase(),s=t.type;if("input"===e&&"password"===s)return!0;if(t.hasAttribute("data-revi-ignore"))return!0}return!1}sanitizeKey(e){return 1===e.length&&/[a-zA-Z0-9]/.test(e)?"*":e}restoreOriginalNetwork(){this.originalFetch&&(window.fetch=this.originalFetch),this.originalXMLHttpRequest&&(window.XMLHttpRequest=this.originalXMLHttpRequest)}}class I{constructor(e){if(this.isInitialized=!1,this.config={apiUrl:process.env.REVI_API_URL||"https://api.revi.dev",environment:"production",debug:!1,sampleRate:1,sessionSampleRate:1,maxBreadcrumbs:50,privacy:{maskInputs:!0,maskPasswords:!0,maskCreditCards:!0},performance:{captureWebVitals:!0,captureResourceTiming:!1,captureNavigationTiming:!0},replay:{enabled:!0,maskAllInputs:!1,maskAllText:!1},...e},!this.config.apiKey)throw new Error("Revi: API key is required");"undefined"!=typeof navigator&&[/bot/i,/spider/i,/crawl/i,/headless/i,/phantom/i,/selenium/i].some(e=>e.test(navigator.userAgent))?this.config.debug&&console.log("Revi: Bot detected, skipping initialization"):this.init()}init(){var e;if(!this.isInitialized)try{this.traceManager=new o,this.errorHandler=new c(this.config,this.traceManager),this.sessionManager=new d(this.config,this.traceManager),this.networkMonitor=new l(this.config,this.traceManager),this.performanceMonitor=new h(this.config),this.dataManager=new f(this.config),this.userJourneyTracker=new y(this.config),this.sessionReplayManager=new S(this.config,this.sessionManager.getSessionId()),this.setupPeriodicFlush(),(null===(e=this.config.replay)||void 0===e?void 0:e.enabled)&&this.sessionReplayManager.startRecording(),this.isInitialized=!0,this.config.debug&&console.log("Revi: Initialized successfully")}catch(e){this.config.debug&&console.error("Revi: Initialization failed",e)}}setupPeriodicFlush(){setInterval(()=>{this.flush()},1e4)}captureException(e,t={}){if(!this.isInitialized)return"";const s=this.errorHandler.captureException(e,t);if(s){const i={id:s,timestamp:Date.now(),message:e.message,stack:e.stack,url:window.location.href,userId:this.config.userId,sessionId:this.sessionManager.getSessionId(),userAgent:navigator.userAgent,environment:this.config.environment,release:this.config.release,tags:t.tags,extra:t.extra,breadcrumbs:this.errorHandler.getBreadcrumbs(),level:t.level||"error"};this.dataManager.queueError(i),this.userJourneyTracker&&this.userJourneyTracker.trackError(e,{level:t.level,tags:t.tags,extra:t.extra})}return s}captureMessage(e,t={}){if(!this.isInitialized)return"";const s=this.errorHandler.captureMessage(e,t);if(s){const i={id:s,timestamp:Date.now(),message:e,url:window.location.href,userId:this.config.userId,sessionId:this.sessionManager.getSessionId(),userAgent:navigator.userAgent,environment:this.config.environment,release:this.config.release,tags:t.tags,extra:t.extra,breadcrumbs:this.errorHandler.getBreadcrumbs(),level:t.level||"info"};this.dataManager.queueError(i)}return s}addBreadcrumb(e){this.isInitialized&&this.errorHandler.addBreadcrumb({timestamp:Date.now(),message:e.message,category:e.category||"manual",level:e.level||"info",data:e.data})}setUserContext(e){this.isInitialized&&(this.config.userId=e.id,this.errorHandler.setUserContext(e),this.userJourneyTracker.setUserId(e.id||""),this.userJourneyTracker.startTracking(e.id))}setTags(e){this.isInitialized&&this.errorHandler.setTags(e)}setExtra(e){this.isInitialized&&this.errorHandler.setExtra(e)}getSessionId(){return this.isInitialized?this.sessionManager.getSessionId():""}endSession(){this.isInitialized&&(this.flush(),this.sessionManager.endSession())}mark(e){this.isInitialized&&this.performanceMonitor.mark(e)}measure(e,t,s){return this.isInitialized?this.performanceMonitor.measure(e,t,s):null}getWebVitals(){return this.isInitialized?this.performanceMonitor.getWebVitals():{}}startSessionReplay(){this.isInitialized&&this.sessionReplayManager&&this.sessionReplayManager.startRecording()}stopSessionReplay(){this.isInitialized&&this.sessionReplayManager&&this.sessionReplayManager.stopRecording()}getSessionReplayData(){return this.isInitialized&&this.sessionReplayManager?this.sessionReplayManager.getReplayData():null}flush(){if(!this.isInitialized)return;const e=this.sessionManager.flush(),t=this.networkMonitor.flush();t.forEach(e=>{e.sessionId=this.sessionManager.getSessionId()}),e.length>0&&this.dataManager.queueSessionEvents(e),t.length>0&&this.dataManager.queueNetworkEvents(t)}getCurrentTraceId(){var e;return null===(e=this.traceManager)||void 0===e?void 0:e.getCurrentTraceId()}getCurrentSpanId(){var e;return null===(e=this.traceManager)||void 0===e?void 0:e.getCurrentSpanId()}getTraceContext(){var e;return(null===(e=this.traceManager)||void 0===e?void 0:e.getTraceContext())||{}}startSpan(e){var t;return null===(t=this.traceManager)||void 0===t?void 0:t.startSpan(e)}finishSpan(e,t){var s;null===(s=this.traceManager)||void 0===s||s.finishSpan(e,t)}destroy(){this.isInitialized&&(this.flush(),this.networkMonitor&&this.networkMonitor.destroy(),this.dataManager&&this.dataManager.destroy(),this.sessionReplayManager&&this.sessionReplayManager.stopRecording(),this.userJourneyTracker&&this.userJourneyTracker.stopTracking(),this.traceManager&&this.traceManager.cleanupSpanData(),this.isInitialized=!1)}}var k=Object.freeze({__proto__:null,Monitor:I,default:I}),x=i,R=n;export{x as ReviProvider,R as useRevi};
//# sourceMappingURL=index.esm.js.map
