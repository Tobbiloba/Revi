var t,e;t=this,e=function(t){function e(){return"xxxx-xxxx-4xxx-yxxx-xxxx".replace(/[xy]/g,function(t){const e=16*Math.random()|0;return("x"===t?e:3&e|8).toString(16)})}function s(t){return t.stack?t.stack.split("\n").map(t=>t.trim()).filter(t=>t.length>0).join("\n"):""}class i{constructor(){this.spanCounter=0,this.spanData=new Map,this.generateNewTrace()}generateNewTrace(){return this.currentTraceId=this.generateTraceId(),this.currentSpanId=void 0,this.spanCounter=0,this.currentTraceId}startSpan(t){const e=this.currentSpanId;return this.currentSpanId=this.generateSpanId(),this.spanCounter++,t&&this.setSpanData(t,{parentSpanId:e,operationName:t,startTime:Date.now()}),this.currentSpanId}finishSpan(t,e){t&&this.currentSpanId===t&&e&&this.setSpanData(t,{...this.getSpanData(t),...e,endTime:Date.now()})}getCurrentTraceId(){return this.currentTraceId}getCurrentSpanId(){return this.currentSpanId}getTraceContext(){return{traceId:this.currentTraceId,spanId:this.currentSpanId,parentSpanId:this.getParentSpanId()}}extractTraceFromHeaders(t){var e,s,i,n;return{traceId:t["x-trace-id"]||(null===(e=t.traceparent)||void 0===e?void 0:e.split("-")[1])||t["b3-traceid"]||(null===(s=t["uber-trace-id"])||void 0===s?void 0:s.split(":")[0]),spanId:t["x-span-id"]||(null===(i=t.traceparent)||void 0===i?void 0:i.split("-")[2])||t["b3-spanid"]||(null===(n=t["uber-trace-id"])||void 0===n?void 0:n.split(":")[1])}}injectTraceHeaders(){if(!this.currentTraceId)return{};const t={};return t["x-trace-id"]=this.currentTraceId,this.currentSpanId&&(t["x-span-id"]=this.currentSpanId,t["x-parent-span-id"]=this.getParentSpanId()||""),this.currentSpanId&&(t.traceparent=`00-${this.currentTraceId}-${this.currentSpanId}-01`),t}correlateWithBackendTrace(t,e){t&&(this.currentTraceId=t),e&&(this.currentSpanId=e)}generateTraceId(){return this.generateRandomHex(32)}generateSpanId(){return this.generateRandomHex(16)}generateRandomHex(t){const e=new Uint8Array(t/2);if("undefined"!=typeof crypto&&crypto.getRandomValues)crypto.getRandomValues(e);else for(let t=0;e.length>t;t++)e[t]=Math.floor(256*Math.random());return Array.from(e,t=>t.toString(16).padStart(2,"0")).join("")}getParentSpanId(){var t;return null===(t=this.spanData.get(this.currentSpanId||""))||void 0===t?void 0:t.parentSpanId}setSpanData(t,e){this.spanData.set(t,e)}getSpanData(t){return this.spanData.get(t)||{}}cleanupSpanData(){const t=Date.now()-3e5;for(const[e,s]of this.spanData.entries())s.endTime&&t>s.endTime&&this.spanData.delete(e)}}class n{constructor(t,e){this.breadcrumbs=[],this.userContext={},this.config=t,this.traceManager=e||new i,this.setupGlobalHandlers()}setupGlobalHandlers(){if("undefined"==typeof window)return;window.addEventListener("error",t=>{this.captureError({message:t.message,filename:t.filename,lineno:t.lineno,colno:t.colno,error:t.error})}),window.addEventListener("unhandledrejection",t=>{const e=t.reason;let i="Unhandled Promise Rejection",n="";e instanceof Error?(i=e.message,n=s(e)):i="string"==typeof e?e:JSON.stringify(e),this.captureError({message:i,stack:n,error:e})});const t=console.error;console.error=(...e)=>{this.addBreadcrumb({timestamp:Date.now(),message:e.join(" "),category:"console",level:"error"}),t.apply(console,e)};const e=console.warn;console.warn=(...t)=>{this.addBreadcrumb({timestamp:Date.now(),message:t.join(" "),category:"console",level:"warning"}),e.apply(console,t)}}captureError(t){var i,n;if(this.config.sampleRate&&Math.random()>this.config.sampleRate)return"";const r=e(),o=this.traceManager.startSpan("error:"+t.message),a=this.traceManager.getTraceContext(),h={id:r,timestamp:Date.now(),message:t.message,stack:t.stack||(t.error?s(t.error):void 0),url:t.filename||window.location.href,lineno:t.lineno,colno:t.colno,filename:t.filename,userId:this.config.userId||this.userContext.id,sessionId:"",userAgent:navigator.userAgent,environment:this.config.environment,release:this.config.release,tags:t.tags,extra:t.extra,breadcrumbs:[...this.breadcrumbs],level:t.level||"error",traceId:a.traceId,spanId:o,parentSpanId:a.parentSpanId};return(null===(n=(i=this.config).beforeSend)||void 0===n?void 0:n.call(i,h))||h?r:""}captureException(t,e={}){return this.captureError({message:t.message,stack:s(t),error:t,level:e.level,tags:e.tags,extra:e.extra})}captureMessage(t,e={}){return this.captureError({message:t,level:e.level||"info",tags:e.tags,extra:e.extra})}addBreadcrumb(t){this.breadcrumbs.push(t);const e=this.config.maxBreadcrumbs||50;this.breadcrumbs.length>e&&this.breadcrumbs.splice(0,this.breadcrumbs.length-e)}setUserContext(t){this.userContext={...this.userContext,...t}}setTags(t){}setExtra(t){}getBreadcrumbs(){return[...this.breadcrumbs]}clearBreadcrumbs(){this.breadcrumbs=[]}}class r{constructor(t,e){this.events=[],this.config=t,this.traceManager=e,this.storage=function(){try{if("undefined"!=typeof window&&window.sessionStorage)return window.sessionStorage.setItem("test","test"),window.sessionStorage.removeItem("test"),window.sessionStorage}catch(t){}return null}(),this.sessionId=this.getOrCreateSessionId(),this.startTime=Date.now(),this.setupEventListeners(),this.trackPageLoad()}getOrCreateSessionId(){const t="revi_session_id";if(this.storage){const e=this.storage.getItem(t);if(e)return e}const s=e();return this.storage&&this.storage.setItem(t,s),s}getSessionId(){return this.sessionId}setupEventListeners(){if("undefined"==typeof window)return;let t,e;["click","input","change","submit","focus","blur"].forEach(t=>{document.addEventListener(t,e=>{this.captureEvent(t,this.serializeDOMEvent(e))},{capture:!0,passive:!0})}),window.addEventListener("popstate",()=>{this.captureEvent("navigation",{type:"popstate",url:window.location.href,timestamp:Date.now()})}),document.addEventListener("visibilitychange",()=>{this.captureEvent("visibility",{hidden:document.hidden,timestamp:Date.now()})}),window.addEventListener("scroll",()=>{clearTimeout(t),t=setTimeout(()=>{this.captureEvent("scroll",{x:window.scrollX,y:window.scrollY,timestamp:Date.now()})},100)},{passive:!0}),window.addEventListener("resize",()=>{clearTimeout(e),e=setTimeout(()=>{this.captureEvent("resize",{width:window.innerWidth,height:window.innerHeight,timestamp:Date.now()})},100)},{passive:!0}),window.addEventListener("beforeunload",()=>{this.captureEvent("beforeunload",{timestamp:Date.now(),duration:Date.now()-this.startTime}),this.flush()})}serializeDOMEvent(t){var e;const s=t.target;if(!s)return{};const i={type:t.type,timestamp:Date.now(),target:{tagName:s.tagName,id:s.id,className:s.className,textContent:this.shouldMaskText(s)?"[Masked]":null===(e=s.textContent)||void 0===e?void 0:e.slice(0,100)}};if("click"===t.type&&(i.coordinates={x:t.clientX,y:t.clientY}),"input"===t.type||"change"===t.type){const e=t.target;e&&void 0!==e.value&&(i.value=this.shouldMaskInput(e)?"[Masked]":e.value)}return i}shouldMaskInput(t){var e,s,i;if(!(null===(e=this.config.privacy)||void 0===e?void 0:e.maskInputs))return!1;if(["password","email","tel","credit-card-number"].includes(t.type))return!0;const n=(null===(s=t.name)||void 0===s?void 0:s.toLowerCase())||"",r=(null===(i=t.id)||void 0===i?void 0:i.toLowerCase())||"";return["password","email","phone","credit","card","ssn"].some(t=>n.includes(t)||r.includes(t))}shouldMaskText(t){var e,s;if(!(null===(e=this.config.replay)||void 0===e?void 0:e.maskAllText))return!1;if(null===(s=this.config.replay)||void 0===s?void 0:s.maskSelector)try{return t.matches(this.config.replay.maskSelector)}catch(t){return!1}return!1}trackPageLoad(){if("undefined"==typeof window)return;const t=()=>{this.captureEvent("page_load",{url:window.location.href,title:document.title,referrer:document.referrer,timestamp:Date.now(),loadTime:performance.now()})};"complete"===document.readyState?t():window.addEventListener("load",t)}captureEvent(t,e){var s,i,n,r;if(this.config.sessionSampleRate&&Math.random()>this.config.sessionSampleRate)return;const o=null===(s=this.traceManager)||void 0===s?void 0:s.getTraceContext(),a=null===(i=this.traceManager)||void 0===i?void 0:i.startSpan("session:"+t),h={sessionId:this.sessionId,timestamp:Date.now(),type:t,data:e,traceId:null==o?void 0:o.traceId,spanId:a},c=(null===(r=(n=this.config).beforeSendSession)||void 0===r?void 0:r.call(n,h))||h;c&&(this.events.push(c),100>this.events.length||this.flush())}getEvents(){return[...this.events]}clearEvents(){this.events=[]}flush(){const t=this.getEvents();return this.clearEvents(),t}endSession(){this.captureEvent("session_end",{timestamp:Date.now(),duration:Date.now()-this.startTime}),this.storage&&this.storage.removeItem("revi_session_id")}}class o{constructor(t,e){this.events=[],this.config=t,this.traceManager=e||new i,this.originalFetch=window.fetch,this.originalXHROpen=XMLHttpRequest.prototype.open,this.originalXHRSend=XMLHttpRequest.prototype.send,this.setupInterceptors()}setupInterceptors(){"undefined"!=typeof window&&(this.interceptFetch(),this.interceptXHR())}interceptFetch(){window.fetch=async(...t)=>{var e,s,i;const n=Date.now(),r="string"==typeof t[0]?t[0]:t[0].url,o=((null===(e=t[1])||void 0===e?void 0:e.method)||"GET").toUpperCase();if(!this.shouldMonitorRequest(r))return await this.originalFetch.apply(window,t);const a=this.traceManager.startSpan(`http:${o} ${r}`),h=this.traceManager.injectTraceHeaders(),c={...(null===(s=t[1])||void 0===s?void 0:s.headers)||{},...h},d=[t[0],{...t[1],headers:c}];let u,l=0;(null===(i=t[1])||void 0===i?void 0:i.body)&&(u=this.serializeRequestBody(t[1].body),l=this.calculateBodySize(t[1].body));try{const t=await this.originalFetch.apply(window,d),e=Date.now();let s,i=0;if(this.shouldCaptureResponseBody(r)){const e=t.clone();try{s=await this.extractResponseBody(e),i=this.calculateResponseSize(s)}catch(t){}}const h=this.traceManager.extractTraceFromHeaders(this.extractResponseHeaders(t.headers));h.traceId&&this.traceManager.correlateWithBackendTrace(h.traceId,h.spanId),this.traceManager.finishSpan(a,{statusCode:t.status,responseTime:e-n});const p=this.traceManager.getTraceContext();return this.captureNetworkEvent({method:o,url:r,statusCode:t.status,responseTime:e-n,requestSize:l,responseSize:i,requestHeaders:this.extractHeaders(c),responseHeaders:this.extractResponseHeaders(t.headers),requestBody:u,responseBody:s,timestamp:n,traceId:p.traceId,spanId:a,parentSpanId:p.parentSpanId}),t}catch(t){const e=Date.now();this.traceManager.finishSpan(a,{statusCode:0,responseTime:e-n,error:t instanceof Error?t.message:t+""});const s=this.traceManager.getTraceContext();throw this.captureNetworkEvent({method:o,url:r,statusCode:0,responseTime:e-n,requestSize:l,responseSize:0,requestHeaders:this.extractHeaders(c),requestBody:u,timestamp:n,traceId:s.traceId,spanId:a,parentSpanId:s.parentSpanId}),t}}}interceptXHR(){const t=this;XMLHttpRequest.prototype.open=function(e,s,...i){return this.t={method:e.toUpperCase(),url:s,startTime:Date.now(),shouldMonitor:t.shouldMonitorRequest(s)},t.originalXHROpen.call(this,e,s,...i)},XMLHttpRequest.prototype.send=function(e){const s=this.t;return s&&s.shouldMonitor?(s.requestBody=t.serializeRequestBody(e),s.requestSize=t.calculateBodySize(e),this.addEventListener("loadend",()=>{const e=Date.now();let i;try{""===this.responseType||"text"===this.responseType?i=this.responseText:"json"===this.responseType&&(i=this.response)}catch(t){}t.captureNetworkEvent({method:s.method,url:s.url,statusCode:this.status,responseTime:e-s.startTime,requestSize:s.requestSize,responseSize:t.calculateResponseSize(i),requestBody:s.requestBody,responseBody:t.shouldCaptureResponseBody(s.url)?i:void 0,timestamp:s.startTime})}),t.originalXHRSend.call(this,e)):t.originalXHRSend.call(this,e)}}serializeRequestBody(t){if(t){if("string"==typeof t)return t;if(t instanceof FormData){const e={};return t.forEach((t,s)=>{e[s]=t instanceof File?`[File: ${t.name}]`:t}),e}if(t instanceof URLSearchParams)return Object.fromEntries(t);try{return JSON.parse(JSON.stringify(t))}catch(t){return"[Unserializable]"}}}async extractResponseBody(t){const e=t.headers.get("content-type")||"";return e.includes("application/json")?await t.json():e.includes("text/")?await t.text():"[Binary Data]"}extractHeaders(t){if(!t)return{};if(t instanceof Headers){const e={};return t.forEach((t,s)=>{e[s]=t}),e}if(Array.isArray(t)){const e={};return t.forEach(([t,s])=>{e[t]=s}),e}return t}extractResponseHeaders(t){const e={};return t.forEach((t,s)=>{e[s]=t}),e}calculateBodySize(t){if(!t)return 0;if("string"==typeof t)return t.length;if(t instanceof ArrayBuffer)return t.byteLength;if(t instanceof Blob)return t.size;try{return JSON.stringify(t).length}catch(t){return 0}}calculateResponseSize(t){if(!t)return 0;try{return JSON.stringify(t).length}catch(t){return 0}}shouldCaptureResponseBody(t){return[/\/api\//,/\/graphql/].some(e=>e.test(t))}shouldMonitorRequest(t){var e,s;const i=(this.config.apiUrl||"https://api.revi.dev").replace(/\/$/,"");return!t.replace(/\/$/,"").startsWith(i)&&!(this.config.developmentHosts||[/^https?:\/\/localhost:\d+/,/^https?:\/\/127\.0\.0\.1:\d+/,/^https?:\/\/0\.0\.0\.0:\d+/,/^https?:\/\/.*\.local:\d+/]).find(e=>e.test(t))&&![/\/api\/capture\//,/\/api\/errors/,/\/api\/session/,/\/api\/projects/,/\/api\/database/,/\/api\/analytics/,/\/health$/].find(e=>e.test(t))&&(!this.config.excludeUrls||!this.config.excludeUrls.some(e=>e.test(t)))&&(!(null===(e=this.config.privacy)||void 0===e?void 0:e.denyUrls)||!this.config.privacy.denyUrls.some(e=>RegExp(e).test(t)))&&(!(null===(s=this.config.privacy)||void 0===s?void 0:s.allowUrls)||this.config.privacy.allowUrls.some(e=>RegExp(e).test(t)))}captureNetworkEvent(t){this.events.push({sessionId:"",timestamp:t.timestamp,method:t.method,url:t.url,statusCode:t.statusCode,responseTime:t.responseTime,requestSize:t.requestSize,responseSize:t.responseSize,requestHeaders:t.requestHeaders,responseHeaders:t.responseHeaders,requestBody:t.requestBody,responseBody:t.responseBody}),50>this.events.length||this.flush()}getEvents(){return[...this.events]}clearEvents(){this.events=[]}flush(){const t=this.getEvents();return this.clearEvents(),t}destroy(){this.originalFetch&&(window.fetch=this.originalFetch),XMLHttpRequest.prototype.open=this.originalXHROpen,XMLHttpRequest.prototype.send=this.originalXHRSend}}class a{constructor(){this.db=null,this.dbName="revi-storage",this.version=1,this.storeName="queue",this.maxQueueSize=1e3,this.maxAge=6048e5}async initialize(){if("undefined"==typeof window||!window.indexedDB)throw Error("IndexedDB not supported");return new Promise((t,e)=>{const s=indexedDB.open(this.dbName,this.version);s.onerror=()=>{e(Error("Failed to open IndexedDB"))},s.onsuccess=()=>{this.db=s.result,t()},s.onupgradeneeded=t=>{const e=t.target.result;if(!e.objectStoreNames.contains(this.storeName)){const t=e.createObjectStore(this.storeName,{keyPath:"id"});t.createIndex("timestamp","timestamp",{unique:!1}),t.createIndex("type","type",{unique:!1})}}})}async store(t,e){this.db||await this.initialize(),await this.cleanupExpiredItems();const s=await this.getQueueSize();this.maxQueueSize>s||await this.removeOldestItems(100);const i={id:this.generateId(),type:t,data:await this.compress(e),timestamp:Date.now(),compressed:!0};return new Promise((t,e)=>{if(!this.db)return void e(Error("Database not initialized"));const s=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName).add(i);s.onsuccess=()=>t(),s.onerror=()=>e(Error("Failed to store item"))})}async getAll(){return this.db||await this.initialize(),new Promise((t,e)=>{if(!this.db)return void e(Error("Database not initialized"));const s=this.db.transaction([this.storeName],"readonly").objectStore(this.storeName).getAll();s.onsuccess=async()=>{const e=s.result,i={errors:[],sessionEvents:[],networkEvents:[]};for(const t of e){const e=await this.decompress(t.data);switch(t.type){case"error":i.errors.push(...Array.isArray(e)?e:[e]);break;case"session":i.sessionEvents.push(...Array.isArray(e)?e:[e]);break;case"network":i.networkEvents.push(...Array.isArray(e)?e:[e])}}t(i)},s.onerror=()=>e(Error("Failed to retrieve items"))})}async clear(){return this.db||await this.initialize(),new Promise((t,e)=>{if(!this.db)return void e(Error("Database not initialized"));const s=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName).clear();s.onsuccess=()=>t(),s.onerror=()=>e(Error("Failed to clear storage"))})}async getQueueSize(){return this.db||await this.initialize(),new Promise((t,e)=>{if(!this.db)return void e(Error("Database not initialized"));const s=this.db.transaction([this.storeName],"readonly").objectStore(this.storeName).count();s.onsuccess=()=>t(s.result),s.onerror=()=>e(Error("Failed to get queue size"))})}async cleanupExpiredItems(){if(!this.db)return;const t=Date.now()-this.maxAge;return new Promise(e=>{if(!this.db)return void e();const s=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName).index("timestamp"),i=IDBKeyRange.upperBound(t),n=s.openCursor(i);n.onsuccess=t=>{const s=t.target.result;s?(s.delete(),s.continue()):e()},n.onerror=()=>e()})}async removeOldestItems(t){if(this.db)return new Promise(e=>{if(!this.db)return void e();const s=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName).index("timestamp").openCursor();let i=0;s.onsuccess=s=>{const n=s.target.result;n&&t>i?(n.delete(),i++,n.continue()):e()},s.onerror=()=>e()})}async compress(t){try{const e=JSON.stringify(t);return btoa(unescape(encodeURIComponent(e)))}catch(e){return JSON.stringify(t)}}async decompress(t){try{const e=decodeURIComponent(escape(atob(t)));return JSON.parse(e)}catch(e){try{return JSON.parse(t)}catch(e){return t}}}generateId(){return`revi-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}}class h{constructor(){this.storageKey="revi_upload_queue";const t=function(){try{if("undefined"!=typeof window&&window.localStorage)return window.localStorage.setItem("test","test"),window.localStorage.removeItem("test"),window.localStorage}catch(t){}return null}();if(!t)throw Error("No storage available");this.storage=t}async store(t,e){try{const s=await this.getAll();switch(t){case"error":s.errors.push(...Array.isArray(e)?e:[e]);break;case"session":s.sessionEvents.push(...Array.isArray(e)?e:[e]);break;case"network":s.networkEvents.push(...Array.isArray(e)?e:[e])}this.storage.setItem(this.storageKey,JSON.stringify(s))}catch(t){throw Error("Failed to store data")}}async getAll(){try{const t=this.storage.getItem(this.storageKey);if(t)return JSON.parse(t)}catch(t){}return{errors:[],sessionEvents:[],networkEvents:[]}}async clear(){try{this.storage.removeItem(this.storageKey)}catch(t){}}}class c{constructor(){this.storage=null,this.isInitialized=!1}async initialize(){if(!this.isInitialized){try{const t=new a;await t.initialize(),this.storage=t}catch(t){try{this.storage=new h}catch(t){this.storage=new d}}this.isInitialized=!0}}async storeErrors(t){await this.ensureInitialized(),t.length>0&&await this.storage.store("error",t)}async storeSessionEvents(t){await this.ensureInitialized(),t.length>0&&await this.storage.store("session",t)}async storeNetworkEvents(t){await this.ensureInitialized(),t.length>0&&await this.storage.store("network",t)}async getAllData(){return await this.ensureInitialized(),await this.storage.getAll()}async clearAll(){await this.ensureInitialized(),await this.storage.clear()}async getQueueSize(){if(await this.ensureInitialized(),this.storage&&"getQueueSize"in this.storage&&this.storage.getQueueSize)return await this.storage.getQueueSize();{const t=await this.getAllData();return t.errors.length+t.sessionEvents.length+t.networkEvents.length}}async ensureInitialized(){this.isInitialized||await this.initialize()}}class d{async store(){}async getAll(){return{errors:[],sessionEvents:[],networkEvents:[]}}async clear(){}}class u{constructor(){this.isOnline="undefined"==typeof navigator||navigator.onLine,this.connectionType="unknown",this.listeners=[],"undefined"!=typeof window&&(window.addEventListener("online",()=>{this.isOnline=!0,this.notifyListeners(!0)}),window.addEventListener("offline",()=>{this.isOnline=!1,this.notifyListeners(!1)}),this.detectConnectionType())}getConnectionStatus(){return{online:this.isOnline,connectionType:this.connectionType}}onConnectionChange(t){return this.listeners.push(t),()=>{const e=this.listeners.indexOf(t);e>-1&&this.listeners.splice(e,1)}}getBatchSize(){if(!this.isOnline)return 0;switch(this.connectionType){case"slow-2g":return 5;case"2g":return 10;case"3g":default:return 25;case"4g":return 50}}getUploadDelay(){if(!this.isOnline)return 0;switch(this.connectionType){case"slow-2g":return 3e4;case"2g":return 15e3;case"3g":default:return 1e4;case"4g":return 5e3}}shouldRetry(t){return!!this.isOnline&&5>t}getRetryDelay(t){return Math.min(1e3*Math.pow(2,t),16e3)}detectConnectionType(){if("connection"in navigator){const t=navigator.connection;this.connectionType=t.effectiveType||t.type||"unknown",t.addEventListener("change",()=>{this.connectionType=t.effectiveType||t.type||"unknown"})}}notifyListeners(t){this.listeners.forEach(e=>{try{e(t)}catch(t){}})}async testConnectivity(t){if(!this.isOnline)return!1;try{const e=t||"https://api.revi.dev/health";return await fetch(e,{method:"HEAD",mode:"no-cors",cache:"no-cache"}),!0}catch(t){return!1}}}async function l(t){const e=JSON.stringify(t);if(1024>e.length)return{data:e,compressed:!1};try{if("undefined"!=typeof CompressionStream){const t=new CompressionStream("gzip"),s=t.writable.getWriter(),i=t.readable.getReader(),n=(new TextEncoder).encode(e);await s.write(n),await s.close();const r=[];let o=!1;for(;!o;){const{value:t,done:e}=await i.read();o=e,t&&r.push(t)}const a=new Uint8Array(r.reduce((t,e)=>t+e.length,0));let h=0;for(const t of r)a.set(t,h),h+=t.length;const c=btoa(String.fromCharCode(...a));if(.8*e.length>c.length)return{data:c,compressed:!0}}}catch(t){}return{data:e,compressed:!1}}function p(t){if(0===t.length)return{events:t,compressionRatio:1};const e=JSON.stringify(t).length,s=new Map;for(const e of t){const t=Object.keys(e).sort().join(",");s.has(t)||s.set(t,[]),s.get(t).push(e)}const i=[];for(const[t,e]of s){if(1===e.length){i.push(e[0]);continue}const s={},n=t.split(",");for(const t of n){const i=e.map(e=>e[t]),n=i[0];i.every(t=>JSON.stringify(t)===JSON.stringify(n))&&(s[t]=n)}for(const t of e){const e={...t};for(const i of Object.keys(s))JSON.stringify(t[i])===JSON.stringify(s[i])&&delete e[i];Object.keys(s).length>2&&(e.i=s),i.push(e)}}return{events:i,compressionRatio:JSON.stringify(i).length/e}}function v(t,e,s=65536){if(0===t.length)return[];const i=[];let n=[],r=0;for(const o of t){const t=JSON.stringify(o).length;e>n.length&&s>=r+t||n.length>0&&(i.push(n),n=[],r=0),n.push(o),r+=t}return n.length>0&&i.push(n),i}class w{constructor(t){this.uploadTimer=null,this.isUploading=!1,this.retryAttempts=new Map,this.uploadQueue={errors:[],sessionEvents:[],networkEvents:[]},this.config=t,this.storageManager=new c,this.networkManager=new u,this.initialize()}async initialize(){try{await this.storageManager.initialize(),await this.loadQueueFromStorage(),this.startNetworkAwareUploadTimer(),this.setupBeforeUnloadHandler(),this.setupNetworkChangeHandler()}catch(t){}}async loadQueueFromStorage(){try{const t=await this.storageManager.getAllData();this.uploadQueue=t}catch(t){}}async saveQueueToStorage(){try{await this.storageManager.clearAll(),this.uploadQueue.errors.length>0&&await this.storageManager.storeErrors(this.uploadQueue.errors),this.uploadQueue.sessionEvents.length>0&&await this.storageManager.storeSessionEvents(this.uploadQueue.sessionEvents),this.uploadQueue.networkEvents.length>0&&await this.storageManager.storeNetworkEvents(this.uploadQueue.networkEvents)}catch(t){}}startNetworkAwareUploadTimer(){const t=()=>{this.uploadTimer&&clearTimeout(this.uploadTimer);const e=this.networkManager.getUploadDelay();e>0&&(this.uploadTimer=setTimeout(()=>{!this.isUploading&&this.hasQueuedData()?this.uploadData().finally(()=>{t()}):t()},e))};t()}setupNetworkChangeHandler(){this.networkManager.onConnectionChange(t=>{t&&this.hasQueuedData()&&!this.isUploading&&setTimeout(()=>{this.uploadData()},1e3)})}setupBeforeUnloadHandler(){"undefined"!=typeof window&&window.addEventListener("beforeunload",()=>{this.hasQueuedData()&&this.uploadDataSync()})}queueError(t){this.uploadQueue.errors.push(t),this.saveQueueToStorage().catch(t=>{})}queueSessionEvents(t){this.uploadQueue.sessionEvents.push(...t),this.saveQueueToStorage().catch(t=>{})}queueNetworkEvents(t){this.uploadQueue.networkEvents.push(...t),this.saveQueueToStorage().catch(t=>{})}hasQueuedData(){return this.uploadQueue.errors.length>0||this.uploadQueue.sessionEvents.length>0||this.uploadQueue.networkEvents.length>0}async uploadData(){if(this.isUploading||!this.hasQueuedData())return;const{online:t}=this.networkManager.getConnectionStatus();if(!t)return;this.isUploading=!0;const e=this.config.apiUrl||"https://api.revi.dev",s=this.networkManager.getBatchSize();try{if(this.uploadQueue.errors.length>0){const{events:t}=p(this.uploadQueue.errors),i=v(t,s,32768);for(const t of i)await this.uploadErrorsWithRetry(e,t);this.uploadQueue.errors=[]}if(this.uploadQueue.sessionEvents.length>0){const{events:t}=p(this.uploadQueue.sessionEvents),i=v(t,s,65536);for(const t of i)await this.uploadSessionEventsWithRetry(e,t);this.uploadQueue.sessionEvents=[]}if(this.uploadQueue.networkEvents.length>0){const{events:t}=p(this.uploadQueue.networkEvents),i=v(t,s,49152);for(const t of i)await this.uploadNetworkEventsWithRetry(e,t);this.uploadQueue.networkEvents=[]}await this.saveQueueToStorage(),this.retryAttempts.clear()}catch(t){}finally{this.isUploading=!1}}createBatches(t,e){if(0>=e)return[];const s=[];for(let i=0;t.length>i;i+=e)s.push(t.slice(i,i+e));return s}uploadDataSync(){var t;if(!this.hasQueuedData())return;const e=this.config.apiUrl||"https://api.revi.dev";if(navigator.sendBeacon){if(this.uploadQueue.errors.length>0){const t=JSON.stringify({errors:this.uploadQueue.errors});navigator.sendBeacon(e+"/api/capture/error",t)}if(this.uploadQueue.sessionEvents.length>0){const s=JSON.stringify({session_id:null===(t=this.uploadQueue.sessionEvents[0])||void 0===t?void 0:t.sessionId,events:this.uploadQueue.sessionEvents.map(t=>({event_type:t.type,data:t.data,timestamp:t.timestamp,session_id:t.sessionId}))});navigator.sendBeacon(e+"/api/capture/session-event",s)}if(this.uploadQueue.networkEvents.length>0){const t=JSON.stringify({events:this.uploadQueue.networkEvents});navigator.sendBeacon(e+"/api/capture/network-event",t)}}}async uploadErrors(t,e){const s={errors:e.map(t=>({message:t.message,stack_trace:t.stack,url:t.url,user_agent:t.userAgent,session_id:t.sessionId,metadata:{id:t.id,userId:t.userId,environment:t.environment,release:t.release,tags:t.tags,extra:t.extra,breadcrumbs:t.breadcrumbs,level:t.level,lineno:t.lineno,colno:t.colno,filename:t.filename}}))},{data:i,compressed:n}=await l(s),r={"X-API-Key":this.config.apiKey};n?(r["Content-Type"]="application/octet-stream",r["Content-Encoding"]="gzip",r["X-Original-Content-Type"]="application/json"):r["Content-Type"]="application/json";const o=await fetch(t+"/api/capture/error",{method:"POST",headers:r,body:i});if(!o.ok)throw Error("Upload failed: "+o.status)}async uploadSessionEvents(t,e){if(0===e.length)return;const s={session_id:e[0].sessionId,events:e.map(t=>({event_type:t.type,data:t.data,timestamp:t.timestamp,session_id:t.sessionId}))},{data:i,compressed:n}=await l(s),r={"X-API-Key":this.config.apiKey};n?(r["Content-Type"]="application/octet-stream",r["Content-Encoding"]="gzip",r["X-Original-Content-Type"]="application/json"):r["Content-Type"]="application/json";const o=await fetch(t+"/api/capture/session-event",{method:"POST",headers:r,body:i});if(!o.ok)throw Error("Upload failed: "+o.status)}async uploadNetworkEvents(t,e){const s=e.map(e=>fetch(t+"/api/capture/network-event",{method:"POST",headers:{"Content-Type":"application/json","X-API-Key":this.config.apiKey},body:JSON.stringify({session_id:e.sessionId,events:[{method:e.method,url:e.url,status_code:e.statusCode,response_time:e.responseTime,timestamp:e.timestamp,session_id:e.sessionId,request_data:{headers:e.requestHeaders||{},body:e.requestBody||null,size:e.requestSize||0},response_data:{headers:e.responseHeaders||{},body:e.responseBody||null,size:e.responseSize||0}}]})})),i=(await Promise.allSettled(s)).filter(t=>"rejected"===t.status);if(i.length>0)throw Error(i.length+" network event uploads failed")}async uploadErrorsWithRetry(t,e){return this.executeWithRetry("errors",()=>this.uploadErrors(t,e))}async uploadSessionEventsWithRetry(t,e){return this.executeWithRetry("session_events",()=>this.uploadSessionEvents(t,e))}async uploadNetworkEventsWithRetry(t,e){return this.executeWithRetry("network_events",()=>this.uploadNetworkEvents(t,e))}async executeWithRetry(t,e){const s=this.retryAttempts.get(t)||0;if(!this.networkManager.shouldRetry(s))throw Error("Max retry attempts exceeded for "+t);try{const s=await e();return this.retryAttempts.delete(t),s}catch(i){if(this.retryAttempts.set(t,s+1),this.networkManager.shouldRetry(s+1)){const i=this.networkManager.getRetryDelay(s+1);return await new Promise(t=>setTimeout(t,i)),this.executeWithRetry(t,e)}throw i}}async clearQueue(){this.uploadQueue={errors:[],sessionEvents:[],networkEvents:[]},await this.storageManager.clearAll()}destroy(){this.uploadTimer&&(clearTimeout(this.uploadTimer),this.uploadTimer=null),this.hasQueuedData()&&this.uploadDataSync()}}class m{constructor(t){this.journeyEvents=[],this.isTracking=!1,this.config=t,this.deviceFingerprint=this.generateDeviceFingerprint(),this.sessionStartTime=Date.now(),this.currentPageStartTime=Date.now(),"undefined"!=typeof window&&this.setupJourneyTracking()}startTracking(t){this.userId=t,this.isTracking=!0,this.trackPageView()}stopTracking(){this.isTracking=!1,this.flush()}setUserId(t){this.userId=t}trackPageView(){if(!this.isTracking)return;const t={event_type:"page_view",url:window.location.href,referrer:document.referrer||void 0,timestamp:Date.now(),metadata:{title:document.title,viewport:{width:window.innerWidth,height:window.innerHeight},scroll_position:{x:window.scrollX,y:window.scrollY},device_fingerprint:this.deviceFingerprint,user_agent:navigator.userAgent,language:navigator.language,timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,connection_type:this.getConnectionType()}};this.addJourneyEvent(t)}trackClick(t,e){if(!this.isTracking)return;const s={event_type:"click",url:window.location.href,timestamp:Date.now(),metadata:{element:{tag:t.tagName.toLowerCase(),id:t.id,class:t.className,text:this.getElementText(t),attributes:this.getRelevantAttributes(t)},coordinates:{x:e.clientX,y:e.clientY,page_x:e.pageX,page_y:e.pageY},viewport:{width:window.innerWidth,height:window.innerHeight},scroll_position:{x:window.scrollX,y:window.scrollY}}};this.addJourneyEvent(s)}trackFormSubmit(t){var e;if(!this.isTracking)return;const s=new FormData(t),i={};s.forEach((e,s)=>{const n=t.querySelector(`[name="${s}"]`);i[s]={type:(null==n?void 0:n.type)||"unknown",has_value:!!e,value_length:"string"==typeof e?e.length:0}});const n={event_type:"form_submit",url:window.location.href,timestamp:Date.now(),metadata:{form:{id:t.id,class:t.className,method:t.method,action:t.action,field_count:s.entries().length},fields:(null===(e=this.config.privacy)||void 0===e?void 0:e.maskInputs)?{}:i}};this.addJourneyEvent(n)}trackApiCall(t,e,s,i,n){if(!this.isTracking)return;const r={event_type:"api_call",url:window.location.href,timestamp:Date.now(),duration_ms:i,metadata:{api:{url:t,method:e,status:s,duration:i,size:n||0,success:s>=200&&300>s},page_context:{title:document.title,time_on_page:Date.now()-this.currentPageStartTime}}};this.addJourneyEvent(r)}trackError(t,e){var s;if(!this.isTracking)return;const i={event_type:"error",url:window.location.href,timestamp:Date.now(),metadata:{error:{message:t.message,name:t.name,stack:null===(s=t.stack)||void 0===s?void 0:s.split("\n").slice(0,5).join("\n")},user_context:{time_on_page:Date.now()-this.currentPageStartTime,session_duration:Date.now()-this.sessionStartTime,page_interactions:this.countPageInteractions()},custom_context:e||{}}};this.addJourneyEvent(i)}setupJourneyTracking(){let t=window.location.href;const e=()=>{if(window.location.href!==t){const e=Date.now()-this.currentPageStartTime;this.updateLastPageViewDuration(e),t=window.location.href,this.currentPageStartTime=Date.now(),this.trackPageView()}};window.addEventListener("popstate",e);const s=history.pushState,i=history.replaceState;history.pushState=function(...t){s.apply(history,t),setTimeout(e,0)},history.replaceState=function(...t){i.apply(history,t),setTimeout(e,0)},document.addEventListener("click",t=>{const e=t.target;e&&this.shouldTrackClick(e)&&this.trackClick(e,t)},{capture:!0,passive:!0}),document.addEventListener("submit",t=>{const e=t.target;e&&"FORM"===e.tagName&&this.trackFormSubmit(e)},{capture:!0,passive:!0}),window.addEventListener("beforeunload",()=>{const t=Date.now()-this.currentPageStartTime;this.updateLastPageViewDuration(t),this.flush()}),setInterval(()=>{this.journeyEvents.length>0&&this.flush()},3e4)}generateDeviceFingerprint(){if("undefined"==typeof window)return"server";const t=[navigator.userAgent,navigator.language,screen.width+"x"+screen.height,screen.colorDepth,Intl.DateTimeFormat().resolvedOptions().timeZone,navigator.platform,navigator.cookieEnabled,void 0!==window.localStorage,void 0!==window.sessionStorage];try{const e=document.createElement("canvas"),s=e.getContext("2d");s&&(s.textBaseline="top",s.font="14px Arial",s.fillText("Device fingerprint",2,2),t.push(e.toDataURL()))}catch(t){}const e=t.join("|");let s=0;for(let t=0;e.length>t;t++)s=(s<<5)-s+e.charCodeAt(t),s&=s;return Math.abs(s).toString(36)}addJourneyEvent(t){this.journeyEvents.push(t),50>this.journeyEvents.length||this.flush()}flush(){if(0===this.journeyEvents.length)return;const t=[...this.journeyEvents];this.journeyEvents=[],this.sendJourneyEvents(t).catch(e=>{this.journeyEvents.unshift(...t)})}async sendJourneyEvents(t){const e=this.config.apiUrl||"https://api.revi.dev",s=t.map(t=>fetch(e+"/api/analytics/user-event",{method:"POST",headers:{"Content-Type":"application/json","X-API-Key":this.config.apiKey},body:JSON.stringify({user_id:this.userId,session_id:this.getSessionId(),...t})}));await Promise.allSettled(s)}shouldTrackClick(t){const e=t.tagName.toLowerCase();return!(["input","textarea"].includes(e)&&["password","hidden"].includes(t.type)||t.hasAttribute("data-revi-ignore"))}getElementText(t){return(t.textContent||t.innerText||"").trim().substring(0,100)}getRelevantAttributes(t){const e={};return["href","src","alt","title","data-testid","role"].forEach(s=>{const i=t.getAttribute(s);i&&(e[s]=i)}),e}getConnectionType(){if("connection"in navigator){const t=navigator.connection;return(null==t?void 0:t.effectiveType)||(null==t?void 0:t.type)||"unknown"}return"unknown"}countPageInteractions(){return this.journeyEvents.filter(t=>["click","form_submit"].includes(t.event_type)).length}updateLastPageViewDuration(t){if(this.journeyEvents.length>0){const e=this.journeyEvents[this.journeyEvents.length-1];"page_view"===e.event_type&&(e.duration_ms=t)}}getSessionId(){return"session-"+Date.now()}}class f{constructor(t){this.activityLevel=0,this.lastActivity=Date.now(),this.errorFrequency=0,this.performanceImpact=0,this.config=t,this.startPerformanceMonitoring()}startPerformanceMonitoring(){"undefined"!=typeof window&&"performance"in window&&setInterval(()=>{this.assessPerformanceImpact()},5e3)}assessPerformanceImpact(){if("undefined"!=typeof performance)try{const t=performance.now(),e=performance.getEntriesByType("longtask").filter(e=>1e4>t-e.startTime);this.performanceImpact=Math.min(e.length/5,1)}catch(t){this.performanceImpact=.1}}updateActivityLevel(t){this.activityLevel={high:1,medium:.7,low:.4,idle:.1}[t],this.lastActivity=Date.now()}incrementErrorFrequency(){this.errorFrequency=Math.min(this.errorFrequency+.1,1),setTimeout(()=>{this.errorFrequency=Math.max(this.errorFrequency-.05,0)},3e4)}shouldSampleError(){var t,e;const s=null!==(e=null===(t=this.config.sampling)||void 0===t?void 0:t.errorSampleRate)&&void 0!==e?e:1;if(this.errorFrequency>.5)return Math.random()<s;const i=s*(1-.5*this.performanceImpact);return Math.random()<i}shouldSampleSession(){var t,e,s;const i=null!==(s=null!==(e=null===(t=this.config.sampling)||void 0===t?void 0:t.sessionSampleRate)&&void 0!==e?e:this.config.sessionSampleRate)&&void 0!==s?s:1,n=Math.min(i+.2*this.activityLevel,1)*(1-.3*this.performanceImpact);return Math.random()<n}shouldSamplePerformance(){var t,e;const s=(null!==(e=null===(t=this.config.sampling)||void 0===t?void 0:t.performanceSampleRate)&&void 0!==e?e:.1)*(1-.7*this.performanceImpact);return Math.random()<s}shouldSampleNetwork(){var t,e;const s=(null!==(e=null===(t=this.config.sampling)||void 0===t?void 0:t.networkSampleRate)&&void 0!==e?e:.5)*((Date.now()-this.lastActivity)/6e4>5?.5:1)*(1-.4*this.performanceImpact);return Math.random()<s}shouldSampleReplay(){var t,e;const s=null!==(e=null===(t=this.config.sampling)||void 0===t?void 0:t.replaySampleRate)&&void 0!==e?e:.1;let i=Math.min(s+.3*this.errorFrequency,1);return i*=1-.8*this.performanceImpact,Math.random()<i}getAdaptiveBatchSize(t){return Math.max(Math.floor(t*(1-.6*this.performanceImpact)),1)}getAdaptiveUploadDelay(t){return Math.floor(t*(1+2*this.performanceImpact)*Math.max(.3,1-.7*this.errorFrequency))}shouldSkipCapture(t){switch(t){case"error":return!this.shouldSampleError();case"session":return!this.shouldSampleSession();case"performance":return!this.shouldSamplePerformance();case"network":return!this.shouldSampleNetwork();case"replay":return!this.shouldSampleReplay();default:return!1}}getPerformanceImpact(){return this.performanceImpact}getActivityLevel(){return this.activityLevel}getErrorFrequency(){return this.errorFrequency}}class y{constructor(t){var e,s,i;this.webVitals={},this.performanceEntries=[],this.config=t,(null===(e=this.config.performance)||void 0===e?void 0:e.captureWebVitals)&&this.setupWebVitals(),(null===(s=this.config.performance)||void 0===s?void 0:s.captureResourceTiming)&&this.setupResourceTiming(),(null===(i=this.config.performance)||void 0===i?void 0:i.captureNavigationTiming)&&this.setupNavigationTiming()}setupWebVitals(){if("undefined"!=typeof window&&"PerformanceObserver"in window){try{new PerformanceObserver(t=>{const e=t.getEntries();this.webVitals.lcp=e[e.length-1].startTime}).observe({entryTypes:["largest-contentful-paint"]})}catch(t){}try{new PerformanceObserver(t=>{t.getEntries().forEach(t=>{this.webVitals.fid=t.processingStart-t.startTime})}).observe({entryTypes:["first-input"]})}catch(t){}try{let t=0;new PerformanceObserver(e=>{e.getEntries().forEach(e=>{e.hadRecentInput||(t+=e.value,this.webVitals.cls=t)})}).observe({entryTypes:["layout-shift"]})}catch(t){}try{new PerformanceObserver(t=>{t.getEntries().forEach(t=>{"first-contentful-paint"===t.name&&(this.webVitals.fcp=t.startTime)})}).observe({entryTypes:["paint"]})}catch(t){}this.calculateTTFB()}}calculateTTFB(){if("undefined"!=typeof window&&window.performance)try{const t=performance.getEntriesByType("navigation")[0];t&&(this.webVitals.ttfb=t.responseStart-t.requestStart)}catch(t){}}setupResourceTiming(){if("undefined"!=typeof window&&window.performance)try{new PerformanceObserver(t=>{t.getEntries().forEach(t=>{this.performanceEntries.push({name:t.name,entryType:t.entryType,startTime:t.startTime,duration:t.duration,transferSize:t.transferSize,encodedBodySize:t.encodedBodySize,decodedBodySize:t.decodedBodySize})})}).observe({entryTypes:["resource"]})}catch(t){}}setupNavigationTiming(){"undefined"!=typeof window&&window.performance&&window.addEventListener("load",()=>{try{const t=performance.getEntriesByType("navigation")[0];t&&this.performanceEntries.push({name:"navigation",entryType:"navigation",startTime:t.startTime,duration:t.duration,domContentLoadedEventEnd:t.domContentLoadedEventEnd,domContentLoadedEventStart:t.domContentLoadedEventStart,loadEventEnd:t.loadEventEnd,loadEventStart:t.loadEventStart,domComplete:t.domComplete,domInteractive:t.domInteractive})}catch(t){}})}getWebVitals(){return{...this.webVitals}}getPerformanceEntries(){return[...this.performanceEntries]}clearPerformanceEntries(){this.performanceEntries=[]}mark(t){if("undefined"!=typeof window&&window.performance&&window.performance.mark)try{performance.mark(t)}catch(t){}}measure(t,e,s){if("undefined"==typeof window||!window.performance||!window.performance.measure)return null;try{performance.measure(t,e,s);const i=performance.getEntriesByName(t,"measure")[0];return i?i.duration:null}catch(t){return null}}}class g{constructor(t){this.nodeIdMap=new WeakMap,this.nodeMap=new Map,this.nextNodeId=1,this.isObserving=!1,this.config=t}takeSnapshot(){const t={timestamp:Date.now(),url:window.location.href,viewport:{width:window.innerWidth,height:window.innerHeight},scroll:{x:window.scrollX,y:window.scrollY},nodes:[],stylesheets:[],resources:[]};return t.nodes=this.serializeDocument(document),t.stylesheets=this.serializeStylesheets(),t.resources=this.serializeResources(),t}startObserving(t){this.isObserving||(this.onDOMChange=t,this.observer=new MutationObserver(this.handleMutations.bind(this)),this.observer.observe(document,{childList:!0,attributes:!0,characterData:!0,subtree:!0,attributeOldValue:!0,characterDataOldValue:!0}),this.isObserving=!0)}stopObserving(){this.observer&&(this.observer.disconnect(),this.observer=void 0),this.isObserving=!1,this.onDOMChange=void 0}serializeDocument(t){const e=t.doctype,s=[];if(e&&s.push({type:"document",tagName:"DOCTYPE",attributes:{name:e.name,publicId:e.publicId,systemId:e.systemId},id:this.getNodeId(e)}),t.documentElement){const e=this.serializeNode(t.documentElement);e&&s.push(e)}return s}serializeNode(t){if(this.shouldIgnoreNode(t))return null;const e=this.getNodeId(t),s={type:this.getNodeType(t),id:e};switch(t.nodeType){case Node.ELEMENT_NODE:const e=t;s.tagName=e.tagName.toLowerCase(),s.attributes=this.serializeAttributes(e),s.children=this.serializeChildren(e);break;case Node.TEXT_NODE:const i=t;s.textContent=this.shouldMaskText(i)?"[Masked]":i.textContent||"";break;case Node.COMMENT_NODE:s.textContent=t.textContent||"";break;default:return null}return s}serializeAttributes(t){const e={};for(let s=0;t.attributes.length>s;s++){const i=t.attributes[s],n=i.name.toLowerCase();this.shouldIgnoreAttribute(n,i.value)||(e[n]=this.shouldMaskAttribute(n,t)?"[Masked]":i.value)}return e}serializeChildren(t){const e=[];for(let s=0;t.childNodes.length>s;s++){const i=this.serializeNode(t.childNodes[s]);i&&e.push(i)}return e}serializeStylesheets(){const t=[];for(let e=0;e<document.styleSheets.length;e++){const s=document.styleSheets[e];try{let e="";s.href?e=`/* External stylesheet: ${s.href} */`:s.cssRules&&(e=Array.from(s.cssRules).map(t=>t.cssText).join("\n")),t.push({href:s.href||void 0,cssText:e,disabled:s.disabled})}catch(e){s.href&&t.push({href:s.href,cssText:`/* Could not access stylesheet: ${s.href} */`,disabled:s.disabled})}}return t}serializeResources(){const t=[];return document.querySelectorAll("img").forEach(e=>{e.src&&!this.shouldIgnoreResource(e.src)&&t.push({url:e.src,type:"image",failed:!e.complete||0===e.naturalWidth})}),document.querySelectorAll("*").forEach(e=>{const s=window.getComputedStyle(e).backgroundImage;if(s&&"none"!==s){const e=s.match(/url\(['"]?([^'")]+)['"]?\)/);e&&e[1]&&!this.shouldIgnoreResource(e[1])&&t.push({url:e[1],type:"image"})}}),t}handleMutations(t){t.forEach(t=>{const e=this.nodeIdMap.get(t.target);if(!e)return;const s={timestamp:Date.now(),type:t.type,target:e};switch(t.type){case"childList":t.addedNodes.length>0&&(s.addedNodes=Array.from(t.addedNodes).map(t=>this.serializeNode(t)).filter(t=>null!==t)),t.removedNodes.length>0&&(s.removedNodes=Array.from(t.removedNodes).map(t=>this.nodeIdMap.get(t)).filter(t=>void 0!==t));break;case"attributes":if(s.attributeName=t.attributeName||void 0,t.target.nodeType===Node.ELEMENT_NODE){const e=t.target,i=e.getAttribute(t.attributeName||"");s.attributeValue=this.shouldMaskAttribute(t.attributeName||"",e)?"[Masked]":i||""}s.oldValue=t.oldValue||void 0;break;case"characterData":s.attributeValue=this.shouldMaskText(t.target)?"[Masked]":t.target.textContent||"",s.oldValue=t.oldValue||void 0}this.onDOMChange&&this.onDOMChange(s)})}getNodeId(t){if(this.nodeIdMap.has(t))return this.nodeIdMap.get(t);const e=this.nextNodeId++;return this.nodeIdMap.set(t,e),this.nodeMap.set(e,t),e}getNodeType(t){switch(t.nodeType){case Node.ELEMENT_NODE:return"element";case Node.TEXT_NODE:return"text";case Node.COMMENT_NODE:return"comment";case Node.DOCUMENT_NODE:return"document";default:return"element"}}shouldIgnoreNode(t){var e;if(t.nodeType===Node.ELEMENT_NODE){const s=t,i=s.tagName.toLowerCase();if(["script","noscript","meta"].includes(i))return!0;if(s.hasAttribute("data-revi-ignore"))return!0;if(null===(e=this.config.replay)||void 0===e?void 0:e.blockSelector)try{if(s.matches(this.config.replay.blockSelector))return!0}catch(t){}}return!1}shouldIgnoreAttribute(t,e){return["data-revi-ignore","data-password","data-sensitive"].includes(t)}shouldMaskAttribute(t,e){var s;return!(!(null===(s=this.config.privacy)||void 0===s?void 0:s.maskInputs)||"input"!==e.tagName.toLowerCase()||!["password","email","tel"].includes(e.type)||"value"!==t)}shouldMaskText(t){var e,s,i,n;if(!(null===(e=this.config.replay)||void 0===e?void 0:e.maskAllText)&&!(null===(s=this.config.privacy)||void 0===s?void 0:s.maskInputs))return!1;const r=t.parentElement;if(!r)return!1;if(["input","textarea"].includes(r.tagName.toLowerCase()))return!0;if(null===(i=this.config.replay)||void 0===i?void 0:i.maskSelector)try{return r.matches(this.config.replay.maskSelector)}catch(t){return!1}return(null===(n=this.config.replay)||void 0===n?void 0:n.maskAllText)||!1}shouldIgnoreResource(t){try{const e=new URL(t,window.location.href);if("data:"===e.protocol)return!0;if(t.includes("?")){const t=new URLSearchParams(e.search),s=t.get("w")||t.get("width"),i=t.get("h")||t.get("height");if(s&&parseInt(s)>2e3)return!0;if(i&&parseInt(i)>2e3)return!0}return!1}catch(t){return!0}}}class b{constructor(t,e={}){this.originalMethods={},this.entries=[],this.isRecording=!1,this.sessionId=t,this.config={maxEntries:1e3,captureStackTrace:!0,serializeObjects:!0,maxObjectDepth:3,maxStringLength:1e4,ignoredLevels:[],...e}}start(){this.isRecording||(["log","info","warn","error","debug","trace"].forEach(t=>{if(this.config.ignoredLevels.includes(t))return;const e=console[t];this.originalMethods[t]=e,console[t]=(...s)=>{e.apply(console,s),this.recordEntry(t,s)}}),this.isRecording=!0)}stop(){this.isRecording&&(Object.entries(this.originalMethods).forEach(([t,e])=>{console[t]=e}),this.originalMethods={},this.isRecording=!1)}recordEntry(t,e){var s,i;try{const i={id:this.generateId(),timestamp:Date.now(),level:t,args:this.serializeArgs(e)};if(("error"===t||"warn"===t)&&this.config.captureStackTrace){const t=Error();t.stack&&(i.stack=this.cleanStackTrace(t.stack))}if("error"===t&&e[0]instanceof Error){const t=((null===(s=e[0].stack)||void 0===s?void 0:s.split("\n"))||[]).find(t=>t.includes(".js:")||t.includes(".ts:")||t.includes(".tsx:"));if(t){const e=t.match(/([^/]+):(\d+):(\d+)/);e&&(i.url=e[1],i.lineNumber=parseInt(e[2]),i.columnNumber=parseInt(e[3]))}}this.addEntry(i)}catch(t){null===(i=this.originalMethods.warn)||void 0===i||i.call(console,"ConsoleRecorder error:",t)}}serializeArgs(t){return t.map(t=>this.serializeValue(t,0))}serializeValue(t,e){if(e>this.config.maxObjectDepth)return"[Object too deep]";if(null==t)return t;if("string"==typeof t)return t.length>this.config.maxStringLength?t.substring(0,this.config.maxStringLength)+"...":t;if("number"==typeof t||"boolean"==typeof t)return t;if("function"==typeof t)return`[Function: ${t.name||"anonymous"}]`;if(t instanceof Error)return{name:t.name,message:t.message,stack:this.config.captureStackTrace?this.cleanStackTrace(t.stack||""):void 0};if(t instanceof Date)return{o:"Date",value:t.toISOString()};if(t instanceof RegExp)return{o:"RegExp",value:""+t};if(Array.isArray(t))return this.config.serializeObjects?t.slice(0,100).map(t=>this.serializeValue(t,e+1)):"[Array]";if("object"==typeof t){if(!this.config.serializeObjects)return"[Object]";try{const s={},i=Object.keys(t).slice(0,50);for(const n of i)try{s[n]=this.serializeValue(t[n],e+1)}catch(t){s[n]="[Unserializable]"}return Object.keys(t).length>50&&(s["..."]=`[${Object.keys(t).length-50} more keys]`),s}catch(t){return"[Unserializable Object]"}}return t+""}cleanStackTrace(t){return t.split("\n").filter(t=>!t.includes("console-recorder.ts")&&!t.includes("ConsoleRecorder")).slice(0,10).join("\n")}addEntry(t){this.entries.push(t),this.entries.length>this.config.maxEntries&&(this.entries=this.entries.slice(.8*-this.config.maxEntries))}generateId(){return`console-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}getEntries(t,e){let s=this.entries;return t&&(s=s.filter(e=>e.timestamp>=t)),e&&(s=s.filter(t=>e>=t.timestamp)),[...s]}getEntriesByLevel(t){return this.entries.filter(e=>e.level===t)}clear(){this.entries=[]}toSessionEvents(){return this.entries.map(t=>({session_id:this.sessionId,event_type:"console",data:{level:t.level,args:t.args,stack:t.stack,url:t.url,lineNumber:t.lineNumber,columnNumber:t.columnNumber,consoleId:t.id},timestamp:t.timestamp,url:t.url||window.location.href,user_agent:navigator.userAgent}))}exportData(){const t={};let e=1/0,s=-1/0;return this.entries.forEach(i=>{t[i.level]=(t[i.level]||0)+1,e=Math.min(e,i.timestamp),s=Math.max(s,i.timestamp)}),{sessionId:this.sessionId,config:this.config,entries:[...this.entries],stats:{totalEntries:this.entries.length,levelCounts:t,errorCount:t.error||0,warningCount:t.warn||0,timeRange:{start:e===1/0?0:e,end:s===-1/0?0:s}}}}generateInsights(){return{errorPatterns:this.findErrorPatterns(),performanceIssues:this.detectPerformanceIssues(),recommendations:this.generateRecommendations()}}findErrorPatterns(){const t=this.entries.filter(t=>"error"===t.level),e={};return t.forEach(t=>{let s="Unknown Error";if(t.args.length>0){const e=t.args[0];"string"==typeof e?s=e.replace(/\d+/g,"N").replace(/["'][^"']*["']/g,"STRING").replace(/\b\w+@\w+\.\w+/g,"EMAIL").replace(/https?:\/\/[^\s]+/g,"URL").substring(0,100):"object"==typeof e&&e.name&&(s=`${e.name}: ${e.message}`.substring(0,100))}e[s]||(e[s]=[]),e[s].push(t)}),Object.entries(e).sort(([,t],[,e])=>e.length-t.length).slice(0,10).map(([t,e])=>({pattern:t,count:e.length,examples:e.slice(0,3)}))}detectPerformanceIssues(){const t=[],e=this.entries.filter(t=>t.timestamp>Date.now()-6e4);e.length>100&&t.push({type:"Excessive Logging",severity:"medium",details:e.length+" console entries in the last minute may impact performance"});const s={};return this.entries.filter(t=>"error"===t.level).forEach(t=>{const e=JSON.stringify(t.args);s[e]=(s[e]||0)+1}),Object.entries(s).forEach(([e,s])=>{s>10&&t.push({type:"Repeated Error",severity:s>50?"high":"medium",details:`Same error occurred ${s} times`})}),this.entries.filter(t=>t.args.some(t=>"object"==typeof t&&null!==t&&!Array.isArray(t))).length>.5*this.entries.length&&t.push({type:"Object Logging",severity:"low",details:"High percentage of object logging may indicate memory leaks"}),t}generateRecommendations(){const t=[],e=this.exportData().stats;return e.errorCount>0&&t.push(`Found ${e.errorCount} console errors. Review error patterns and fix underlying issues.`),e.warningCount>2*e.errorCount&&t.push("High warning-to-error ratio suggests proactive error handling could prevent issues."),e.totalEntries>500&&t.push("Consider reducing console logging in production to improve performance."),e.levelCounts.debug&&e.levelCounts.debug>100&&t.push("Debug logs should be disabled in production environments."),0===t.length&&t.push("Console logging patterns look healthy."),t}}class k{constructor(t,e={}){this.data=[],this.config={radius:20,maxIntensity:100,gradient:{.4:"blue",.6:"cyan",.7:"lime",.8:"yellow",1:"red"},blur:15,minOpacity:0,maxOpacity:.6,...e},this.canvas=document.createElement("canvas"),this.canvas.style.position="absolute",this.canvas.style.top="0",this.canvas.style.left="0",this.canvas.style.pointerEvents="none",this.canvas.style.zIndex="9999",t.appendChild(this.canvas);const s=this.canvas.getContext("2d");if(!s)throw Error("Failed to get canvas context");this.ctx=s,this.resizeCanvas(),window.addEventListener("resize",()=>this.resizeCanvas())}resizeCanvas(){const t=this.canvas.parentElement.getBoundingClientRect();this.canvas.width=t.width,this.canvas.height=t.height,this.canvas.style.width=t.width+"px",this.canvas.style.height=t.height+"px"}addDataPoint(t,e,s,i){this.data.push({x:t,y:e,intensity:s,event_type:i,timestamp:Date.now()}),this.data.length>1e4&&(this.data=this.data.slice(-8e3))}generateFromEvents(t){this.data=[],t.forEach(t=>{var e,s,i,n,r,o;"click"===t.event_type&&(null===(e=t.data)||void 0===e?void 0:e.x)&&(null===(s=t.data)||void 0===s?void 0:s.y)?this.addDataPoint(t.data.x,t.data.y,10,"click"):"mousemove"===t.event_type&&(null===(i=t.data)||void 0===i?void 0:i.x)&&(null===(n=t.data)||void 0===n?void 0:n.y)?this.addDataPoint(t.data.x,t.data.y,2,"move"):"scroll"===t.event_type&&void 0!==(null===(r=t.data)||void 0===r?void 0:r.scrollX)&&void 0!==(null===(o=t.data)||void 0===o?void 0:o.scrollY)&&this.addDataPoint(t.data.scrollX||0,t.data.scrollY||0,5,"scroll")})}render(t){if(this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),0===this.data.length)return;const e=t?this.data.filter(e=>t.includes(e.event_type)):this.data,s=this.createIntensityMap(e),i=this.createGradient();this.renderHeatmap(s,i)}createIntensityMap(t){const e=document.createElement("canvas");e.width=this.canvas.width,e.height=this.canvas.height;const s=e.getContext("2d");return t.forEach(t=>{const e=this.config.radius,i=s.createRadialGradient(t.x,t.y,0,t.x,t.y,e);i.addColorStop(0,`rgba(0, 0, 0, ${Math.min(t.intensity/this.config.maxIntensity,1)})`),i.addColorStop(1,"rgba(0, 0, 0, 0)"),s.fillStyle=i,s.fillRect(t.x-e,t.y-e,2*e,2*e)}),s.filter=`blur(${this.config.blur}px)`,s.drawImage(e,0,0),s.getImageData(0,0,e.width,e.height)}createGradient(){const t=document.createElement("canvas");t.width=256,t.height=1;const e=t.getContext("2d"),s=e.createLinearGradient(0,0,256,0);return Object.entries(this.config.gradient).forEach(([t,e])=>{s.addColorStop(parseFloat(t),e)}),e.fillStyle=s,e.fillRect(0,0,256,1),e.getImageData(0,0,256,1)}renderHeatmap(t,e){const s=this.ctx.createImageData(t.width,t.height);for(let i=0;t.data.length>i;i+=4){const n=t.data[i+3];if(n>0){const t=4*Math.floor(n/255*255);s.data[i]=e.data[t],s.data[i+1]=e.data[t+1],s.data[i+2]=e.data[t+2],s.data[i+3]=Math.floor(n*this.config.maxOpacity)}}this.ctx.putImageData(s,0,0)}clear(){this.data=[],this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)}destroy(){this.clear(),this.canvas.parentElement&&this.canvas.parentElement.removeChild(this.canvas),window.removeEventListener("resize",()=>this.resizeCanvas())}exportData(){const t={};let e=1/0,s=-1/0,i=1/0,n=-1/0,r=1/0,o=-1/0;return this.data.forEach(a=>{t[a.event_type]=(t[a.event_type]||0)+1,e=Math.min(e,a.x),s=Math.max(s,a.x),i=Math.min(i,a.y),n=Math.max(n,a.y),r=Math.min(r,a.timestamp),o=Math.max(o,a.timestamp)}),{config:this.config,data:[...this.data],stats:{totalEvents:this.data.length,eventTypes:t,timeRange:{start:r,end:o},bounds:{minX:e,maxX:s,minY:i,maxY:n}}}}generateInsights(){return{hotSpots:this.findHotSpots(),clickPatterns:this.analyzeClickPatterns(),userBehavior:this.analyzeUserBehavior()}}findHotSpots(){const t=[],e=2*this.config.radius;return this.data.forEach(s=>{let i=!1;for(const n of t)if(e>=Math.sqrt(Math.pow(s.x-n.x,2)+Math.pow(s.y-n.y,2))){n.x=(n.x*n.count+s.x)/(n.count+1),n.y=(n.y*n.count+s.y)/(n.count+1),n.intensity+=s.intensity,n.count++,i=!0;break}i||t.push({x:s.x,y:s.y,intensity:s.intensity,count:1})}),t.filter(t=>t.count>=3).sort((t,e)=>e.intensity-t.intensity).slice(0,10).map(t=>({x:Math.round(t.x),y:Math.round(t.y),intensity:Math.round(t.intensity),radius:Math.min(e,5*t.count)}))}analyzeClickPatterns(){const t=this.data.filter(t=>"click"===t.event_type),e={};for(let s=0;t.length-1>s;s++){const i=t[s],n=t[s+1];if(5e3>n.timestamp-i.timestamp){const t=`(${Math.round(i.x)},${Math.round(i.y)}) -> (${Math.round(n.x)},${Math.round(n.y)})`;e[t]=(e[t]||0)+1}}return Object.entries(e).sort(([,t],[,e])=>e-t).slice(0,5).map(([t,e])=>({pattern:t,frequency:e}))}analyzeUserBehavior(){const t=this.data.filter(t=>"click"===t.event_type),e=this.data.filter(t=>"scroll"===t.event_type),s=[...this.data].sort((t,e)=>e.intensity-t.intensity),i=s.slice(0,Math.floor(.5*s.length)),n=Math.min(...i.map(t=>t.x)),r=Math.max(...i.map(t=>t.x)),o=Math.min(...i.map(t=>t.y)),a=Math.max(...i.map(t=>t.y)),h=e.length>0?Math.max(...e.map(t=>t.y))/this.canvas.height:0,c=Math.min(100,2*t.length+50*h+.1*this.data.filter(t=>"move"===t.event_type).length);return{mostActiveArea:{x:Math.round(n),y:Math.round(o),width:Math.round(r-n),height:Math.round(a-o)},averageClicksPerSession:Math.round(t.length),scrollDepth:Math.round(100*h)/100,engagementScore:Math.round(c)}}}class S{constructor(t,e){var s,i,n,r,o,a,h,c,d,u,l,p,v,w,m,f,y;if(this.heatmapGenerator=null,this.events=[],this.consoleLogs=[],this.networkRequests=new Map,this.isRecording=!1,this.originalConsole={},this.config=t,this.sessionId=e,this.startTime=Date.now(),this.domSerializer=new g(t),this.consoleRecorder=new b(e,{maxEntries:(null===(s=t.replay)||void 0===s?void 0:s.maxConsoleEntries)||1e3,captureStackTrace:!1!==(null===(i=t.replay)||void 0===i?void 0:i.captureStackTrace),serializeObjects:!1!==(null===(n=t.replay)||void 0===n?void 0:n.serializeObjects),maxObjectDepth:(null===(r=t.replay)||void 0===r?void 0:r.maxObjectDepth)||3,maxStringLength:(null===(o=t.replay)||void 0===o?void 0:o.maxStringLength)||1e4,ignoredLevels:(null===(a=t.replay)||void 0===a?void 0:a.ignoredConsoleLevels)||[]}),(null===(h=this.config.replay)||void 0===h?void 0:h.enabled)&&(this.setupReplay(),(null===(d=null===(c=this.config.replay)||void 0===c?void 0:c.heatmaps)||void 0===d?void 0:d.enabled)&&"undefined"!=typeof document)){const e=document.body||document.documentElement;e&&(this.heatmapGenerator=new k(e,{radius:(null===(l=null===(u=t.replay)||void 0===u?void 0:u.heatmaps)||void 0===l?void 0:l.radius)||20,maxIntensity:(null===(v=null===(p=t.replay)||void 0===p?void 0:p.heatmaps)||void 0===v?void 0:v.maxIntensity)||100,blur:(null===(m=null===(w=t.replay)||void 0===w?void 0:w.heatmaps)||void 0===m?void 0:m.blur)||15,maxOpacity:(null===(y=null===(f=t.replay)||void 0===f?void 0:f.heatmaps)||void 0===y?void 0:y.maxOpacity)||.6}))}}startRecording(){var t;!this.isRecording&&(null===(t=this.config.replay)||void 0===t?void 0:t.enabled)&&(this.isRecording=!0,this.takeFullSnapshot(),this.domSerializer.startObserving(this.handleDOMChange.bind(this)),this.consoleRecorder.start(),this.setupNetworkCapture(),this.setupInteractionTracking(),setInterval(()=>{this.isRecording&&this.takeFullSnapshot()},6e4))}stopRecording(){this.isRecording&&(this.isRecording=!1,this.domSerializer.stopObserving(),this.consoleRecorder.stop(),this.restoreOriginalNetwork(),this.heatmapGenerator&&(this.heatmapGenerator.destroy(),this.heatmapGenerator=null))}getReplayData(){const t=this.consoleRecorder.getEntries(),e=this.consoleRecorder.generateInsights();let s,i;return this.heatmapGenerator&&(s=this.heatmapGenerator.exportData().data,i=this.heatmapGenerator.generateInsights()),{events:[...this.events],console_logs:t,network_requests:Array.from(this.networkRequests.values()),heatmap_data:s,session_info:{session_id:this.sessionId,start_time:this.startTime,duration:Date.now()-this.startTime,page_url:window.location.href},analytics:{console_insights:e,heatmap_insights:i}}}clearReplayData(){this.events=[],this.consoleLogs=[],this.networkRequests.clear(),this.consoleRecorder.clear(),this.heatmapGenerator&&this.heatmapGenerator.clear()}setupReplay(){if("undefined"==typeof window)return;let t;document.addEventListener("visibilitychange",()=>{this.addCustomEvent("visibility_change",{hidden:document.hidden})}),window.addEventListener("focus",()=>{this.addCustomEvent("window_focus",{})}),window.addEventListener("blur",()=>{this.addCustomEvent("window_blur",{})}),window.addEventListener("resize",()=>{this.addCustomEvent("viewport_change",{width:window.innerWidth,height:window.innerHeight})}),window.addEventListener("scroll",()=>{clearTimeout(t),t=setTimeout(()=>{this.heatmapGenerator&&this.heatmapGenerator.addDataPoint(window.scrollX||0,window.scrollY||0,5,"scroll"),this.addCustomEvent("scroll",{x:window.scrollX,y:window.scrollY})},100)},{passive:!0})}takeFullSnapshot(){if(this.isRecording)try{const t=this.domSerializer.takeSnapshot();this.addEvent({type:"full_snapshot",timestamp:Date.now(),data:t})}catch(t){}}handleDOMChange(t){this.isRecording&&this.addEvent({type:"incremental_snapshot",timestamp:t.timestamp,data:{source:"mutation",...t}})}renderHeatmap(t){this.heatmapGenerator&&this.heatmapGenerator.render(t)}toggleHeatmap(t){this.heatmapGenerator&&(t?this.heatmapGenerator.render():this.heatmapGenerator.clear())}getHeatmapInsights(){var t;return(null===(t=this.heatmapGenerator)||void 0===t?void 0:t.generateInsights())||null}setupNetworkCapture(){if(void 0!==window.fetch&&(this.originalFetch=window.fetch,window.fetch=async(t,e)=>{const s=Date.now(),i=this.generateRequestId(),n=t instanceof Request?t.url:""+t,r=(null==e?void 0:e.method)||(t instanceof Request?t.method:"GET");this.isRecording&&this.networkRequests.set(i,{timestamp:s,id:i,method:r,url:n,requestHeaders:this.getRequestHeaders(e,t),requestBody:await this.serializeRequestBody(e,t)});try{const n=await this.originalFetch(t,e),r=Date.now()-s;if(this.isRecording){const t=this.networkRequests.get(i);if(t&&(t.status=n.status,t.duration=r,t.responseHeaders=this.getResponseHeaders(n),this.shouldCaptureResponseBody(n)))try{const e=n.clone();t.responseBody=await e.text()}catch(t){}}return n}catch(t){const e=Date.now()-s;if(this.isRecording){const t=this.networkRequests.get(i);t&&(t.duration=e,t.failed=!0)}throw t}}),"undefined"!=typeof XMLHttpRequest){this.originalXMLHttpRequest=XMLHttpRequest;const t=this;window.XMLHttpRequest=function(){const e=new t.originalXMLHttpRequest,s=t.generateRequestId();let i="GET",n="",r=0;const o=e.open,a=e.send;return e.open=function(t,e,...s){return i=t,n=""+e,o.call(this,t,e,...s)},e.send=function(e){return r=Date.now(),t.isRecording&&t.networkRequests.set(s,{timestamp:r,id:s,method:i,url:n,requestBody:e}),a.call(this,e)},e.addEventListener("loadend",()=>{const i=Date.now()-r;if(t.isRecording){const n=t.networkRequests.get(s);n&&(n.status=e.status,n.duration=i,n.failed=0===e.status||e.status>=400,t.shouldCaptureXHRResponse(e)&&(n.responseBody=e.responseText))}}),e}}}setupInteractionTracking(){["mousedown","mouseup","click","dblclick","mousemove"].forEach(t=>{document.addEventListener(t,e=>{if(this.isRecording&&("mousemove"!==t||.1>=Math.random())){if(this.heatmapGenerator){let s=1;"click"===t?s=10:"mousemove"===t?s=2:"mousedown"===t&&(s=5),this.heatmapGenerator.addDataPoint(e.clientX,e.clientY,s,"click"===t?"click":"move")}this.addEvent({type:"incremental_snapshot",timestamp:Date.now(),data:{source:"mouse",type:t,x:e.clientX,y:e.clientY,id:this.getElementId(e.target)}})}},{capture:!0,passive:!0})}),document.addEventListener("keydown",t=>{this.isRecording&&(this.shouldIgnoreKeystroke(t)||this.addEvent({type:"incremental_snapshot",timestamp:Date.now(),data:{source:"keyboard",type:"keydown",key:this.sanitizeKey(t.key),code:t.code,id:this.getElementId(t.target)}}))},{capture:!0,passive:!0})}addEvent(t){this.events.push(t),this.events.length>1e4&&(this.events=this.events.slice(-8e3))}addCustomEvent(t,e){this.addEvent({type:"custom",timestamp:Date.now(),data:{type:t,...e}})}serializeConsoleArgs(t){return t.map(t=>{try{return"object"==typeof t&&null!==t?JSON.parse(JSON.stringify(t)):t}catch(t){return"[Unserializable Object]"}})}generateRequestId(){return Date.now().toString(36)+Math.random().toString(36).substr(2)}getRequestHeaders(t,e){const s={};return(null==t?void 0:t.headers)&&(t.headers instanceof Headers?t.headers.forEach((t,e)=>{s[e]=t}):Array.isArray(t.headers)?t.headers.forEach(([t,e])=>{s[t]=e}):Object.assign(s,t.headers)),e instanceof Request&&e.headers.forEach((t,e)=>{s[e]=t}),s}getResponseHeaders(t){const e={};return t.headers.forEach((t,s)=>{e[s]=t}),e}async serializeRequestBody(t,e){let s=null==t?void 0:t.body;if(e instanceof Request&&!s)try{s=await e.clone().text()}catch(t){return null}if(!s)return null;if("string"==typeof s)return s.length>1e4?s.substring(0,1e4)+"...[truncated]":s;if(s instanceof FormData){const t={};return s.forEach((e,s)=>{t[s]=e instanceof File?`[File: ${e.name}]`:e}),t}return"[Binary Data]"}shouldCaptureResponseBody(t){const e=t.headers.get("content-type")||"",s=parseInt(t.headers.get("content-length")||"0");return e.includes("application/json")||e.includes("text/")||s>0&&1e5>s}shouldCaptureXHRResponse(t){const e=t.getResponseHeader("content-type")||"";return e.includes("application/json")||e.includes("text/")||t.responseText&&1e5>t.responseText.length}getElementId(t){return t?Math.random():void 0}shouldIgnoreKeystroke(t){const e=t.target;if(e&&e.tagName){if("input"===e.tagName.toLowerCase()&&"password"===e.type)return!0;if(e.hasAttribute("data-revi-ignore"))return!0}return!1}sanitizeKey(t){return 1===t.length&&/[a-zA-Z0-9]/.test(t)?"*":t}restoreOriginalNetwork(){this.originalFetch&&(window.fetch=this.originalFetch),this.originalXMLHttpRequest&&(window.XMLHttpRequest=this.originalXMLHttpRequest)}}class x{constructor(t){if(this.isInitialized=!1,this.config={apiUrl:process.env.REVI_API_URL||"https://api.revi.dev",environment:"production",debug:!1,sampleRate:1,sessionSampleRate:1,maxBreadcrumbs:50,privacy:{maskInputs:!0,maskPasswords:!0,maskCreditCards:!0},performance:{captureWebVitals:!0,captureResourceTiming:!1,captureNavigationTiming:!0},replay:{enabled:!0,maskAllInputs:!1,maskAllText:!1},...t},!this.config.apiKey)throw Error("Revi: API key is required");"undefined"!=typeof navigator&&[/bot/i,/spider/i,/crawl/i,/headless/i,/phantom/i,/selenium/i].some(t=>t.test(navigator.userAgent))||this.init()}init(){var t;if(!this.isInitialized)try{this.traceManager=new i,this.errorHandler=new n(this.config,this.traceManager),this.sessionManager=new r(this.config,this.traceManager),this.networkMonitor=new o(this.config,this.traceManager),this.performanceMonitor=new y(this.config),this.dataManager=new w(this.config),this.userJourneyTracker=new m(this.config),this.sessionReplayManager=new S(this.config,this.sessionManager.getSessionId()),this.samplingManager=new f(this.config),this.setupAdaptiveFlush(),(null===(t=this.config.replay)||void 0===t?void 0:t.enabled)&&this.sessionReplayManager.startRecording(),this.isInitialized=!0}catch(t){}}setupAdaptiveFlush(){let t=0,e=Date.now();const s=()=>{const i=Date.now(),n=i-e;let r=1e4;t>0&&(r=Math.max(3e3,1e4-1e3*t)),0===t&&n>15e3&&(r=Math.min(3e4,r+5e3)),r>n||(this.flush(),e=i,t=0),setTimeout(s,2e3)};s();const i=this.captureException.bind(this);this.captureException=(e,s={})=>(t++,i(e,s))}captureException(t,e={}){if(!this.isInitialized)return"";if("error"!==e.level&&e.level&&this.samplingManager.shouldSkipCapture("error"))return"";this.samplingManager.incrementErrorFrequency(),this.samplingManager.updateActivityLevel("high");const s=this.errorHandler.captureException(t,e);if(s){const i={id:s,timestamp:Date.now(),message:t.message,stack:t.stack,url:window.location.href,userId:this.config.userId,sessionId:this.sessionManager.getSessionId(),userAgent:navigator.userAgent,environment:this.config.environment,release:this.config.release,tags:e.tags,extra:e.extra,breadcrumbs:this.errorHandler.getBreadcrumbs(),level:e.level||"error"};this.dataManager.queueError(i),this.userJourneyTracker&&this.userJourneyTracker.trackError(t,{level:e.level,tags:e.tags,extra:e.extra})}return s}captureMessage(t,e={}){if(!this.isInitialized)return"";const s=this.errorHandler.captureMessage(t,e);if(s){const i={id:s,timestamp:Date.now(),message:t,url:window.location.href,userId:this.config.userId,sessionId:this.sessionManager.getSessionId(),userAgent:navigator.userAgent,environment:this.config.environment,release:this.config.release,tags:e.tags,extra:e.extra,breadcrumbs:this.errorHandler.getBreadcrumbs(),level:e.level||"info"};this.dataManager.queueError(i)}return s}addBreadcrumb(t){this.isInitialized&&this.errorHandler.addBreadcrumb({timestamp:Date.now(),message:t.message,category:t.category||"manual",level:t.level||"info",data:t.data})}setUserContext(t){this.isInitialized&&(this.config.userId=t.id,this.errorHandler.setUserContext(t),this.userJourneyTracker.setUserId(t.id||""),this.userJourneyTracker.startTracking(t.id))}setTags(t){this.isInitialized&&this.errorHandler.setTags(t)}setExtra(t){this.isInitialized&&this.errorHandler.setExtra(t)}getSessionId(){return this.isInitialized?this.sessionManager.getSessionId():""}endSession(){this.isInitialized&&(this.flush(),this.sessionManager.endSession())}mark(t){this.isInitialized&&this.performanceMonitor.mark(t)}measure(t,e,s){return this.isInitialized?this.performanceMonitor.measure(t,e,s):null}getWebVitals(){return this.isInitialized?this.performanceMonitor.getWebVitals():{}}startSessionReplay(){this.isInitialized&&this.sessionReplayManager&&this.sessionReplayManager.startRecording()}stopSessionReplay(){this.isInitialized&&this.sessionReplayManager&&this.sessionReplayManager.stopRecording()}getSessionReplayData(){return this.isInitialized&&this.sessionReplayManager?this.sessionReplayManager.getReplayData():null}flush(){if(!this.isInitialized)return;const t=this.sessionManager.flush(),e=this.networkMonitor.flush();e.forEach(t=>{t.sessionId=this.sessionManager.getSessionId()}),t.length>0&&this.dataManager.queueSessionEvents(t),e.length>0&&this.dataManager.queueNetworkEvents(e)}getCurrentTraceId(){var t;return null===(t=this.traceManager)||void 0===t?void 0:t.getCurrentTraceId()}getCurrentSpanId(){var t;return null===(t=this.traceManager)||void 0===t?void 0:t.getCurrentSpanId()}getTraceContext(){var t;return(null===(t=this.traceManager)||void 0===t?void 0:t.getTraceContext())||{}}startSpan(t){var e;return null===(e=this.traceManager)||void 0===e?void 0:e.startSpan(t)}finishSpan(t,e){var s;null===(s=this.traceManager)||void 0===s||s.finishSpan(t,e)}destroy(){this.isInitialized&&(this.flush(),this.networkMonitor&&this.networkMonitor.destroy(),this.dataManager&&this.dataManager.destroy(),this.sessionReplayManager&&this.sessionReplayManager.stopRecording(),this.userJourneyTracker&&this.userJourneyTracker.stopTracking(),this.traceManager&&this.traceManager.cleanupSpanData(),this.isInitialized=!1)}}t.DataManager=w,t.ErrorHandler=n,t.Monitor=x,t.NetworkMonitor=o,t.SessionManager=r,t.default=x,Object.defineProperty(t,"h",{value:!0})},"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).ReviMonitor={});
//# sourceMappingURL=revi-monitor.umd.js.map
