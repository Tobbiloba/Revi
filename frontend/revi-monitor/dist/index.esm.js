function e(){return"xxxx-xxxx-4xxx-yxxx-xxxx".replace(/[xy]/g,function(e){const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})}function t(e){return e.stack?e.stack.split("\n").map(e=>e.trim()).filter(e=>e.length>0).join("\n"):""}class s{constructor(e){this.breadcrumbs=[],this.userContext={},this.config=e,this.setupGlobalHandlers()}setupGlobalHandlers(){if("undefined"==typeof window)return;window.addEventListener("error",e=>{this.captureError({message:e.message,filename:e.filename,lineno:e.lineno,colno:e.colno,error:e.error})}),window.addEventListener("unhandledrejection",e=>{const s=e.reason;let i="Unhandled Promise Rejection",r="";s instanceof Error?(i=s.message,r=t(s)):i="string"==typeof s?s:JSON.stringify(s),this.captureError({message:i,stack:r,error:s})});const e=console.error;console.error=(...t)=>{this.addBreadcrumb({timestamp:Date.now(),message:t.join(" "),category:"console",level:"error"}),e.apply(console,t)};const s=console.warn;console.warn=(...e)=>{this.addBreadcrumb({timestamp:Date.now(),message:e.join(" "),category:"console",level:"warning"}),s.apply(console,e)}}captureError(s){var i,r;if(this.config.sampleRate&&Math.random()>this.config.sampleRate)return"";const n=e(),o={id:n,timestamp:Date.now(),message:s.message,stack:s.stack||(s.error?t(s.error):void 0),url:s.filename||window.location.href,lineno:s.lineno,colno:s.colno,filename:s.filename,userId:this.config.userId||this.userContext.id,sessionId:"",userAgent:navigator.userAgent,environment:this.config.environment,release:this.config.release,tags:s.tags,extra:s.extra,breadcrumbs:[...this.breadcrumbs],level:s.level||"error"};return(null===(r=(i=this.config).beforeSend)||void 0===r?void 0:r.call(i,o))||o?n:""}captureException(e,s={}){return this.captureError({message:e.message,stack:t(e),error:e,level:s.level,tags:s.tags,extra:s.extra})}captureMessage(e,t={}){return this.captureError({message:e,level:t.level||"info",tags:t.tags,extra:t.extra})}addBreadcrumb(e){this.breadcrumbs.push(e);const t=this.config.maxBreadcrumbs||50;this.breadcrumbs.length>t&&this.breadcrumbs.splice(0,this.breadcrumbs.length-t)}setUserContext(e){this.userContext={...this.userContext,...e}}setTags(e){}setExtra(e){}getBreadcrumbs(){return[...this.breadcrumbs]}clearBreadcrumbs(){this.breadcrumbs=[]}}class i{constructor(e){this.events=[],this.config=e,this.storage=function(){try{if("undefined"!=typeof window&&window.sessionStorage)return window.sessionStorage.setItem("test","test"),window.sessionStorage.removeItem("test"),window.sessionStorage}catch(e){}return null}(),this.sessionId=this.getOrCreateSessionId(),this.startTime=Date.now(),this.setupEventListeners(),this.trackPageLoad()}getOrCreateSessionId(){const t="revi_session_id";if(this.storage){const e=this.storage.getItem(t);if(e)return e}const s=e();return this.storage&&this.storage.setItem(t,s),s}getSessionId(){return this.sessionId}setupEventListeners(){if("undefined"==typeof window)return;let e,t;["click","input","change","submit","focus","blur"].forEach(e=>{document.addEventListener(e,t=>{this.captureEvent(e,this.serializeDOMEvent(t))},{capture:!0,passive:!0})}),window.addEventListener("popstate",()=>{this.captureEvent("navigation",{type:"popstate",url:window.location.href,timestamp:Date.now()})}),document.addEventListener("visibilitychange",()=>{this.captureEvent("visibility",{hidden:document.hidden,timestamp:Date.now()})}),window.addEventListener("scroll",()=>{clearTimeout(e),e=setTimeout(()=>{this.captureEvent("scroll",{x:window.scrollX,y:window.scrollY,timestamp:Date.now()})},100)},{passive:!0}),window.addEventListener("resize",()=>{clearTimeout(t),t=setTimeout(()=>{this.captureEvent("resize",{width:window.innerWidth,height:window.innerHeight,timestamp:Date.now()})},100)},{passive:!0}),window.addEventListener("beforeunload",()=>{this.captureEvent("beforeunload",{timestamp:Date.now(),duration:Date.now()-this.startTime}),this.flush()})}serializeDOMEvent(e){var t;const s=e.target;if(!s)return{};const i={type:e.type,timestamp:Date.now(),target:{tagName:s.tagName,id:s.id,className:s.className,textContent:this.shouldMaskText(s)?"[Masked]":null===(t=s.textContent)||void 0===t?void 0:t.slice(0,100)}};if("click"===e.type){const t=e;i.coordinates={x:t.clientX,y:t.clientY}}if("input"===e.type||"change"===e.type){const t=e.target;t&&void 0!==t.value&&(i.value=this.shouldMaskInput(t)?"[Masked]":t.value)}return i}shouldMaskInput(e){var t,s,i;if(!(null===(t=this.config.privacy)||void 0===t?void 0:t.maskInputs))return!1;if(["password","email","tel","credit-card-number"].includes(e.type))return!0;const r=(null===(s=e.name)||void 0===s?void 0:s.toLowerCase())||"",n=(null===(i=e.id)||void 0===i?void 0:i.toLowerCase())||"";return["password","email","phone","credit","card","ssn"].some(e=>r.includes(e)||n.includes(e))}shouldMaskText(e){var t,s;if(!(null===(t=this.config.replay)||void 0===t?void 0:t.maskAllText))return!1;if(null===(s=this.config.replay)||void 0===s?void 0:s.maskSelector)try{return e.matches(this.config.replay.maskSelector)}catch(e){return!1}return!1}trackPageLoad(){if("undefined"==typeof window)return;const e=()=>{this.captureEvent("page_load",{url:window.location.href,title:document.title,referrer:document.referrer,timestamp:Date.now(),loadTime:performance.now()})};"complete"===document.readyState?e():window.addEventListener("load",e)}captureEvent(e,t){var s,i;if(this.config.sessionSampleRate&&Math.random()>this.config.sessionSampleRate)return;const r={sessionId:this.sessionId,timestamp:Date.now(),type:e,data:t},n=(null===(i=(s=this.config).beforeSendSession)||void 0===i?void 0:i.call(s,r))||r;n&&(this.events.push(n),this.events.length>=100&&this.flush())}getEvents(){return[...this.events]}clearEvents(){this.events=[]}flush(){const e=this.getEvents();return this.clearEvents(),e}endSession(){this.captureEvent("session_end",{timestamp:Date.now(),duration:Date.now()-this.startTime}),this.storage&&this.storage.removeItem("revi_session_id")}}class r{constructor(e){this.events=[],this.config=e,this.originalFetch=window.fetch,this.originalXHROpen=XMLHttpRequest.prototype.open,this.originalXHRSend=XMLHttpRequest.prototype.send,this.setupInterceptors()}setupInterceptors(){"undefined"!=typeof window&&(this.interceptFetch(),this.interceptXHR())}interceptFetch(){window.fetch=async(...e)=>{var t,s,i,r;const n=Date.now(),o="string"==typeof e[0]?e[0]:e[0].url,a=((null===(t=e[1])||void 0===t?void 0:t.method)||"GET").toUpperCase();let d,u=0;(null===(s=e[1])||void 0===s?void 0:s.body)&&(d=this.serializeRequestBody(e[1].body),u=this.calculateBodySize(e[1].body));try{const t=await this.originalFetch.apply(window,e),s=Date.now();let r,l=0;if(this.shouldCaptureResponseBody(o)){const e=t.clone();try{r=await this.extractResponseBody(e),l=this.calculateResponseSize(r)}catch(e){}}return this.captureNetworkEvent({method:a,url:o,statusCode:t.status,responseTime:s-n,requestSize:u,responseSize:l,requestHeaders:this.extractHeaders(null===(i=e[1])||void 0===i?void 0:i.headers),responseHeaders:this.extractResponseHeaders(t.headers),requestBody:d,responseBody:r,timestamp:n}),t}catch(t){const s=Date.now();throw this.captureNetworkEvent({method:a,url:o,statusCode:0,responseTime:s-n,requestSize:u,responseSize:0,requestHeaders:this.extractHeaders(null===(r=e[1])||void 0===r?void 0:r.headers),requestBody:d,timestamp:n,error:t instanceof Error?t.message:String(t)}),t}}}interceptXHR(){const e=this;XMLHttpRequest.prototype.open=function(t,s,...i){return this._reviData={method:t.toUpperCase(),url:s,startTime:Date.now()},e.originalXHROpen.call(this,t,s,...i)},XMLHttpRequest.prototype.send=function(t){const s=this._reviData;return s?(s.requestBody=e.serializeRequestBody(t),s.requestSize=e.calculateBodySize(t),this.addEventListener("loadend",()=>{const t=Date.now();let i;try{""===this.responseType||"text"===this.responseType?i=this.responseText:"json"===this.responseType&&(i=this.response)}catch(e){}e.captureNetworkEvent({method:s.method,url:s.url,statusCode:this.status,responseTime:t-s.startTime,requestSize:s.requestSize,responseSize:e.calculateResponseSize(i),requestBody:s.requestBody,responseBody:e.shouldCaptureResponseBody(s.url)?i:void 0,timestamp:s.startTime})}),e.originalXHRSend.call(this,t)):e.originalXHRSend.call(this,t)}}serializeRequestBody(e){if(e){if("string"==typeof e)return e;if(e instanceof FormData){const t={};return e.forEach((e,s)=>{t[s]=e instanceof File?`[File: ${e.name}]`:e}),t}if(e instanceof URLSearchParams)return Object.fromEntries(e);try{return JSON.parse(JSON.stringify(e))}catch(e){return"[Unserializable]"}}}async extractResponseBody(e){const t=e.headers.get("content-type")||"";return t.includes("application/json")?await e.json():t.includes("text/")?await e.text():"[Binary Data]"}extractHeaders(e){if(!e)return{};if(e instanceof Headers){const t={};return e.forEach((e,s)=>{t[s]=e}),t}if(Array.isArray(e)){const t={};return e.forEach(([e,s])=>{t[e]=s}),t}return e}extractResponseHeaders(e){const t={};return e.forEach((e,s)=>{t[s]=e}),t}calculateBodySize(e){if(!e)return 0;if("string"==typeof e)return e.length;if(e instanceof ArrayBuffer)return e.byteLength;if(e instanceof Blob)return e.size;try{return JSON.stringify(e).length}catch(e){return 0}}calculateResponseSize(e){if(!e)return 0;try{return JSON.stringify(e).length}catch(e){return 0}}shouldCaptureResponseBody(e){return[/\/api\//,/\/graphql/].some(t=>t.test(e))}captureNetworkEvent(e){const t={sessionId:"",timestamp:e.timestamp,method:e.method,url:e.url,statusCode:e.statusCode,responseTime:e.responseTime,requestSize:e.requestSize,responseSize:e.responseSize,requestHeaders:e.requestHeaders,responseHeaders:e.responseHeaders,requestBody:e.requestBody,responseBody:e.responseBody};this.events.push(t),this.events.length>=50&&this.flush()}getEvents(){return[...this.events]}clearEvents(){this.events=[]}flush(){const e=this.getEvents();return this.clearEvents(),e}destroy(){this.originalFetch&&(window.fetch=this.originalFetch),XMLHttpRequest.prototype.open=this.originalXHROpen,XMLHttpRequest.prototype.send=this.originalXHRSend}}class n{constructor(e){var t,s,i;this.webVitals={},this.performanceEntries=[],this.config=e,(null===(t=this.config.performance)||void 0===t?void 0:t.captureWebVitals)&&this.setupWebVitals(),(null===(s=this.config.performance)||void 0===s?void 0:s.captureResourceTiming)&&this.setupResourceTiming(),(null===(i=this.config.performance)||void 0===i?void 0:i.captureNavigationTiming)&&this.setupNavigationTiming()}setupWebVitals(){if("undefined"!=typeof window&&"PerformanceObserver"in window){try{new PerformanceObserver(e=>{const t=e.getEntries(),s=t[t.length-1];this.webVitals.lcp=s.startTime}).observe({entryTypes:["largest-contentful-paint"]})}catch(e){}try{new PerformanceObserver(e=>{e.getEntries().forEach(e=>{this.webVitals.fid=e.processingStart-e.startTime})}).observe({entryTypes:["first-input"]})}catch(e){}try{let e=0;new PerformanceObserver(t=>{t.getEntries().forEach(t=>{t.hadRecentInput||(e+=t.value,this.webVitals.cls=e)})}).observe({entryTypes:["layout-shift"]})}catch(e){}try{new PerformanceObserver(e=>{e.getEntries().forEach(e=>{"first-contentful-paint"===e.name&&(this.webVitals.fcp=e.startTime)})}).observe({entryTypes:["paint"]})}catch(e){}this.calculateTTFB()}}calculateTTFB(){if("undefined"!=typeof window&&window.performance)try{const e=performance.getEntriesByType("navigation")[0];e&&(this.webVitals.ttfb=e.responseStart-e.requestStart)}catch(e){}}setupResourceTiming(){if("undefined"!=typeof window&&window.performance)try{new PerformanceObserver(e=>{e.getEntries().forEach(e=>{this.performanceEntries.push({name:e.name,entryType:e.entryType,startTime:e.startTime,duration:e.duration,transferSize:e.transferSize,encodedBodySize:e.encodedBodySize,decodedBodySize:e.decodedBodySize})})}).observe({entryTypes:["resource"]})}catch(e){}}setupNavigationTiming(){"undefined"!=typeof window&&window.performance&&window.addEventListener("load",()=>{try{const e=performance.getEntriesByType("navigation")[0];e&&this.performanceEntries.push({name:"navigation",entryType:"navigation",startTime:e.startTime,duration:e.duration,domContentLoadedEventEnd:e.domContentLoadedEventEnd,domContentLoadedEventStart:e.domContentLoadedEventStart,loadEventEnd:e.loadEventEnd,loadEventStart:e.loadEventStart,domComplete:e.domComplete,domInteractive:e.domInteractive})}catch(e){}})}getWebVitals(){return{...this.webVitals}}getPerformanceEntries(){return[...this.performanceEntries]}clearPerformanceEntries(){this.performanceEntries=[]}mark(e){if("undefined"!=typeof window&&window.performance&&window.performance.mark)try{performance.mark(e)}catch(e){}}measure(e,t,s){if("undefined"==typeof window||!window.performance||!window.performance.measure)return null;try{performance.measure(e,t,s);const i=performance.getEntriesByName(e,"measure")[0];return i?i.duration:null}catch(e){return null}}}class o{constructor(e){this.uploadQueue={errors:[],sessionEvents:[],networkEvents:[]},this.uploadTimer=null,this.isUploading=!1,this.config=e,this.storage=function(){try{if("undefined"!=typeof window&&window.localStorage)return window.localStorage.setItem("test","test"),window.localStorage.removeItem("test"),window.localStorage}catch(e){}return null}(),this.loadQueueFromStorage(),this.startUploadTimer(),this.setupBeforeUnloadHandler()}loadQueueFromStorage(){if(this.storage)try{const e=this.storage.getItem("revi_upload_queue");e&&(this.uploadQueue=JSON.parse(e))}catch(e){}}saveQueueToStorage(){if(this.storage)try{this.storage.setItem("revi_upload_queue",JSON.stringify(this.uploadQueue))}catch(e){this.clearQueue()}}startUploadTimer(){this.uploadTimer=setInterval(()=>{!this.isUploading&&this.hasQueuedData()&&this.uploadData()},5e3)}setupBeforeUnloadHandler(){"undefined"!=typeof window&&window.addEventListener("beforeunload",()=>{this.hasQueuedData()&&this.uploadDataSync()})}queueError(e){this.uploadQueue.errors.push(e),this.saveQueueToStorage()}queueSessionEvents(e){this.uploadQueue.sessionEvents.push(...e),this.saveQueueToStorage()}queueNetworkEvents(e){this.uploadQueue.networkEvents.push(...e),this.saveQueueToStorage()}hasQueuedData(){return this.uploadQueue.errors.length>0||this.uploadQueue.sessionEvents.length>0||this.uploadQueue.networkEvents.length>0}async uploadData(){if(this.isUploading||!this.hasQueuedData())return;this.isUploading=!0;const e=this.config.apiUrl||"https://api.revi.dev";try{this.uploadQueue.errors.length>0&&(await this.uploadErrors(e,this.uploadQueue.errors),this.uploadQueue.errors=[]),this.uploadQueue.sessionEvents.length>0&&(await this.uploadSessionEvents(e,this.uploadQueue.sessionEvents),this.uploadQueue.sessionEvents=[]),this.uploadQueue.networkEvents.length>0&&(await this.uploadNetworkEvents(e,this.uploadQueue.networkEvents),this.uploadQueue.networkEvents=[]),this.saveQueueToStorage()}catch(e){this.config.debug&&console.error("Revi: Failed to upload data",e)}finally{this.isUploading=!1}}uploadDataSync(){var e;if(!this.hasQueuedData())return;const t=this.config.apiUrl||"https://api.revi.dev";if(navigator.sendBeacon){if(this.uploadQueue.errors.length>0){const e=JSON.stringify({errors:this.uploadQueue.errors});navigator.sendBeacon(`${t}/api/capture/error`,e)}if(this.uploadQueue.sessionEvents.length>0){const s=JSON.stringify({session_id:null===(e=this.uploadQueue.sessionEvents[0])||void 0===e?void 0:e.sessionId,events:this.uploadQueue.sessionEvents.map(e=>({event_type:e.type,data:e.data,timestamp:new Date(e.timestamp)}))});navigator.sendBeacon(`${t}/api/capture/session-event`,s)}if(this.uploadQueue.networkEvents.length>0){const e=JSON.stringify({events:this.uploadQueue.networkEvents});navigator.sendBeacon(`${t}/api/capture/network-event`,e)}}}async uploadErrors(e,t){const s=await fetch(`${e}/api/capture/error`,{method:"POST",headers:{"Content-Type":"application/json","X-API-Key":this.config.apiKey},body:JSON.stringify({errors:t.map(e=>({message:e.message,stack_trace:e.stack,url:e.url,user_agent:e.userAgent,session_id:e.sessionId,metadata:{id:e.id,userId:e.userId,environment:e.environment,release:e.release,tags:e.tags,extra:e.extra,breadcrumbs:e.breadcrumbs,level:e.level,lineno:e.lineno,colno:e.colno,filename:e.filename}}))})});if(!s.ok)throw new Error(`Upload failed: ${s.status}`)}async uploadSessionEvents(e,t){if(0===t.length)return;const s=t[0].sessionId,i=await fetch(`${e}/api/capture/session-event`,{method:"POST",headers:{"Content-Type":"application/json","X-API-Key":this.config.apiKey},body:JSON.stringify({session_id:s,events:t.map(e=>({event_type:e.type,data:e.data,timestamp:new Date(e.timestamp)}))})});if(!i.ok)throw new Error(`Upload failed: ${i.status}`)}async uploadNetworkEvents(e,t){const s=t.map(e=>fetch(`${this.config.apiUrl}/api/capture/network-event`,{method:"POST",headers:{"Content-Type":"application/json","X-API-Key":this.config.apiKey},body:JSON.stringify({session_id:e.sessionId,events:[{method:e.method,url:e.url,status_code:e.statusCode,response_time:e.responseTime,timestamp:new Date(e.timestamp),request_data:{headers:e.requestHeaders,body:e.requestBody,size:e.requestSize},response_data:{headers:e.responseHeaders,body:e.responseBody,size:e.responseSize}}]})})),i=(await Promise.allSettled(s)).filter(e=>"rejected"===e.status);if(i.length>0)throw new Error(`${i.length} network event uploads failed`)}clearQueue(){this.uploadQueue={errors:[],sessionEvents:[],networkEvents:[]},this.storage&&this.storage.removeItem("revi_upload_queue")}destroy(){this.uploadTimer&&(clearInterval(this.uploadTimer),this.uploadTimer=null),this.hasQueuedData()&&this.uploadDataSync()}}class a{constructor(e){if(this.isInitialized=!1,this.config={apiUrl:"http://localhost:4000",environment:"production",debug:!1,sampleRate:1,sessionSampleRate:1,maxBreadcrumbs:50,privacy:{maskInputs:!0,maskPasswords:!0,maskCreditCards:!0},performance:{captureWebVitals:!0,captureResourceTiming:!1,captureNavigationTiming:!0},replay:{enabled:!0,maskAllInputs:!1,maskAllText:!1},...e},!this.config.apiKey)throw new Error("Revi: API key is required");"undefined"!=typeof navigator&&[/bot/i,/spider/i,/crawl/i,/headless/i,/phantom/i,/selenium/i].some(e=>e.test(navigator.userAgent))?this.config.debug&&console.log("Revi: Bot detected, skipping initialization"):this.init()}init(){if(!this.isInitialized)try{this.errorHandler=new s(this.config),this.sessionManager=new i(this.config),this.networkMonitor=new r(this.config),this.performanceMonitor=new n(this.config),this.dataManager=new o(this.config),this.setupPeriodicFlush(),this.isInitialized=!0,this.config.debug&&console.log("Revi: Initialized successfully")}catch(e){this.config.debug&&console.error("Revi: Initialization failed",e)}}setupPeriodicFlush(){setInterval(()=>{this.flush()},1e4)}captureException(e,t={}){if(!this.isInitialized)return"";const s=this.errorHandler.captureException(e,t);if(s){const i={id:s,timestamp:Date.now(),message:e.message,stack:e.stack,url:window.location.href,userId:this.config.userId,sessionId:this.sessionManager.getSessionId(),userAgent:navigator.userAgent,environment:this.config.environment,release:this.config.release,tags:t.tags,extra:t.extra,breadcrumbs:this.errorHandler.getBreadcrumbs(),level:t.level||"error"};this.dataManager.queueError(i)}return s}captureMessage(e,t={}){if(!this.isInitialized)return"";const s=this.errorHandler.captureMessage(e,t);if(s){const i={id:s,timestamp:Date.now(),message:e,url:window.location.href,userId:this.config.userId,sessionId:this.sessionManager.getSessionId(),userAgent:navigator.userAgent,environment:this.config.environment,release:this.config.release,tags:t.tags,extra:t.extra,breadcrumbs:this.errorHandler.getBreadcrumbs(),level:t.level||"info"};this.dataManager.queueError(i)}return s}addBreadcrumb(e){this.isInitialized&&this.errorHandler.addBreadcrumb({timestamp:Date.now(),message:e.message,category:e.category||"manual",level:e.level||"info",data:e.data})}setUserContext(e){this.isInitialized&&(this.config.userId=e.id,this.errorHandler.setUserContext(e))}setTags(e){this.isInitialized&&this.errorHandler.setTags(e)}setExtra(e){this.isInitialized&&this.errorHandler.setExtra(e)}getSessionId(){return this.isInitialized?this.sessionManager.getSessionId():""}endSession(){this.isInitialized&&(this.flush(),this.sessionManager.endSession())}mark(e){this.isInitialized&&this.performanceMonitor.mark(e)}measure(e,t,s){return this.isInitialized?this.performanceMonitor.measure(e,t,s):null}getWebVitals(){return this.isInitialized?this.performanceMonitor.getWebVitals():{}}flush(){if(!this.isInitialized)return;const e=this.sessionManager.flush(),t=this.networkMonitor.flush();t.forEach(e=>{e.sessionId=this.sessionManager.getSessionId()}),e.length>0&&this.dataManager.queueSessionEvents(e),t.length>0&&this.dataManager.queueNetworkEvents(t)}destroy(){this.isInitialized&&(this.flush(),this.networkMonitor&&this.networkMonitor.destroy(),this.dataManager&&this.dataManager.destroy(),this.isInitialized=!1)}}if("undefined"!=typeof window&&window.Revi){const e=window.Revi;if(e.apiKey){const{Monitor:t}=require("./monitor");window.Revi=new t(e)}}export{a as Monitor,a as default};
//# sourceMappingURL=index.esm.js.map
