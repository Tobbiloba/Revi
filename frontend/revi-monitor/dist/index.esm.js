function t(){return"xxxx-xxxx-4xxx-yxxx-xxxx".replace(/[xy]/g,function(t){const e=16*Math.random()|0;return("x"===t?e:3&e|8).toString(16)})}function e(t){return t.stack?t.stack.split("\n").map(t=>t.trim()).filter(t=>t.length>0).join("\n"):""}class s{constructor(){this.spanCounter=0,this.spanData=new Map,this.generateNewTrace()}generateNewTrace(){return this.currentTraceId=this.generateTraceId(),this.currentSpanId=void 0,this.spanCounter=0,this.currentTraceId}startSpan(t){const e=this.currentSpanId;return this.currentSpanId=this.generateSpanId(),this.spanCounter++,t&&this.setSpanData(t,{parentSpanId:e,operationName:t,startTime:Date.now()}),this.currentSpanId}finishSpan(t,e){t&&this.currentSpanId===t&&e&&this.setSpanData(t,{...this.getSpanData(t),...e,endTime:Date.now()})}getCurrentTraceId(){return this.currentTraceId}getCurrentSpanId(){return this.currentSpanId}getTraceContext(){return{traceId:this.currentTraceId,spanId:this.currentSpanId,parentSpanId:this.getParentSpanId()}}extractTraceFromHeaders(t){var e,s,i,r;return{traceId:t["x-trace-id"]||(null===(e=t.traceparent)||void 0===e?void 0:e.split("-")[1])||t["b3-traceid"]||(null===(s=t["uber-trace-id"])||void 0===s?void 0:s.split(":")[0]),spanId:t["x-span-id"]||(null===(i=t.traceparent)||void 0===i?void 0:i.split("-")[2])||t["b3-spanid"]||(null===(r=t["uber-trace-id"])||void 0===r?void 0:r.split(":")[1])}}injectTraceHeaders(){if(!this.currentTraceId)return{};const t={};return t["x-trace-id"]=this.currentTraceId,this.currentSpanId&&(t["x-span-id"]=this.currentSpanId,t["x-parent-span-id"]=this.getParentSpanId()||""),this.currentSpanId&&(t.traceparent=`00-${this.currentTraceId}-${this.currentSpanId}-01`),t}correlateWithBackendTrace(t,e){t&&(this.currentTraceId=t),e&&(this.currentSpanId=e)}generateTraceId(){return this.generateRandomHex(32)}generateSpanId(){return this.generateRandomHex(16)}generateRandomHex(t){const e=new Uint8Array(t/2);if("undefined"!=typeof crypto&&crypto.getRandomValues)crypto.getRandomValues(e);else for(let t=0;e.length>t;t++)e[t]=Math.floor(256*Math.random());return Array.from(e,t=>t.toString(16).padStart(2,"0")).join("")}getParentSpanId(){var t;return null===(t=this.spanData.get(this.currentSpanId||""))||void 0===t?void 0:t.parentSpanId}setSpanData(t,e){this.spanData.set(t,e)}getSpanData(t){return this.spanData.get(t)||{}}cleanupSpanData(){const t=Date.now()-3e5;for(const[e,s]of this.spanData.entries())s.endTime&&t>s.endTime&&this.spanData.delete(e)}}class i{constructor(t,e){this.breadcrumbs=[],this.userContext={},this.config=t,this.traceManager=e||new s,this.setupGlobalHandlers()}setupGlobalHandlers(){if("undefined"==typeof window)return;window.addEventListener("error",t=>{this.captureError({message:t.message,filename:t.filename,lineno:t.lineno,colno:t.colno,error:t.error})}),window.addEventListener("unhandledrejection",t=>{const s=t.reason;let i="Unhandled Promise Rejection",r="";s instanceof Error?(i=s.message,r=e(s)):i="string"==typeof s?s:JSON.stringify(s),this.captureError({message:i,stack:r,error:s})});const t=console.error;console.error=(...e)=>{this.addBreadcrumb({timestamp:Date.now(),message:e.join(" "),category:"console",level:"error"}),t.apply(console,e)};const s=console.warn;console.warn=(...t)=>{this.addBreadcrumb({timestamp:Date.now(),message:t.join(" "),category:"console",level:"warning"}),s.apply(console,t)}}captureError(s){var i,r;if(this.config.sampleRate&&Math.random()>this.config.sampleRate)return"";const n=t(),a=this.traceManager.startSpan("error:"+s.message),o=this.traceManager.getTraceContext(),h={id:n,timestamp:Date.now(),message:s.message,stack:s.stack||(s.error?e(s.error):void 0),url:s.filename||window.location.href,lineno:s.lineno,colno:s.colno,filename:s.filename,userId:this.config.userId||this.userContext.id,sessionId:"",userAgent:navigator.userAgent,environment:this.config.environment,release:this.config.release,tags:s.tags,extra:s.extra,breadcrumbs:[...this.breadcrumbs],level:s.level||"error",traceId:o.traceId,spanId:a,parentSpanId:o.parentSpanId};return(null===(r=(i=this.config).beforeSend)||void 0===r?void 0:r.call(i,h))||h?n:""}captureException(t,s={}){return this.captureError({message:t.message,stack:e(t),error:t,level:s.level,tags:s.tags,extra:s.extra})}captureMessage(t,e={}){return this.captureError({message:t,level:e.level||"info",tags:e.tags,extra:e.extra})}addBreadcrumb(t){this.breadcrumbs.push(t);const e=this.config.maxBreadcrumbs||50;this.breadcrumbs.length>e&&this.breadcrumbs.splice(0,this.breadcrumbs.length-e)}setUserContext(t){this.userContext={...this.userContext,...t}}setTags(t){}setExtra(t){}getBreadcrumbs(){return[...this.breadcrumbs]}clearBreadcrumbs(){this.breadcrumbs=[]}}class r{constructor(t,e){this.events=[],this.config=t,this.traceManager=e,this.storage=function(){try{if("undefined"!=typeof window&&window.sessionStorage)return window.sessionStorage.setItem("test","test"),window.sessionStorage.removeItem("test"),window.sessionStorage}catch(t){}return null}(),this.sessionId=this.getOrCreateSessionId(),this.startTime=Date.now(),this.setupEventListeners(),this.trackPageLoad()}getOrCreateSessionId(){const e="revi_session_id";if(this.storage){const t=this.storage.getItem(e);if(t)return t}const s=t();return this.storage&&this.storage.setItem(e,s),s}getSessionId(){return this.sessionId}setupEventListeners(){if("undefined"==typeof window)return;let t,e;["click","input","change","submit","focus","blur"].forEach(t=>{document.addEventListener(t,e=>{this.captureEvent(t,this.serializeDOMEvent(e))},{capture:!0,passive:!0})}),window.addEventListener("popstate",()=>{this.captureEvent("navigation",{type:"popstate",url:window.location.href,timestamp:Date.now()})}),document.addEventListener("visibilitychange",()=>{this.captureEvent("visibility",{hidden:document.hidden,timestamp:Date.now()})}),window.addEventListener("scroll",()=>{clearTimeout(t),t=setTimeout(()=>{this.captureEvent("scroll",{x:window.scrollX,y:window.scrollY,timestamp:Date.now()})},100)},{passive:!0}),window.addEventListener("resize",()=>{clearTimeout(e),e=setTimeout(()=>{this.captureEvent("resize",{width:window.innerWidth,height:window.innerHeight,timestamp:Date.now()})},100)},{passive:!0}),window.addEventListener("beforeunload",()=>{this.captureEvent("beforeunload",{timestamp:Date.now(),duration:Date.now()-this.startTime}),this.flush()})}serializeDOMEvent(t){var e;const s=t.target;if(!s)return{};const i={type:t.type,timestamp:Date.now(),target:{tagName:s.tagName,id:s.id,className:s.className,textContent:this.shouldMaskText(s)?"[Masked]":null===(e=s.textContent)||void 0===e?void 0:e.slice(0,100)}};if("click"===t.type&&(i.coordinates={x:t.clientX,y:t.clientY}),"input"===t.type||"change"===t.type){const e=t.target;e&&void 0!==e.value&&(i.value=this.shouldMaskInput(e)?"[Masked]":e.value)}return i}shouldMaskInput(t){var e,s,i;if(!(null===(e=this.config.privacy)||void 0===e?void 0:e.maskInputs))return!1;if(["password","email","tel","credit-card-number"].includes(t.type))return!0;const r=(null===(s=t.name)||void 0===s?void 0:s.toLowerCase())||"",n=(null===(i=t.id)||void 0===i?void 0:i.toLowerCase())||"";return["password","email","phone","credit","card","ssn"].some(t=>r.includes(t)||n.includes(t))}shouldMaskText(t){var e,s;if(!(null===(e=this.config.replay)||void 0===e?void 0:e.maskAllText))return!1;if(null===(s=this.config.replay)||void 0===s?void 0:s.maskSelector)try{return t.matches(this.config.replay.maskSelector)}catch(t){return!1}return!1}trackPageLoad(){if("undefined"==typeof window)return;const t=()=>{this.captureEvent("page_load",{url:window.location.href,title:document.title,referrer:document.referrer,timestamp:Date.now(),loadTime:performance.now()})};"complete"===document.readyState?t():window.addEventListener("load",t)}captureEvent(t,e){var s,i,r,n;if(this.config.sessionSampleRate&&Math.random()>this.config.sessionSampleRate)return;const a=null===(s=this.traceManager)||void 0===s?void 0:s.getTraceContext(),o=null===(i=this.traceManager)||void 0===i?void 0:i.startSpan("session:"+t),h={sessionId:this.sessionId,timestamp:Date.now(),type:t,data:e,traceId:null==a?void 0:a.traceId,spanId:o},c=(null===(n=(r=this.config).beforeSendSession)||void 0===n?void 0:n.call(r,h))||h;c&&(this.events.push(c),100>this.events.length||this.flush())}getEvents(){return[...this.events]}clearEvents(){this.events=[]}flush(){const t=this.getEvents();return this.clearEvents(),t}endSession(){this.captureEvent("session_end",{timestamp:Date.now(),duration:Date.now()-this.startTime}),this.storage&&this.storage.removeItem("revi_session_id")}}class n{constructor(t,e){this.events=[],this.config=t,this.traceManager=e||new s,this.originalFetch=window.fetch,this.originalXHROpen=XMLHttpRequest.prototype.open,this.originalXHRSend=XMLHttpRequest.prototype.send,this.setupInterceptors()}setupInterceptors(){"undefined"!=typeof window&&(this.interceptFetch(),this.interceptXHR())}interceptFetch(){window.fetch=async(...t)=>{var e,s,i;const r=Date.now(),n="string"==typeof t[0]?t[0]:t[0].url,a=((null===(e=t[1])||void 0===e?void 0:e.method)||"GET").toUpperCase();if(!this.shouldMonitorRequest(n))return await this.originalFetch.apply(window,t);const o=this.traceManager.startSpan(`http:${a} ${n}`),h=this.traceManager.injectTraceHeaders(),c={...(null===(s=t[1])||void 0===s?void 0:s.headers)||{},...h},u=[t[0],{...t[1],headers:c}];let l,d=0;(null===(i=t[1])||void 0===i?void 0:i.body)&&(l=this.serializeRequestBody(t[1].body),d=this.calculateBodySize(t[1].body));try{const t=await this.originalFetch.apply(window,u),e=Date.now();let s,i=0;if(this.shouldCaptureResponseBody(n)){const e=t.clone();try{s=await this.extractResponseBody(e),i=this.calculateResponseSize(s)}catch(t){}}const h=this.traceManager.extractTraceFromHeaders(this.extractResponseHeaders(t.headers));h.traceId&&this.traceManager.correlateWithBackendTrace(h.traceId,h.spanId),this.traceManager.finishSpan(o,{statusCode:t.status,responseTime:e-r});const p=this.traceManager.getTraceContext();return this.captureNetworkEvent({method:a,url:n,statusCode:t.status,responseTime:e-r,requestSize:d,responseSize:i,requestHeaders:this.extractHeaders(c),responseHeaders:this.extractResponseHeaders(t.headers),requestBody:l,responseBody:s,timestamp:r,traceId:p.traceId,spanId:o,parentSpanId:p.parentSpanId}),t}catch(t){const e=Date.now();this.traceManager.finishSpan(o,{statusCode:0,responseTime:e-r,error:t instanceof Error?t.message:t+""});const s=this.traceManager.getTraceContext();throw this.captureNetworkEvent({method:a,url:n,statusCode:0,responseTime:e-r,requestSize:d,responseSize:0,requestHeaders:this.extractHeaders(c),requestBody:l,timestamp:r,traceId:s.traceId,spanId:o,parentSpanId:s.parentSpanId}),t}}}interceptXHR(){const t=this;XMLHttpRequest.prototype.open=function(e,s,...i){return this.t={method:e.toUpperCase(),url:s,startTime:Date.now(),shouldMonitor:t.shouldMonitorRequest(s)},t.originalXHROpen.call(this,e,s,...i)},XMLHttpRequest.prototype.send=function(e){const s=this.t;return s&&s.shouldMonitor?(s.requestBody=t.serializeRequestBody(e),s.requestSize=t.calculateBodySize(e),this.addEventListener("loadend",()=>{const e=Date.now();let i;try{""===this.responseType||"text"===this.responseType?i=this.responseText:"json"===this.responseType&&(i=this.response)}catch(t){}t.captureNetworkEvent({method:s.method,url:s.url,statusCode:this.status,responseTime:e-s.startTime,requestSize:s.requestSize,responseSize:t.calculateResponseSize(i),requestBody:s.requestBody,responseBody:t.shouldCaptureResponseBody(s.url)?i:void 0,timestamp:s.startTime})}),t.originalXHRSend.call(this,e)):t.originalXHRSend.call(this,e)}}serializeRequestBody(t){if(t){if("string"==typeof t)return t;if(t instanceof FormData){const e={};return t.forEach((t,s)=>{e[s]=t instanceof File?`[File: ${t.name}]`:t}),e}if(t instanceof URLSearchParams)return Object.fromEntries(t);try{return JSON.parse(JSON.stringify(t))}catch(t){return"[Unserializable]"}}}async extractResponseBody(t){const e=t.headers.get("content-type")||"";return e.includes("application/json")?await t.json():e.includes("text/")?await t.text():"[Binary Data]"}extractHeaders(t){if(!t)return{};if(t instanceof Headers){const e={};return t.forEach((t,s)=>{e[s]=t}),e}if(Array.isArray(t)){const e={};return t.forEach(([t,s])=>{e[t]=s}),e}return t}extractResponseHeaders(t){const e={};return t.forEach((t,s)=>{e[s]=t}),e}calculateBodySize(t){if(!t)return 0;if("string"==typeof t)return t.length;if(t instanceof ArrayBuffer)return t.byteLength;if(t instanceof Blob)return t.size;try{return JSON.stringify(t).length}catch(t){return 0}}calculateResponseSize(t){if(!t)return 0;try{return JSON.stringify(t).length}catch(t){return 0}}shouldCaptureResponseBody(t){return[/\/api\//,/\/graphql/].some(e=>e.test(t))}shouldMonitorRequest(t){var e,s;const i=(this.config.apiUrl||"https://api.revi.dev").replace(/\/$/,"");return!t.replace(/\/$/,"").startsWith(i)&&(!(this.config.developmentHosts||[/^https?:\/\/localhost:\d+/,/^https?:\/\/127\.0\.0\.1:\d+/,/^https?:\/\/0\.0\.0\.0:\d+/,/^https?:\/\/.*\.local:\d+/]).find(e=>e.test(t))&&(![/\/api\/capture\//,/\/api\/errors/,/\/api\/session/,/\/api\/projects/,/\/api\/database/,/\/api\/analytics/,/\/health$/].find(e=>e.test(t))&&((!this.config.excludeUrls||!this.config.excludeUrls.some(e=>e.test(t)))&&((!(null===(e=this.config.privacy)||void 0===e?void 0:e.denyUrls)||!this.config.privacy.denyUrls.some(e=>RegExp(e).test(t)))&&(!(null===(s=this.config.privacy)||void 0===s?void 0:s.allowUrls)||this.config.privacy.allowUrls.some(e=>RegExp(e).test(t)))))))}captureNetworkEvent(t){this.events.push({sessionId:"",timestamp:t.timestamp,method:t.method,url:t.url,statusCode:t.statusCode,responseTime:t.responseTime,requestSize:t.requestSize,responseSize:t.responseSize,requestHeaders:t.requestHeaders,responseHeaders:t.responseHeaders,requestBody:t.requestBody,responseBody:t.responseBody}),50>this.events.length||this.flush()}getEvents(){return[...this.events]}clearEvents(){this.events=[]}flush(){const t=this.getEvents();return this.clearEvents(),t}destroy(){this.originalFetch&&(window.fetch=this.originalFetch),XMLHttpRequest.prototype.open=this.originalXHROpen,XMLHttpRequest.prototype.send=this.originalXHRSend}}class a{constructor(){this.db=null,this.dbName="revi-storage",this.version=1,this.storeName="queue",this.maxQueueSize=1e3,this.maxAge=6048e5}async initialize(){if("undefined"==typeof window||!window.indexedDB)throw Error("IndexedDB not supported");return new Promise((t,e)=>{const s=indexedDB.open(this.dbName,this.version);s.onerror=()=>{e(Error("Failed to open IndexedDB"))},s.onsuccess=()=>{this.db=s.result,t()},s.onupgradeneeded=t=>{const e=t.target.result;if(!e.objectStoreNames.contains(this.storeName)){const t=e.createObjectStore(this.storeName,{keyPath:"id"});t.createIndex("timestamp","timestamp",{unique:!1}),t.createIndex("type","type",{unique:!1})}}})}async store(t,e){this.db||await this.initialize(),await this.cleanupExpiredItems();const s=await this.getQueueSize();this.maxQueueSize>s||await this.removeOldestItems(100);const i={id:this.generateId(),type:t,data:await this.compress(e),timestamp:Date.now(),compressed:!0};return new Promise((t,e)=>{if(!this.db)return void e(Error("Database not initialized"));const s=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName).add(i);s.onsuccess=()=>t(),s.onerror=()=>e(Error("Failed to store item"))})}async getAll(){return this.db||await this.initialize(),new Promise((t,e)=>{if(!this.db)return void e(Error("Database not initialized"));const s=this.db.transaction([this.storeName],"readonly").objectStore(this.storeName).getAll();s.onsuccess=async()=>{const e=s.result,i={errors:[],sessionEvents:[],networkEvents:[]};for(const t of e){const e=await this.decompress(t.data);switch(t.type){case"error":i.errors.push(...Array.isArray(e)?e:[e]);break;case"session":i.sessionEvents.push(...Array.isArray(e)?e:[e]);break;case"network":i.networkEvents.push(...Array.isArray(e)?e:[e])}}t(i)},s.onerror=()=>e(Error("Failed to retrieve items"))})}async clear(){return this.db||await this.initialize(),new Promise((t,e)=>{if(!this.db)return void e(Error("Database not initialized"));const s=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName).clear();s.onsuccess=()=>t(),s.onerror=()=>e(Error("Failed to clear storage"))})}async getQueueSize(){return this.db||await this.initialize(),new Promise((t,e)=>{if(!this.db)return void e(Error("Database not initialized"));const s=this.db.transaction([this.storeName],"readonly").objectStore(this.storeName).count();s.onsuccess=()=>t(s.result),s.onerror=()=>e(Error("Failed to get queue size"))})}async cleanupExpiredItems(){if(!this.db)return;const t=Date.now()-this.maxAge;return new Promise(e=>{if(!this.db)return void e();const s=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName).index("timestamp"),i=IDBKeyRange.upperBound(t),r=s.openCursor(i);r.onsuccess=t=>{const s=t.target.result;s?(s.delete(),s.continue()):e()},r.onerror=()=>e()})}async removeOldestItems(t){if(this.db)return new Promise(e=>{if(!this.db)return void e();const s=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName).index("timestamp").openCursor();let i=0;s.onsuccess=s=>{const r=s.target.result;r&&t>i?(r.delete(),i++,r.continue()):e()},s.onerror=()=>e()})}async compress(t){try{const e=JSON.stringify(t);return btoa(unescape(encodeURIComponent(e)))}catch(e){return JSON.stringify(t)}}async decompress(t){try{const e=decodeURIComponent(escape(atob(t)));return JSON.parse(e)}catch(e){try{return JSON.parse(t)}catch(e){return t}}}generateId(){return`revi-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}}class o{constructor(){this.storageKey="revi_upload_queue";const t=function(){try{if("undefined"!=typeof window&&window.localStorage)return window.localStorage.setItem("test","test"),window.localStorage.removeItem("test"),window.localStorage}catch(t){}return null}();if(!t)throw Error("No storage available");this.storage=t}async store(t,e){try{const s=await this.getAll();switch(t){case"error":s.errors.push(...Array.isArray(e)?e:[e]);break;case"session":s.sessionEvents.push(...Array.isArray(e)?e:[e]);break;case"network":s.networkEvents.push(...Array.isArray(e)?e:[e])}this.storage.setItem(this.storageKey,JSON.stringify(s))}catch(t){throw Error("Failed to store data")}}async getAll(){try{const t=this.storage.getItem(this.storageKey);if(t)return JSON.parse(t)}catch(t){}return{errors:[],sessionEvents:[],networkEvents:[]}}async clear(){try{this.storage.removeItem(this.storageKey)}catch(t){}}}class h{constructor(){this.storage=null,this.isInitialized=!1}async initialize(){if(!this.isInitialized){try{const t=new a;await t.initialize(),this.storage=t}catch(t){try{this.storage=new o}catch(t){this.storage=new c}}this.isInitialized=!0}}async storeErrors(t){await this.ensureInitialized(),t.length>0&&await this.storage.store("error",t)}async storeSessionEvents(t){await this.ensureInitialized(),t.length>0&&await this.storage.store("session",t)}async storeNetworkEvents(t){await this.ensureInitialized(),t.length>0&&await this.storage.store("network",t)}async getAllData(){return await this.ensureInitialized(),await this.storage.getAll()}async clearAll(){await this.ensureInitialized(),await this.storage.clear()}async getQueueSize(){if(await this.ensureInitialized(),this.storage&&"getQueueSize"in this.storage&&this.storage.getQueueSize)return await this.storage.getQueueSize();{const t=await this.getAllData();return t.errors.length+t.sessionEvents.length+t.networkEvents.length}}async ensureInitialized(){this.isInitialized||await this.initialize()}}class c{async store(){}async getAll(){return{errors:[],sessionEvents:[],networkEvents:[]}}async clear(){}}class u{constructor(){this.isOnline="undefined"==typeof navigator||navigator.onLine,this.connectionType="unknown",this.listeners=[],"undefined"!=typeof window&&(window.addEventListener("online",()=>{this.isOnline=!0,this.notifyListeners(!0)}),window.addEventListener("offline",()=>{this.isOnline=!1,this.notifyListeners(!1)}),this.detectConnectionType())}getConnectionStatus(){return{online:this.isOnline,connectionType:this.connectionType}}onConnectionChange(t){return this.listeners.push(t),()=>{const e=this.listeners.indexOf(t);e>-1&&this.listeners.splice(e,1)}}getBatchSize(){if(!this.isOnline)return 0;switch(this.connectionType){case"slow-2g":return 5;case"2g":return 10;case"3g":default:return 25;case"4g":return 50}}getUploadDelay(){if(!this.isOnline)return 0;switch(this.connectionType){case"slow-2g":return 3e4;case"2g":return 15e3;case"3g":default:return 1e4;case"4g":return 5e3}}shouldRetry(t){return!!this.isOnline&&5>t}getRetryDelay(t){return Math.min(1e3*Math.pow(2,t),16e3)}detectConnectionType(){if("connection"in navigator){const t=navigator.connection;this.connectionType=t.effectiveType||t.type||"unknown",t.addEventListener("change",()=>{this.connectionType=t.effectiveType||t.type||"unknown"})}}notifyListeners(t){this.listeners.forEach(e=>{try{e(t)}catch(t){}})}async testConnectivity(t){if(!this.isOnline)return!1;try{const e=t||"https://api.revi.dev/health";return await fetch(e,{method:"HEAD",mode:"no-cors",cache:"no-cache"}),!0}catch(t){return!1}}}async function l(t){const e=JSON.stringify(t);if(1024>e.length)return{data:e,compressed:!1};try{if("undefined"!=typeof CompressionStream){const t=new CompressionStream("gzip"),s=t.writable.getWriter(),i=t.readable.getReader(),r=(new TextEncoder).encode(e);await s.write(r),await s.close();const n=[];let a=!1;for(;!a;){const{value:t,done:e}=await i.read();a=e,t&&n.push(t)}const o=new Uint8Array(n.reduce((t,e)=>t+e.length,0));let h=0;for(const t of n)o.set(t,h),h+=t.length;const c=btoa(String.fromCharCode(...o));if(.8*e.length>c.length)return{data:c,compressed:!0}}}catch(t){}return{data:e,compressed:!1}}function d(t){if(0===t.length)return{events:t,compressionRatio:1};const e=JSON.stringify(t).length,s=new Map;for(const e of t){const t=Object.keys(e).sort().join(",");s.has(t)||s.set(t,[]),s.get(t).push(e)}const i=[];for(const[t,e]of s){if(1===e.length){i.push(e[0]);continue}const s={},r=t.split(",");for(const t of r){const i=e.map(e=>e[t]),r=i[0];i.every(t=>JSON.stringify(t)===JSON.stringify(r))&&(s[t]=r)}for(const t of e){const e={...t};for(const i of Object.keys(s))JSON.stringify(t[i])===JSON.stringify(s[i])&&delete e[i];Object.keys(s).length>2&&(e.i=s),i.push(e)}}return{events:i,compressionRatio:JSON.stringify(i).length/e}}function p(t,e,s=65536){if(0===t.length)return[];const i=[];let r=[],n=0;for(const a of t){const t=JSON.stringify(a).length;e>r.length&&s>=n+t||r.length>0&&(i.push(r),r=[],n=0),r.push(a),n+=t}return r.length>0&&i.push(r),i}class m{constructor(t){this.uploadTimer=null,this.isUploading=!1,this.retryAttempts=new Map,this.uploadQueue={errors:[],sessionEvents:[],networkEvents:[]},this.config=t,this.storageManager=new h,this.networkManager=new u,this.initialize()}async initialize(){try{await this.storageManager.initialize(),await this.loadQueueFromStorage(),this.startNetworkAwareUploadTimer(),this.setupBeforeUnloadHandler(),this.setupNetworkChangeHandler()}catch(t){}}async loadQueueFromStorage(){try{const t=await this.storageManager.getAllData();this.uploadQueue=t}catch(t){}}async saveQueueToStorage(){try{await this.storageManager.clearAll(),this.uploadQueue.errors.length>0&&await this.storageManager.storeErrors(this.uploadQueue.errors),this.uploadQueue.sessionEvents.length>0&&await this.storageManager.storeSessionEvents(this.uploadQueue.sessionEvents),this.uploadQueue.networkEvents.length>0&&await this.storageManager.storeNetworkEvents(this.uploadQueue.networkEvents)}catch(t){}}startNetworkAwareUploadTimer(){const t=()=>{this.uploadTimer&&clearTimeout(this.uploadTimer);const e=this.networkManager.getUploadDelay();e>0&&(this.uploadTimer=setTimeout(()=>{!this.isUploading&&this.hasQueuedData()?this.uploadData().finally(()=>{t()}):t()},e))};t()}setupNetworkChangeHandler(){this.networkManager.onConnectionChange(t=>{t&&this.hasQueuedData()&&!this.isUploading&&setTimeout(()=>{this.uploadData()},1e3)})}setupBeforeUnloadHandler(){"undefined"!=typeof window&&window.addEventListener("beforeunload",()=>{this.hasQueuedData()&&this.uploadDataSync()})}queueError(t){this.uploadQueue.errors.push(t),this.saveQueueToStorage().catch(t=>{})}queueSessionEvents(t){this.uploadQueue.sessionEvents.push(...t),this.saveQueueToStorage().catch(t=>{})}queueNetworkEvents(t){this.uploadQueue.networkEvents.push(...t),this.saveQueueToStorage().catch(t=>{})}hasQueuedData(){return this.uploadQueue.errors.length>0||this.uploadQueue.sessionEvents.length>0||this.uploadQueue.networkEvents.length>0}async uploadData(){if(this.isUploading||!this.hasQueuedData())return;const{online:t}=this.networkManager.getConnectionStatus();if(!t)return;this.isUploading=!0;const e=this.config.apiUrl||"https://api.revi.dev",s=this.networkManager.getBatchSize();try{if(this.uploadQueue.errors.length>0){const{events:t}=d(this.uploadQueue.errors),i=p(t,s,32768);for(const t of i)await this.uploadErrorsWithRetry(e,t);this.uploadQueue.errors=[]}if(this.uploadQueue.sessionEvents.length>0){const{events:t}=d(this.uploadQueue.sessionEvents),i=p(t,s,65536);for(const t of i)await this.uploadSessionEventsWithRetry(e,t);this.uploadQueue.sessionEvents=[]}if(this.uploadQueue.networkEvents.length>0){const{events:t}=d(this.uploadQueue.networkEvents),i=p(t,s,49152);for(const t of i)await this.uploadNetworkEventsWithRetry(e,t);this.uploadQueue.networkEvents=[]}await this.saveQueueToStorage(),this.retryAttempts.clear()}catch(t){}finally{this.isUploading=!1}}createBatches(t,e){if(0>=e)return[];const s=[];for(let i=0;t.length>i;i+=e)s.push(t.slice(i,i+e));return s}uploadDataSync(){var t;if(!this.hasQueuedData())return;const e=this.config.apiUrl||"https://api.revi.dev";if(navigator.sendBeacon){if(this.uploadQueue.errors.length>0){const t=JSON.stringify({errors:this.uploadQueue.errors});navigator.sendBeacon(e+"/api/capture/error",t)}if(this.uploadQueue.sessionEvents.length>0){const s=JSON.stringify({session_id:null===(t=this.uploadQueue.sessionEvents[0])||void 0===t?void 0:t.sessionId,events:this.uploadQueue.sessionEvents.map(t=>({event_type:t.type,data:t.data,timestamp:t.timestamp,session_id:t.sessionId}))});navigator.sendBeacon(e+"/api/capture/session-event",s)}if(this.uploadQueue.networkEvents.length>0){const t=JSON.stringify({events:this.uploadQueue.networkEvents});navigator.sendBeacon(e+"/api/capture/network-event",t)}}}async uploadErrors(t,e){const s={errors:e.map(t=>({message:t.message,stack_trace:t.stack,url:t.url,user_agent:t.userAgent,session_id:t.sessionId,metadata:{id:t.id,userId:t.userId,environment:t.environment,release:t.release,tags:t.tags,extra:t.extra,breadcrumbs:t.breadcrumbs,level:t.level,lineno:t.lineno,colno:t.colno,filename:t.filename}}))},{data:i,compressed:r}=await l(s),n={"X-API-Key":this.config.apiKey};r?(n["Content-Type"]="application/octet-stream",n["Content-Encoding"]="gzip",n["X-Original-Content-Type"]="application/json"):n["Content-Type"]="application/json";const a=await fetch(t+"/api/capture/error",{method:"POST",headers:n,body:i});if(!a.ok)throw Error("Upload failed: "+a.status)}async uploadSessionEvents(t,e){if(0===e.length)return;const s={session_id:e[0].sessionId,events:e.map(t=>({event_type:t.type,data:t.data,timestamp:t.timestamp,session_id:t.sessionId}))},{data:i,compressed:r}=await l(s),n={"X-API-Key":this.config.apiKey};r?(n["Content-Type"]="application/octet-stream",n["Content-Encoding"]="gzip",n["X-Original-Content-Type"]="application/json"):n["Content-Type"]="application/json";const a=await fetch(t+"/api/capture/session-event",{method:"POST",headers:n,body:i});if(!a.ok)throw Error("Upload failed: "+a.status)}async uploadNetworkEvents(t,e){const s=e.map(e=>fetch(t+"/api/capture/network-event",{method:"POST",headers:{"Content-Type":"application/json","X-API-Key":this.config.apiKey},body:JSON.stringify({session_id:e.sessionId,events:[{method:e.method,url:e.url,status_code:e.statusCode,response_time:e.responseTime,timestamp:e.timestamp,session_id:e.sessionId,request_data:{headers:e.requestHeaders||{},body:e.requestBody||null,size:e.requestSize||0},response_data:{headers:e.responseHeaders||{},body:e.responseBody||null,size:e.responseSize||0}}]})})),i=(await Promise.allSettled(s)).filter(t=>"rejected"===t.status);if(i.length>0)throw Error(i.length+" network event uploads failed")}async uploadErrorsWithRetry(t,e){return this.executeWithRetry("errors",()=>this.uploadErrors(t,e))}async uploadSessionEventsWithRetry(t,e){return this.executeWithRetry("session_events",()=>this.uploadSessionEvents(t,e))}async uploadNetworkEventsWithRetry(t,e){return this.executeWithRetry("network_events",()=>this.uploadNetworkEvents(t,e))}async executeWithRetry(t,e){const s=this.retryAttempts.get(t)||0;if(!this.networkManager.shouldRetry(s))throw Error("Max retry attempts exceeded for "+t);try{const s=await e();return this.retryAttempts.delete(t),s}catch(i){if(this.retryAttempts.set(t,s+1),this.networkManager.shouldRetry(s+1)){const i=this.networkManager.getRetryDelay(s+1);return await new Promise(t=>setTimeout(t,i)),this.executeWithRetry(t,e)}throw i}}async clearQueue(){this.uploadQueue={errors:[],sessionEvents:[],networkEvents:[]},await this.storageManager.clearAll()}destroy(){this.uploadTimer&&(clearTimeout(this.uploadTimer),this.uploadTimer=null),this.hasQueuedData()&&this.uploadDataSync()}}class y{constructor(t){this.journeyEvents=[],this.isTracking=!1,this.config=t,this.deviceFingerprint=this.generateDeviceFingerprint(),this.sessionStartTime=Date.now(),this.currentPageStartTime=Date.now(),"undefined"!=typeof window&&this.setupJourneyTracking()}startTracking(t){this.userId=t,this.isTracking=!0,this.trackPageView()}stopTracking(){this.isTracking=!1,this.flush()}setUserId(t){this.userId=t}trackPageView(){if(!this.isTracking)return;const t={event_type:"page_view",url:window.location.href,referrer:document.referrer||void 0,timestamp:Date.now(),metadata:{title:document.title,viewport:{width:window.innerWidth,height:window.innerHeight},scroll_position:{x:window.scrollX,y:window.scrollY},device_fingerprint:this.deviceFingerprint,user_agent:navigator.userAgent,language:navigator.language,timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,connection_type:this.getConnectionType()}};this.addJourneyEvent(t)}trackClick(t,e){if(!this.isTracking)return;const s={event_type:"click",url:window.location.href,timestamp:Date.now(),metadata:{element:{tag:t.tagName.toLowerCase(),id:t.id,class:t.className,text:this.getElementText(t),attributes:this.getRelevantAttributes(t)},coordinates:{x:e.clientX,y:e.clientY,page_x:e.pageX,page_y:e.pageY},viewport:{width:window.innerWidth,height:window.innerHeight},scroll_position:{x:window.scrollX,y:window.scrollY}}};this.addJourneyEvent(s)}trackFormSubmit(t){var e;if(!this.isTracking)return;const s=new FormData(t),i={};s.forEach((e,s)=>{const r=t.querySelector(`[name="${s}"]`);i[s]={type:(null==r?void 0:r.type)||"unknown",has_value:!!e,value_length:"string"==typeof e?e.length:0}});const r={event_type:"form_submit",url:window.location.href,timestamp:Date.now(),metadata:{form:{id:t.id,class:t.className,method:t.method,action:t.action,field_count:s.entries().length},fields:(null===(e=this.config.privacy)||void 0===e?void 0:e.maskInputs)?{}:i}};this.addJourneyEvent(r)}trackApiCall(t,e,s,i,r){if(!this.isTracking)return;const n={event_type:"api_call",url:window.location.href,timestamp:Date.now(),duration_ms:i,metadata:{api:{url:t,method:e,status:s,duration:i,size:r||0,success:s>=200&&300>s},page_context:{title:document.title,time_on_page:Date.now()-this.currentPageStartTime}}};this.addJourneyEvent(n)}trackError(t,e){var s;if(!this.isTracking)return;const i={event_type:"error",url:window.location.href,timestamp:Date.now(),metadata:{error:{message:t.message,name:t.name,stack:null===(s=t.stack)||void 0===s?void 0:s.split("\n").slice(0,5).join("\n")},user_context:{time_on_page:Date.now()-this.currentPageStartTime,session_duration:Date.now()-this.sessionStartTime,page_interactions:this.countPageInteractions()},custom_context:e||{}}};this.addJourneyEvent(i)}setupJourneyTracking(){let t=window.location.href;const e=()=>{if(window.location.href!==t){const e=Date.now()-this.currentPageStartTime;this.updateLastPageViewDuration(e),t=window.location.href,this.currentPageStartTime=Date.now(),this.trackPageView()}};window.addEventListener("popstate",e);const s=history.pushState,i=history.replaceState;history.pushState=function(...t){s.apply(history,t),setTimeout(e,0)},history.replaceState=function(...t){i.apply(history,t),setTimeout(e,0)},document.addEventListener("click",t=>{const e=t.target;e&&this.shouldTrackClick(e)&&this.trackClick(e,t)},{capture:!0,passive:!0}),document.addEventListener("submit",t=>{const e=t.target;e&&"FORM"===e.tagName&&this.trackFormSubmit(e)},{capture:!0,passive:!0}),window.addEventListener("beforeunload",()=>{const t=Date.now()-this.currentPageStartTime;this.updateLastPageViewDuration(t),this.flush()}),setInterval(()=>{this.journeyEvents.length>0&&this.flush()},3e4)}generateDeviceFingerprint(){if("undefined"==typeof window)return"server";const t=[navigator.userAgent,navigator.language,screen.width+"x"+screen.height,screen.colorDepth,Intl.DateTimeFormat().resolvedOptions().timeZone,navigator.platform,navigator.cookieEnabled,void 0!==window.localStorage,void 0!==window.sessionStorage];try{const e=document.createElement("canvas"),s=e.getContext("2d");s&&(s.textBaseline="top",s.font="14px Arial",s.fillText("Device fingerprint",2,2),t.push(e.toDataURL()))}catch(t){}const e=t.join("|");let s=0;for(let t=0;e.length>t;t++)s=(s<<5)-s+e.charCodeAt(t),s&=s;return Math.abs(s).toString(36)}addJourneyEvent(t){this.journeyEvents.push(t),50>this.journeyEvents.length||this.flush()}flush(){if(0===this.journeyEvents.length)return;const t=[...this.journeyEvents];this.journeyEvents=[],this.sendJourneyEvents(t).catch(e=>{this.journeyEvents.unshift(...t)})}async sendJourneyEvents(t){const e=this.config.apiUrl||"https://api.revi.dev",s=t.map(t=>fetch(e+"/api/analytics/user-event",{method:"POST",headers:{"Content-Type":"application/json","X-API-Key":this.config.apiKey},body:JSON.stringify({user_id:this.userId,session_id:this.getSessionId(),...t})}));await Promise.allSettled(s)}shouldTrackClick(t){const e=t.tagName.toLowerCase();return(!["input","textarea"].includes(e)||!["password","hidden"].includes(t.type))&&!t.hasAttribute("data-revi-ignore")}getElementText(t){return(t.textContent||t.innerText||"").trim().substring(0,100)}getRelevantAttributes(t){const e={};return["href","src","alt","title","data-testid","role"].forEach(s=>{const i=t.getAttribute(s);i&&(e[s]=i)}),e}getConnectionType(){if("connection"in navigator){const t=navigator.connection;return(null==t?void 0:t.effectiveType)||(null==t?void 0:t.type)||"unknown"}return"unknown"}countPageInteractions(){return this.journeyEvents.filter(t=>["click","form_submit"].includes(t.event_type)).length}updateLastPageViewDuration(t){if(this.journeyEvents.length>0){const e=this.journeyEvents[this.journeyEvents.length-1];"page_view"===e.event_type&&(e.duration_ms=t)}}getSessionId(){return"session-"+Date.now()}}class w{constructor(t){this.activityLevel=0,this.lastActivity=Date.now(),this.errorFrequency=0,this.performanceImpact=0,this.config=t,this.startPerformanceMonitoring()}startPerformanceMonitoring(){"undefined"!=typeof window&&"performance"in window&&setInterval(()=>{this.assessPerformanceImpact()},5e3)}assessPerformanceImpact(){if("undefined"!=typeof performance)try{const t=performance.now(),e=performance.getEntriesByType("longtask").filter(e=>1e4>t-e.startTime);this.performanceImpact=Math.min(e.length/5,1)}catch(t){this.performanceImpact=.1}}updateActivityLevel(t){this.activityLevel={high:1,medium:.7,low:.4,idle:.1}[t],this.lastActivity=Date.now()}incrementErrorFrequency(){this.errorFrequency=Math.min(this.errorFrequency+.1,1),setTimeout(()=>{this.errorFrequency=Math.max(this.errorFrequency-.05,0)},3e4)}shouldSampleError(){var t,e;const s=null!==(e=null===(t=this.config.sampling)||void 0===t?void 0:t.errorSampleRate)&&void 0!==e?e:1;if(this.errorFrequency>.5)return Math.random()<s;const i=s*(1-.5*this.performanceImpact);return Math.random()<i}shouldSampleSession(){var t,e,s;const i=null!==(s=null!==(e=null===(t=this.config.sampling)||void 0===t?void 0:t.sessionSampleRate)&&void 0!==e?e:this.config.sessionSampleRate)&&void 0!==s?s:1,r=Math.min(i+.2*this.activityLevel,1)*(1-.3*this.performanceImpact);return Math.random()<r}shouldSamplePerformance(){var t,e;const s=(null!==(e=null===(t=this.config.sampling)||void 0===t?void 0:t.performanceSampleRate)&&void 0!==e?e:.1)*(1-.7*this.performanceImpact);return Math.random()<s}shouldSampleNetwork(){var t,e;const s=(null!==(e=null===(t=this.config.sampling)||void 0===t?void 0:t.networkSampleRate)&&void 0!==e?e:.5)*((Date.now()-this.lastActivity)/6e4>5?.5:1)*(1-.4*this.performanceImpact);return Math.random()<s}shouldSampleReplay(){var t,e;const s=null!==(e=null===(t=this.config.sampling)||void 0===t?void 0:t.replaySampleRate)&&void 0!==e?e:.1;let i=Math.min(s+.3*this.errorFrequency,1);return i*=1-.8*this.performanceImpact,Math.random()<i}getAdaptiveBatchSize(t){return Math.max(Math.floor(t*(1-.6*this.performanceImpact)),1)}getAdaptiveUploadDelay(t){return Math.floor(t*(1+2*this.performanceImpact)*Math.max(.3,1-.7*this.errorFrequency))}shouldSkipCapture(t){switch(t){case"error":return!this.shouldSampleError();case"session":return!this.shouldSampleSession();case"performance":return!this.shouldSamplePerformance();case"network":return!this.shouldSampleNetwork();case"replay":return!this.shouldSampleReplay();default:return!1}}getPerformanceImpact(){return this.performanceImpact}getActivityLevel(){return this.activityLevel}getErrorFrequency(){return this.errorFrequency}}class f{constructor(t){var e,s,i;this.webVitals={},this.performanceEntries=[],this.config=t,(null===(e=this.config.performance)||void 0===e?void 0:e.captureWebVitals)&&this.setupWebVitals(),(null===(s=this.config.performance)||void 0===s?void 0:s.captureResourceTiming)&&this.setupResourceTiming(),(null===(i=this.config.performance)||void 0===i?void 0:i.captureNavigationTiming)&&this.setupNavigationTiming()}setupWebVitals(){if("undefined"!=typeof window&&"PerformanceObserver"in window){try{new PerformanceObserver(t=>{const e=t.getEntries();this.webVitals.lcp=e[e.length-1].startTime}).observe({entryTypes:["largest-contentful-paint"]})}catch(t){}try{new PerformanceObserver(t=>{t.getEntries().forEach(t=>{this.webVitals.fid=t.processingStart-t.startTime})}).observe({entryTypes:["first-input"]})}catch(t){}try{let t=0;new PerformanceObserver(e=>{e.getEntries().forEach(e=>{e.hadRecentInput||(t+=e.value,this.webVitals.cls=t)})}).observe({entryTypes:["layout-shift"]})}catch(t){}try{new PerformanceObserver(t=>{t.getEntries().forEach(t=>{"first-contentful-paint"===t.name&&(this.webVitals.fcp=t.startTime)})}).observe({entryTypes:["paint"]})}catch(t){}this.calculateTTFB()}}calculateTTFB(){if("undefined"!=typeof window&&window.performance)try{const t=performance.getEntriesByType("navigation")[0];t&&(this.webVitals.ttfb=t.responseStart-t.requestStart)}catch(t){}}setupResourceTiming(){if("undefined"!=typeof window&&window.performance)try{new PerformanceObserver(t=>{t.getEntries().forEach(t=>{this.performanceEntries.push({name:t.name,entryType:t.entryType,startTime:t.startTime,duration:t.duration,transferSize:t.transferSize,encodedBodySize:t.encodedBodySize,decodedBodySize:t.decodedBodySize})})}).observe({entryTypes:["resource"]})}catch(t){}}setupNavigationTiming(){"undefined"!=typeof window&&window.performance&&window.addEventListener("load",()=>{try{const t=performance.getEntriesByType("navigation")[0];t&&this.performanceEntries.push({name:"navigation",entryType:"navigation",startTime:t.startTime,duration:t.duration,domContentLoadedEventEnd:t.domContentLoadedEventEnd,domContentLoadedEventStart:t.domContentLoadedEventStart,loadEventEnd:t.loadEventEnd,loadEventStart:t.loadEventStart,domComplete:t.domComplete,domInteractive:t.domInteractive})}catch(t){}})}getWebVitals(){return{...this.webVitals}}getPerformanceEntries(){return[...this.performanceEntries]}clearPerformanceEntries(){this.performanceEntries=[]}mark(t){if("undefined"!=typeof window&&window.performance&&window.performance.mark)try{performance.mark(t)}catch(t){}}measure(t,e,s){if("undefined"==typeof window||!window.performance||!window.performance.measure)return null;try{performance.measure(t,e,s);const i=performance.getEntriesByName(t,"measure")[0];return i?i.duration:null}catch(t){return null}}}class v{constructor(t){this.nodeIdMap=new WeakMap,this.nodeMap=new Map,this.nextNodeId=1,this.isObserving=!1,this.config=t}takeSnapshot(){const t={timestamp:Date.now(),url:window.location.href,viewport:{width:window.innerWidth,height:window.innerHeight},scroll:{x:window.scrollX,y:window.scrollY},nodes:[],stylesheets:[],resources:[]};return t.nodes=this.serializeDocument(document),t.stylesheets=this.serializeStylesheets(),t.resources=this.serializeResources(),t}startObserving(t){this.isObserving||(this.onDOMChange=t,this.observer=new MutationObserver(this.handleMutations.bind(this)),this.observer.observe(document,{childList:!0,attributes:!0,characterData:!0,subtree:!0,attributeOldValue:!0,characterDataOldValue:!0}),this.isObserving=!0)}stopObserving(){this.observer&&(this.observer.disconnect(),this.observer=void 0),this.isObserving=!1,this.onDOMChange=void 0}serializeDocument(t){const e=t.doctype,s=[];if(e&&s.push({type:"document",tagName:"DOCTYPE",attributes:{name:e.name,publicId:e.publicId,systemId:e.systemId},id:this.getNodeId(e)}),t.documentElement){const e=this.serializeNode(t.documentElement);e&&s.push(e)}return s}serializeNode(t){if(this.shouldIgnoreNode(t))return null;const e=this.getNodeId(t),s={type:this.getNodeType(t),id:e};switch(t.nodeType){case Node.ELEMENT_NODE:const e=t;s.tagName=e.tagName.toLowerCase(),s.attributes=this.serializeAttributes(e),s.children=this.serializeChildren(e);break;case Node.TEXT_NODE:const i=t;s.textContent=this.shouldMaskText(i)?"[Masked]":i.textContent||"";break;case Node.COMMENT_NODE:s.textContent=t.textContent||"";break;default:return null}return s}serializeAttributes(t){const e={};for(let s=0;t.attributes.length>s;s++){const i=t.attributes[s],r=i.name.toLowerCase();this.shouldIgnoreAttribute(r,i.value)||(e[r]=this.shouldMaskAttribute(r,t)?"[Masked]":i.value)}return e}serializeChildren(t){const e=[];for(let s=0;t.childNodes.length>s;s++){const i=this.serializeNode(t.childNodes[s]);i&&e.push(i)}return e}serializeStylesheets(){const t=[];for(let e=0;e<document.styleSheets.length;e++){const s=document.styleSheets[e];try{let e="";s.href?e=`/* External stylesheet: ${s.href} */`:s.cssRules&&(e=Array.from(s.cssRules).map(t=>t.cssText).join("\n")),t.push({href:s.href||void 0,cssText:e,disabled:s.disabled})}catch(e){s.href&&t.push({href:s.href,cssText:`/* Could not access stylesheet: ${s.href} */`,disabled:s.disabled})}}return t}serializeResources(){const t=[];return document.querySelectorAll("img").forEach(e=>{e.src&&!this.shouldIgnoreResource(e.src)&&t.push({url:e.src,type:"image",failed:!e.complete||0===e.naturalWidth})}),document.querySelectorAll("*").forEach(e=>{const s=window.getComputedStyle(e).backgroundImage;if(s&&"none"!==s){const e=s.match(/url\(['"]?([^'")]+)['"]?\)/);e&&e[1]&&!this.shouldIgnoreResource(e[1])&&t.push({url:e[1],type:"image"})}}),t}handleMutations(t){t.forEach(t=>{const e=this.nodeIdMap.get(t.target);if(!e)return;const s={timestamp:Date.now(),type:t.type,target:e};switch(t.type){case"childList":t.addedNodes.length>0&&(s.addedNodes=Array.from(t.addedNodes).map(t=>this.serializeNode(t)).filter(t=>null!==t)),t.removedNodes.length>0&&(s.removedNodes=Array.from(t.removedNodes).map(t=>this.nodeIdMap.get(t)).filter(t=>void 0!==t));break;case"attributes":if(s.attributeName=t.attributeName||void 0,t.target.nodeType===Node.ELEMENT_NODE){const e=t.target,i=e.getAttribute(t.attributeName||"");s.attributeValue=this.shouldMaskAttribute(t.attributeName||"",e)?"[Masked]":i||""}s.oldValue=t.oldValue||void 0;break;case"characterData":s.attributeValue=this.shouldMaskText(t.target)?"[Masked]":t.target.textContent||"",s.oldValue=t.oldValue||void 0}this.onDOMChange&&this.onDOMChange(s)})}getNodeId(t){if(this.nodeIdMap.has(t))return this.nodeIdMap.get(t);const e=this.nextNodeId++;return this.nodeIdMap.set(t,e),this.nodeMap.set(e,t),e}getNodeType(t){switch(t.nodeType){case Node.ELEMENT_NODE:return"element";case Node.TEXT_NODE:return"text";case Node.COMMENT_NODE:return"comment";case Node.DOCUMENT_NODE:return"document";default:return"element"}}shouldIgnoreNode(t){var e;if(t.nodeType===Node.ELEMENT_NODE){const s=t,i=s.tagName.toLowerCase();if(["script","noscript","meta"].includes(i))return!0;if(s.hasAttribute("data-revi-ignore"))return!0;if(null===(e=this.config.replay)||void 0===e?void 0:e.blockSelector)try{if(s.matches(this.config.replay.blockSelector))return!0}catch(t){}}return!1}shouldIgnoreAttribute(t,e){return["data-revi-ignore","data-password","data-sensitive"].includes(t)}shouldMaskAttribute(t,e){var s;return!!(null===(s=this.config.privacy)||void 0===s?void 0:s.maskInputs)&&(!("input"!==e.tagName.toLowerCase()||!["password","email","tel"].includes(e.type))&&"value"===t)}shouldMaskText(t){var e,s,i,r;if(!(null===(e=this.config.replay)||void 0===e?void 0:e.maskAllText)&&!(null===(s=this.config.privacy)||void 0===s?void 0:s.maskInputs))return!1;const n=t.parentElement;if(!n)return!1;if(["input","textarea"].includes(n.tagName.toLowerCase()))return!0;if(null===(i=this.config.replay)||void 0===i?void 0:i.maskSelector)try{return n.matches(this.config.replay.maskSelector)}catch(t){return!1}return(null===(r=this.config.replay)||void 0===r?void 0:r.maskAllText)||!1}shouldIgnoreResource(t){try{const e=new URL(t,window.location.href);if("data:"===e.protocol)return!0;if(t.includes("?")){const t=new URLSearchParams(e.search),s=t.get("w")||t.get("width"),i=t.get("h")||t.get("height");if(s&&parseInt(s)>2e3)return!0;if(i&&parseInt(i)>2e3)return!0}return!1}catch(t){return!0}}}class g{constructor(t,e={}){this.originalMethods={},this.entries=[],this.isRecording=!1,this.sessionId=t,this.config={maxEntries:1e3,captureStackTrace:!0,serializeObjects:!0,maxObjectDepth:3,maxStringLength:1e4,ignoredLevels:[],...e}}start(){this.isRecording||(["log","info","warn","error","debug","trace"].forEach(t=>{if(this.config.ignoredLevels.includes(t))return;const e=console[t];this.originalMethods[t]=e,console[t]=(...s)=>{e.apply(console,s),this.recordEntry(t,s)}}),this.isRecording=!0)}stop(){this.isRecording&&(Object.entries(this.originalMethods).forEach(([t,e])=>{console[t]=e}),this.originalMethods={},this.isRecording=!1)}recordEntry(t,e){var s,i;try{const i={id:this.generateId(),timestamp:Date.now(),level:t,args:this.serializeArgs(e)};if(("error"===t||"warn"===t)&&this.config.captureStackTrace){const t=Error();t.stack&&(i.stack=this.cleanStackTrace(t.stack))}if("error"===t&&e[0]instanceof Error){const t=((null===(s=e[0].stack)||void 0===s?void 0:s.split("\n"))||[]).find(t=>t.includes(".js:")||t.includes(".ts:")||t.includes(".tsx:"));if(t){const e=t.match(/([^/]+):(\d+):(\d+)/);e&&(i.url=e[1],i.lineNumber=parseInt(e[2]),i.columnNumber=parseInt(e[3]))}}this.addEntry(i)}catch(t){null===(i=this.originalMethods.warn)||void 0===i||i.call(console,"ConsoleRecorder error:",t)}}serializeArgs(t){return t.map(t=>this.serializeValue(t,0))}serializeValue(t,e){if(e>this.config.maxObjectDepth)return"[Object too deep]";if(null==t)return t;if("string"==typeof t)return t.length>this.config.maxStringLength?t.substring(0,this.config.maxStringLength)+"...":t;if("number"==typeof t||"boolean"==typeof t)return t;if("function"==typeof t)return`[Function: ${t.name||"anonymous"}]`;if(t instanceof Error)return{name:t.name,message:t.message,stack:this.config.captureStackTrace?this.cleanStackTrace(t.stack||""):void 0};if(t instanceof Date)return{o:"Date",value:t.toISOString()};if(t instanceof RegExp)return{o:"RegExp",value:""+t};if(Array.isArray(t))return this.config.serializeObjects?t.slice(0,100).map(t=>this.serializeValue(t,e+1)):"[Array]";if("object"==typeof t){if(!this.config.serializeObjects)return"[Object]";try{const s={},i=Object.keys(t).slice(0,50);for(const r of i)try{s[r]=this.serializeValue(t[r],e+1)}catch(t){s[r]="[Unserializable]"}return Object.keys(t).length>50&&(s["..."]=`[${Object.keys(t).length-50} more keys]`),s}catch(t){return"[Unserializable Object]"}}return t+""}cleanStackTrace(t){return t.split("\n").filter(t=>!t.includes("console-recorder.ts")&&!t.includes("ConsoleRecorder")).slice(0,10).join("\n")}addEntry(t){this.entries.push(t),this.entries.length>this.config.maxEntries&&(this.entries=this.entries.slice(.8*-this.config.maxEntries))}generateId(){return`console-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}getEntries(t,e){let s=this.entries;return t&&(s=s.filter(e=>e.timestamp>=t)),e&&(s=s.filter(t=>e>=t.timestamp)),[...s]}getEntriesByLevel(t){return this.entries.filter(e=>e.level===t)}clear(){this.entries=[]}toSessionEvents(){return this.entries.map(t=>({session_id:this.sessionId,event_type:"console",data:{level:t.level,args:t.args,stack:t.stack,url:t.url,lineNumber:t.lineNumber,columnNumber:t.columnNumber,consoleId:t.id},timestamp:t.timestamp,url:t.url||window.location.href,user_agent:navigator.userAgent}))}exportData(){const t={};let e=1/0,s=-1/0;return this.entries.forEach(i=>{t[i.level]=(t[i.level]||0)+1,e=Math.min(e,i.timestamp),s=Math.max(s,i.timestamp)}),{sessionId:this.sessionId,config:this.config,entries:[...this.entries],stats:{totalEntries:this.entries.length,levelCounts:t,errorCount:t.error||0,warningCount:t.warn||0,timeRange:{start:e===1/0?0:e,end:s===-1/0?0:s}}}}generateInsights(){return{errorPatterns:this.findErrorPatterns(),performanceIssues:this.detectPerformanceIssues(),recommendations:this.generateRecommendations()}}findErrorPatterns(){const t=this.entries.filter(t=>"error"===t.level),e={};return t.forEach(t=>{let s="Unknown Error";if(t.args.length>0){const e=t.args[0];"string"==typeof e?s=e.replace(/\d+/g,"N").replace(/["'][^"']*["']/g,"STRING").replace(/\b\w+@\w+\.\w+/g,"EMAIL").replace(/https?:\/\/[^\s]+/g,"URL").substring(0,100):"object"==typeof e&&e.name&&(s=`${e.name}: ${e.message}`.substring(0,100))}e[s]||(e[s]=[]),e[s].push(t)}),Object.entries(e).sort(([,t],[,e])=>e.length-t.length).slice(0,10).map(([t,e])=>({pattern:t,count:e.length,examples:e.slice(0,3)}))}detectPerformanceIssues(){const t=[],e=this.entries.filter(t=>t.timestamp>Date.now()-6e4);e.length>100&&t.push({type:"Excessive Logging",severity:"medium",details:e.length+" console entries in the last minute may impact performance"});const s={};return this.entries.filter(t=>"error"===t.level).forEach(t=>{const e=JSON.stringify(t.args);s[e]=(s[e]||0)+1}),Object.entries(s).forEach(([e,s])=>{s>10&&t.push({type:"Repeated Error",severity:s>50?"high":"medium",details:`Same error occurred ${s} times`})}),this.entries.filter(t=>t.args.some(t=>"object"==typeof t&&null!==t&&!Array.isArray(t))).length>.5*this.entries.length&&t.push({type:"Object Logging",severity:"low",details:"High percentage of object logging may indicate memory leaks"}),t}generateRecommendations(){const t=[],e=this.exportData().stats;return e.errorCount>0&&t.push(`Found ${e.errorCount} console errors. Review error patterns and fix underlying issues.`),e.warningCount>2*e.errorCount&&t.push("High warning-to-error ratio suggests proactive error handling could prevent issues."),e.totalEntries>500&&t.push("Consider reducing console logging in production to improve performance."),e.levelCounts.debug&&e.levelCounts.debug>100&&t.push("Debug logs should be disabled in production environments."),0===t.length&&t.push("Console logging patterns look healthy."),t}}class S{constructor(t,e={}){this.data=[],this.config={radius:20,maxIntensity:100,gradient:{.4:"blue",.6:"cyan",.7:"lime",.8:"yellow",1:"red"},blur:15,minOpacity:0,maxOpacity:.6,...e},this.canvas=document.createElement("canvas"),this.canvas.style.position="absolute",this.canvas.style.top="0",this.canvas.style.left="0",this.canvas.style.pointerEvents="none",this.canvas.style.zIndex="9999",t.appendChild(this.canvas);const s=this.canvas.getContext("2d");if(!s)throw Error("Failed to get canvas context");this.ctx=s,this.resizeCanvas(),window.addEventListener("resize",()=>this.resizeCanvas())}resizeCanvas(){const t=this.canvas.parentElement.getBoundingClientRect();this.canvas.width=t.width,this.canvas.height=t.height,this.canvas.style.width=t.width+"px",this.canvas.style.height=t.height+"px"}addDataPoint(t,e,s,i){this.data.push({x:t,y:e,intensity:s,event_type:i,timestamp:Date.now()}),this.data.length>1e4&&(this.data=this.data.slice(-8e3))}generateFromEvents(t){this.data=[],t.forEach(t=>{var e,s,i,r,n,a;"click"===t.event_type&&(null===(e=t.data)||void 0===e?void 0:e.x)&&(null===(s=t.data)||void 0===s?void 0:s.y)?this.addDataPoint(t.data.x,t.data.y,10,"click"):"mousemove"===t.event_type&&(null===(i=t.data)||void 0===i?void 0:i.x)&&(null===(r=t.data)||void 0===r?void 0:r.y)?this.addDataPoint(t.data.x,t.data.y,2,"move"):"scroll"===t.event_type&&void 0!==(null===(n=t.data)||void 0===n?void 0:n.scrollX)&&void 0!==(null===(a=t.data)||void 0===a?void 0:a.scrollY)&&this.addDataPoint(t.data.scrollX||0,t.data.scrollY||0,5,"scroll")})}render(t){if(this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),0===this.data.length)return;const e=t?this.data.filter(e=>t.includes(e.event_type)):this.data,s=this.createIntensityMap(e),i=this.createGradient();this.renderHeatmap(s,i)}createIntensityMap(t){const e=document.createElement("canvas");e.width=this.canvas.width,e.height=this.canvas.height;const s=e.getContext("2d");return t.forEach(t=>{const e=this.config.radius,i=s.createRadialGradient(t.x,t.y,0,t.x,t.y,e);i.addColorStop(0,`rgba(0, 0, 0, ${Math.min(t.intensity/this.config.maxIntensity,1)})`),i.addColorStop(1,"rgba(0, 0, 0, 0)"),s.fillStyle=i,s.fillRect(t.x-e,t.y-e,2*e,2*e)}),s.filter=`blur(${this.config.blur}px)`,s.drawImage(e,0,0),s.getImageData(0,0,e.width,e.height)}createGradient(){const t=document.createElement("canvas");t.width=256,t.height=1;const e=t.getContext("2d"),s=e.createLinearGradient(0,0,256,0);return Object.entries(this.config.gradient).forEach(([t,e])=>{s.addColorStop(parseFloat(t),e)}),e.fillStyle=s,e.fillRect(0,0,256,1),e.getImageData(0,0,256,1)}renderHeatmap(t,e){const s=this.ctx.createImageData(t.width,t.height);for(let i=0;t.data.length>i;i+=4){const r=t.data[i+3];if(r>0){const t=4*Math.floor(r/255*255);s.data[i]=e.data[t],s.data[i+1]=e.data[t+1],s.data[i+2]=e.data[t+2],s.data[i+3]=Math.floor(r*this.config.maxOpacity)}}this.ctx.putImageData(s,0,0)}clear(){this.data=[],this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)}destroy(){this.clear(),this.canvas.parentElement&&this.canvas.parentElement.removeChild(this.canvas),window.removeEventListener("resize",()=>this.resizeCanvas())}exportData(){const t={};let e=1/0,s=-1/0,i=1/0,r=-1/0,n=1/0,a=-1/0;return this.data.forEach(o=>{t[o.event_type]=(t[o.event_type]||0)+1,e=Math.min(e,o.x),s=Math.max(s,o.x),i=Math.min(i,o.y),r=Math.max(r,o.y),n=Math.min(n,o.timestamp),a=Math.max(a,o.timestamp)}),{config:this.config,data:[...this.data],stats:{totalEvents:this.data.length,eventTypes:t,timeRange:{start:n,end:a},bounds:{minX:e,maxX:s,minY:i,maxY:r}}}}generateInsights(){return{hotSpots:this.findHotSpots(),clickPatterns:this.analyzeClickPatterns(),userBehavior:this.analyzeUserBehavior()}}findHotSpots(){const t=[],e=2*this.config.radius;return this.data.forEach(s=>{let i=!1;for(const r of t)if(e>=Math.sqrt(Math.pow(s.x-r.x,2)+Math.pow(s.y-r.y,2))){r.x=(r.x*r.count+s.x)/(r.count+1),r.y=(r.y*r.count+s.y)/(r.count+1),r.intensity+=s.intensity,r.count++,i=!0;break}i||t.push({x:s.x,y:s.y,intensity:s.intensity,count:1})}),t.filter(t=>t.count>=3).sort((t,e)=>e.intensity-t.intensity).slice(0,10).map(t=>({x:Math.round(t.x),y:Math.round(t.y),intensity:Math.round(t.intensity),radius:Math.min(e,5*t.count)}))}analyzeClickPatterns(){const t=this.data.filter(t=>"click"===t.event_type),e={};for(let s=0;t.length-1>s;s++){const i=t[s],r=t[s+1];if(5e3>r.timestamp-i.timestamp){const t=`(${Math.round(i.x)},${Math.round(i.y)}) -> (${Math.round(r.x)},${Math.round(r.y)})`;e[t]=(e[t]||0)+1}}return Object.entries(e).sort(([,t],[,e])=>e-t).slice(0,5).map(([t,e])=>({pattern:t,frequency:e}))}analyzeUserBehavior(){const t=this.data.filter(t=>"click"===t.event_type),e=this.data.filter(t=>"scroll"===t.event_type),s=[...this.data].sort((t,e)=>e.intensity-t.intensity),i=s.slice(0,Math.floor(.5*s.length)),r=Math.min(...i.map(t=>t.x)),n=Math.max(...i.map(t=>t.x)),a=Math.min(...i.map(t=>t.y)),o=Math.max(...i.map(t=>t.y)),h=e.length>0?Math.max(...e.map(t=>t.y))/this.canvas.height:0,c=Math.min(100,2*t.length+50*h+.1*this.data.filter(t=>"move"===t.event_type).length);return{mostActiveArea:{x:Math.round(r),y:Math.round(a),width:Math.round(n-r),height:Math.round(o-a)},averageClicksPerSession:Math.round(t.length),scrollDepth:Math.round(100*h)/100,engagementScore:Math.round(c)}}}class b{constructor(t,e){var s,i,r,n,a,o,h,c,u,l,d,p,m,y,w,f,b;if(this.heatmapGenerator=null,this.events=[],this.consoleLogs=[],this.networkRequests=new Map,this.isRecording=!1,this.originalConsole={},this.config=t,this.sessionId=e,this.startTime=Date.now(),this.domSerializer=new v(t),this.consoleRecorder=new g(e,{maxEntries:(null===(s=t.replay)||void 0===s?void 0:s.maxConsoleEntries)||1e3,captureStackTrace:!1!==(null===(i=t.replay)||void 0===i?void 0:i.captureStackTrace),serializeObjects:!1!==(null===(r=t.replay)||void 0===r?void 0:r.serializeObjects),maxObjectDepth:(null===(n=t.replay)||void 0===n?void 0:n.maxObjectDepth)||3,maxStringLength:(null===(a=t.replay)||void 0===a?void 0:a.maxStringLength)||1e4,ignoredLevels:(null===(o=t.replay)||void 0===o?void 0:o.ignoredConsoleLevels)||[]}),(null===(h=this.config.replay)||void 0===h?void 0:h.enabled)&&(this.setupReplay(),(null===(u=null===(c=this.config.replay)||void 0===c?void 0:c.heatmaps)||void 0===u?void 0:u.enabled)&&"undefined"!=typeof document)){const e=document.body||document.documentElement;e&&(this.heatmapGenerator=new S(e,{radius:(null===(d=null===(l=t.replay)||void 0===l?void 0:l.heatmaps)||void 0===d?void 0:d.radius)||20,maxIntensity:(null===(m=null===(p=t.replay)||void 0===p?void 0:p.heatmaps)||void 0===m?void 0:m.maxIntensity)||100,blur:(null===(w=null===(y=t.replay)||void 0===y?void 0:y.heatmaps)||void 0===w?void 0:w.blur)||15,maxOpacity:(null===(b=null===(f=t.replay)||void 0===f?void 0:f.heatmaps)||void 0===b?void 0:b.maxOpacity)||.6}))}}startRecording(){var t;!this.isRecording&&(null===(t=this.config.replay)||void 0===t?void 0:t.enabled)&&(this.isRecording=!0,this.takeFullSnapshot(),this.domSerializer.startObserving(this.handleDOMChange.bind(this)),this.consoleRecorder.start(),this.setupNetworkCapture(),this.setupInteractionTracking(),setInterval(()=>{this.isRecording&&this.takeFullSnapshot()},6e4))}stopRecording(){this.isRecording&&(this.isRecording=!1,this.domSerializer.stopObserving(),this.consoleRecorder.stop(),this.restoreOriginalNetwork(),this.heatmapGenerator&&(this.heatmapGenerator.destroy(),this.heatmapGenerator=null))}getReplayData(){const t=this.consoleRecorder.getEntries(),e=this.consoleRecorder.generateInsights();let s,i;return this.heatmapGenerator&&(s=this.heatmapGenerator.exportData().data,i=this.heatmapGenerator.generateInsights()),{events:[...this.events],console_logs:t,network_requests:Array.from(this.networkRequests.values()),heatmap_data:s,session_info:{session_id:this.sessionId,start_time:this.startTime,duration:Date.now()-this.startTime,page_url:window.location.href},analytics:{console_insights:e,heatmap_insights:i}}}clearReplayData(){this.events=[],this.consoleLogs=[],this.networkRequests.clear(),this.consoleRecorder.clear(),this.heatmapGenerator&&this.heatmapGenerator.clear()}setupReplay(){if("undefined"==typeof window)return;let t;document.addEventListener("visibilitychange",()=>{this.addCustomEvent("visibility_change",{hidden:document.hidden})}),window.addEventListener("focus",()=>{this.addCustomEvent("window_focus",{})}),window.addEventListener("blur",()=>{this.addCustomEvent("window_blur",{})}),window.addEventListener("resize",()=>{this.addCustomEvent("viewport_change",{width:window.innerWidth,height:window.innerHeight})}),window.addEventListener("scroll",()=>{clearTimeout(t),t=setTimeout(()=>{this.heatmapGenerator&&this.heatmapGenerator.addDataPoint(window.scrollX||0,window.scrollY||0,5,"scroll"),this.addCustomEvent("scroll",{x:window.scrollX,y:window.scrollY})},100)},{passive:!0})}takeFullSnapshot(){if(this.isRecording)try{const t=this.domSerializer.takeSnapshot();this.addEvent({type:"full_snapshot",timestamp:Date.now(),data:t})}catch(t){}}handleDOMChange(t){this.isRecording&&this.addEvent({type:"incremental_snapshot",timestamp:t.timestamp,data:{source:"mutation",...t}})}renderHeatmap(t){this.heatmapGenerator&&this.heatmapGenerator.render(t)}toggleHeatmap(t){this.heatmapGenerator&&(t?this.heatmapGenerator.render():this.heatmapGenerator.clear())}getHeatmapInsights(){var t;return(null===(t=this.heatmapGenerator)||void 0===t?void 0:t.generateInsights())||null}setupNetworkCapture(){if(void 0!==window.fetch&&(this.originalFetch=window.fetch,window.fetch=async(t,e)=>{const s=Date.now(),i=this.generateRequestId(),r=t instanceof Request?t.url:""+t,n=(null==e?void 0:e.method)||(t instanceof Request?t.method:"GET");this.isRecording&&this.networkRequests.set(i,{timestamp:s,id:i,method:n,url:r,requestHeaders:this.getRequestHeaders(e,t),requestBody:await this.serializeRequestBody(e,t)});try{const r=await this.originalFetch(t,e),n=Date.now()-s;if(this.isRecording){const t=this.networkRequests.get(i);if(t&&(t.status=r.status,t.duration=n,t.responseHeaders=this.getResponseHeaders(r),this.shouldCaptureResponseBody(r)))try{const e=r.clone();t.responseBody=await e.text()}catch(t){}}return r}catch(t){const e=Date.now()-s;if(this.isRecording){const t=this.networkRequests.get(i);t&&(t.duration=e,t.failed=!0)}throw t}}),"undefined"!=typeof XMLHttpRequest){this.originalXMLHttpRequest=XMLHttpRequest;const t=this;window.XMLHttpRequest=function(){const e=new t.originalXMLHttpRequest,s=t.generateRequestId();let i="GET",r="",n=0;const a=e.open,o=e.send;return e.open=function(t,e,...s){return i=t,r=""+e,a.call(this,t,e,...s)},e.send=function(e){return n=Date.now(),t.isRecording&&t.networkRequests.set(s,{timestamp:n,id:s,method:i,url:r,requestBody:e}),o.call(this,e)},e.addEventListener("loadend",()=>{const i=Date.now()-n;if(t.isRecording){const r=t.networkRequests.get(s);r&&(r.status=e.status,r.duration=i,r.failed=0===e.status||e.status>=400,t.shouldCaptureXHRResponse(e)&&(r.responseBody=e.responseText))}}),e}}}setupInteractionTracking(){["mousedown","mouseup","click","dblclick","mousemove"].forEach(t=>{document.addEventListener(t,e=>{if(this.isRecording&&("mousemove"!==t||.1>=Math.random())){if(this.heatmapGenerator){let s=1;"click"===t?s=10:"mousemove"===t?s=2:"mousedown"===t&&(s=5),this.heatmapGenerator.addDataPoint(e.clientX,e.clientY,s,"click"===t?"click":"move")}this.addEvent({type:"incremental_snapshot",timestamp:Date.now(),data:{source:"mouse",type:t,x:e.clientX,y:e.clientY,id:this.getElementId(e.target)}})}},{capture:!0,passive:!0})}),document.addEventListener("keydown",t=>{this.isRecording&&(this.shouldIgnoreKeystroke(t)||this.addEvent({type:"incremental_snapshot",timestamp:Date.now(),data:{source:"keyboard",type:"keydown",key:this.sanitizeKey(t.key),code:t.code,id:this.getElementId(t.target)}}))},{capture:!0,passive:!0})}addEvent(t){this.events.push(t),this.events.length>1e4&&(this.events=this.events.slice(-8e3))}addCustomEvent(t,e){this.addEvent({type:"custom",timestamp:Date.now(),data:{type:t,...e}})}serializeConsoleArgs(t){return t.map(t=>{try{return"object"==typeof t&&null!==t?JSON.parse(JSON.stringify(t)):t}catch(t){return"[Unserializable Object]"}})}generateRequestId(){return Date.now().toString(36)+Math.random().toString(36).substr(2)}getRequestHeaders(t,e){const s={};return(null==t?void 0:t.headers)&&(t.headers instanceof Headers?t.headers.forEach((t,e)=>{s[e]=t}):Array.isArray(t.headers)?t.headers.forEach(([t,e])=>{s[t]=e}):Object.assign(s,t.headers)),e instanceof Request&&e.headers.forEach((t,e)=>{s[e]=t}),s}getResponseHeaders(t){const e={};return t.headers.forEach((t,s)=>{e[s]=t}),e}async serializeRequestBody(t,e){let s=null==t?void 0:t.body;if(e instanceof Request&&!s)try{s=await e.clone().text()}catch(t){return null}if(!s)return null;if("string"==typeof s)return s.length>1e4?s.substring(0,1e4)+"...[truncated]":s;if(s instanceof FormData){const t={};return s.forEach((e,s)=>{t[s]=e instanceof File?`[File: ${e.name}]`:e}),t}return"[Binary Data]"}shouldCaptureResponseBody(t){const e=t.headers.get("content-type")||"",s=parseInt(t.headers.get("content-length")||"0");return e.includes("application/json")||e.includes("text/")||s>0&&1e5>s}shouldCaptureXHRResponse(t){const e=t.getResponseHeader("content-type")||"";return e.includes("application/json")||e.includes("text/")||t.responseText&&1e5>t.responseText.length}getElementId(t){return t?Math.random():void 0}shouldIgnoreKeystroke(t){const e=t.target;if(e&&e.tagName){if("input"===e.tagName.toLowerCase()&&"password"===e.type)return!0;if(e.hasAttribute("data-revi-ignore"))return!0}return!1}sanitizeKey(t){return 1===t.length&&/[a-zA-Z0-9]/.test(t)?"*":t}restoreOriginalNetwork(){this.originalFetch&&(window.fetch=this.originalFetch),this.originalXMLHttpRequest&&(window.XMLHttpRequest=this.originalXMLHttpRequest)}}class D{constructor(t){if(this.isInitialized=!1,this.config={apiUrl:process.env.REVI_API_URL||"https://api.revi.dev",environment:"production",debug:!1,sampleRate:1,sessionSampleRate:1,maxBreadcrumbs:50,privacy:{maskInputs:!0,maskPasswords:!0,maskCreditCards:!0},performance:{captureWebVitals:!0,captureResourceTiming:!1,captureNavigationTiming:!0},replay:{enabled:!0,maskAllInputs:!1,maskAllText:!1},...t},!this.config.apiKey)throw Error("Revi: API key is required");"undefined"!=typeof navigator&&[/bot/i,/spider/i,/crawl/i,/headless/i,/phantom/i,/selenium/i].some(t=>t.test(navigator.userAgent))||this.init()}init(){var t;if(!this.isInitialized)try{this.traceManager=new s,this.errorHandler=new i(this.config,this.traceManager),this.sessionManager=new r(this.config,this.traceManager),this.networkMonitor=new n(this.config,this.traceManager),this.performanceMonitor=new f(this.config),this.dataManager=new m(this.config),this.userJourneyTracker=new y(this.config),this.sessionReplayManager=new b(this.config,this.sessionManager.getSessionId()),this.samplingManager=new w(this.config),this.setupAdaptiveFlush(),(null===(t=this.config.replay)||void 0===t?void 0:t.enabled)&&this.sessionReplayManager.startRecording(),this.isInitialized=!0}catch(t){}}setupAdaptiveFlush(){let t=0,e=Date.now();const s=()=>{const i=Date.now(),r=i-e;let n=1e4;t>0&&(n=Math.max(3e3,1e4-1e3*t)),0===t&&r>15e3&&(n=Math.min(3e4,n+5e3)),n>r||(this.flush(),e=i,t=0),setTimeout(s,2e3)};s();const i=this.captureException.bind(this);this.captureException=(e,s={})=>(t++,i(e,s))}captureException(t,e={}){if(!this.isInitialized)return"";if("error"!==e.level&&e.level&&this.samplingManager.shouldSkipCapture("error"))return"";this.samplingManager.incrementErrorFrequency(),this.samplingManager.updateActivityLevel("high");const s=this.errorHandler.captureException(t,e);if(s){const i={id:s,timestamp:Date.now(),message:t.message,stack:t.stack,url:window.location.href,userId:this.config.userId,sessionId:this.sessionManager.getSessionId(),userAgent:navigator.userAgent,environment:this.config.environment,release:this.config.release,tags:e.tags,extra:e.extra,breadcrumbs:this.errorHandler.getBreadcrumbs(),level:e.level||"error"};this.dataManager.queueError(i),this.userJourneyTracker&&this.userJourneyTracker.trackError(t,{level:e.level,tags:e.tags,extra:e.extra})}return s}captureMessage(t,e={}){if(!this.isInitialized)return"";const s=this.errorHandler.captureMessage(t,e);if(s){const i={id:s,timestamp:Date.now(),message:t,url:window.location.href,userId:this.config.userId,sessionId:this.sessionManager.getSessionId(),userAgent:navigator.userAgent,environment:this.config.environment,release:this.config.release,tags:e.tags,extra:e.extra,breadcrumbs:this.errorHandler.getBreadcrumbs(),level:e.level||"info"};this.dataManager.queueError(i)}return s}addBreadcrumb(t){this.isInitialized&&this.errorHandler.addBreadcrumb({timestamp:Date.now(),message:t.message,category:t.category||"manual",level:t.level||"info",data:t.data})}setUserContext(t){this.isInitialized&&(this.config.userId=t.id,this.errorHandler.setUserContext(t),this.userJourneyTracker.setUserId(t.id||""),this.userJourneyTracker.startTracking(t.id))}setTags(t){this.isInitialized&&this.errorHandler.setTags(t)}setExtra(t){this.isInitialized&&this.errorHandler.setExtra(t)}getSessionId(){return this.isInitialized?this.sessionManager.getSessionId():""}endSession(){this.isInitialized&&(this.flush(),this.sessionManager.endSession())}mark(t){this.isInitialized&&this.performanceMonitor.mark(t)}measure(t,e,s){return this.isInitialized?this.performanceMonitor.measure(t,e,s):null}getWebVitals(){return this.isInitialized?this.performanceMonitor.getWebVitals():{}}startSessionReplay(){this.isInitialized&&this.sessionReplayManager&&this.sessionReplayManager.startRecording()}stopSessionReplay(){this.isInitialized&&this.sessionReplayManager&&this.sessionReplayManager.stopRecording()}getSessionReplayData(){return this.isInitialized&&this.sessionReplayManager?this.sessionReplayManager.getReplayData():null}flush(){if(!this.isInitialized)return;const t=this.sessionManager.flush(),e=this.networkMonitor.flush();e.forEach(t=>{t.sessionId=this.sessionManager.getSessionId()}),t.length>0&&this.dataManager.queueSessionEvents(t),e.length>0&&this.dataManager.queueNetworkEvents(e)}getCurrentTraceId(){var t;return null===(t=this.traceManager)||void 0===t?void 0:t.getCurrentTraceId()}getCurrentSpanId(){var t;return null===(t=this.traceManager)||void 0===t?void 0:t.getCurrentSpanId()}getTraceContext(){var t;return(null===(t=this.traceManager)||void 0===t?void 0:t.getTraceContext())||{}}startSpan(t){var e;return null===(e=this.traceManager)||void 0===e?void 0:e.startSpan(t)}finishSpan(t,e){var s;null===(s=this.traceManager)||void 0===s||s.finishSpan(t,e)}destroy(){this.isInitialized&&(this.flush(),this.networkMonitor&&this.networkMonitor.destroy(),this.dataManager&&this.dataManager.destroy(),this.sessionReplayManager&&this.sessionReplayManager.stopRecording(),this.userJourneyTracker&&this.userJourneyTracker.stopTracking(),this.traceManager&&this.traceManager.cleanupSpanData(),this.isInitialized=!1)}}class k{constructor(t={}){this.retryStats=new Map,this.retryBudgetUsed=0,this.lastBudgetReset=Date.now(),this.budgetResetInterval=6e4,this.requestDeduplication=new Map,this.rateLimitedUntil=0,this.config={maxAttempts:5,baseDelay:1e3,maxDelay:3e4,jitterRatio:.1,timeoutMultiplier:1.5,retryBudget:100,enableJitter:!0,...t}}async executeWithRetry(t,e,s={}){const{priority:i="medium",timeout:r,payloadSize:n,deduplicationKey:a}=s;if(a&&this.requestDeduplication.has(a))return this.requestDeduplication.get(a);if(this.resetBudgetIfNeeded(),!this.hasBudgetAvailable(i))throw Error("Retry budget exceeded. Operation rate-limited.");const o=this.getOrCreateStats(t),h=this.performRetryLoop(t,e,i,r,n,[],o);return a&&(this.requestDeduplication.set(a,h),h.finally(()=>{this.requestDeduplication.delete(a)})),h}async performRetryLoop(t,e,s,i,r,n,a){for(let t=0;this.config.maxAttempts>t;t++){const o=Date.now();try{if(Date.now()<this.rateLimitedUntil)throw this.createRetryableError(429,"Rate limited","server",!1,s);const r=i?await this.executeWithTimeout(e,i*Math.pow(this.config.timeoutMultiplier,t)):await e();a.totalAttempts++,a.successfulRetries=t>0?a.successfulRetries+1:a.successfulRetries,a.lastSuccess=Date.now();const h={attempt:t+1,delay:0,timestamp:o,duration:Date.now()-o};return n.push(h),r}catch(e){const i=this.classifyError(e,s),h={attempt:t+1,delay:0,timestamp:o,error:i,duration:Date.now()-o};if(n.push(h),a.totalAttempts++,a.lastFailure=Date.now(),429===i.statusCode&&this.handleRateLimit(e),!this.shouldRetry(i,t,s,r))throw a.failedRetries++,e;const c=this.calculateDelay(t,s,r);h.delay=c;const u=n.reduce((t,e)=>t+e.delay,0);a.averageDelay=u/n.length,c>0&&await this.sleep(c),this.consumeRetryBudget(s)}}throw a.failedRetries++,Error(`Max retry attempts (${this.config.maxAttempts}) exceeded for ${t}`)}executeWithTimeout(t,e){return Promise.race([t(),new Promise((t,s)=>setTimeout(()=>s(Error(`Operation timed out after ${e}ms`)),e))])}classifyError(t,e){var s;if("TypeError"===t.name&&t.message.includes("fetch"))return this.createRetryableError(0,t.message,"network",!0,e);if((null===(s=t.message)||void 0===s?void 0:s.includes("timeout"))||"TimeoutError"===t.name)return this.createRetryableError(0,t.message,"timeout",!0,e);if(t.status||t.statusCode){const s=t.status||t.statusCode;if(s>=500)return this.createRetryableError(s,t.message,"server",!0,e);if(429===s)return this.createRetryableError(s,t.message,"server",!0,e);if(s>=400)return this.createRetryableError(s,t.message,"client",408===s||409===s||423===s||424===s,e)}return this.createRetryableError(0,t.message||"Unknown error","unknown",!1,e)}createRetryableError(t,e,s,i,r){return{statusCode:t,message:e,type:s,retryable:i,priority:r}}shouldRetry(t,e,s,i){return!!t.retryable&&(this.config.maxAttempts-1>e&&(!("critical"!==s&&!this.hasBudgetAvailable(s))&&(!i||1e5>=i||Math.max(2,this.config.maxAttempts-2)>e)))}calculateDelay(t,e,s){let i=Math.min(this.config.baseDelay*Math.pow(2,t),this.config.maxDelay);return i*={critical:.5,high:.7,medium:1,low:1.5}[e],s&&s>5e4&&(i*=Math.min(1+s/1e5,2)),this.config.enableJitter&&(i+=i*this.config.jitterRatio*(Math.random()-.5)),Math.max(0,Math.floor(i))}handleRateLimit(t){var e;const s=(null===(e=t.headers)||void 0===e?void 0:e["retry-after"])||t.retryAfter;if(s){const t=1e3*parseInt(s);this.rateLimitedUntil=Date.now()+t}else this.rateLimitedUntil=Date.now()+6e4}resetBudgetIfNeeded(){const t=Date.now();t-this.lastBudgetReset>this.budgetResetInterval&&(this.retryBudgetUsed=0,this.lastBudgetReset=t)}hasBudgetAvailable(t){return"critical"===t||this.config.retryBudget-("high"===t?.2*this.config.retryBudget:.5*this.config.retryBudget)>this.retryBudgetUsed}consumeRetryBudget(t){if("critical"!==t){this.retryBudgetUsed++;for(const t of this.retryStats.values())t.budgetUsed=this.retryBudgetUsed/this.config.retryBudget}}getOrCreateStats(t){return this.retryStats.has(t)||this.retryStats.set(t,{totalAttempts:0,successfulRetries:0,failedRetries:0,averageDelay:0,budgetUsed:0}),this.retryStats.get(t)}sleep(t){return new Promise(e=>setTimeout(e,t))}getStats(t){return t?this.retryStats.get(t)||this.getOrCreateStats(t):new Map(this.retryStats)}resetStats(t){t?this.retryStats.delete(t):(this.retryStats.clear(),this.retryBudgetUsed=0,this.lastBudgetReset=Date.now(),this.requestDeduplication.clear())}isRateLimited(){return Date.now()<this.rateLimitedUntil}getRemainingBudget(){return this.resetBudgetIfNeeded(),Math.max(0,this.config.retryBudget-this.retryBudgetUsed)}updateConfig(t){this.config={...this.config,...t}}}class M{constructor(t,e={}){this.name=t,this.state="closed",this.requestWindow=[],this.listeners=[],this.config={failureThreshold:5,recoveryTime:6e4,successThreshold:3,timeout:3e4,maxFailureRate:.5,windowSize:6e4,minRequests:5,...e},this.metrics={requests:0,failures:0,successes:0,failureRate:0,averageResponseTime:0,state:this.state}}async execute(t,e){if("open"===this.state){if(Date.now()<(this.metrics.nextRetryTime||0)){if(e)return await e();throw Error(`Circuit breaker ${this.name} is OPEN. Next retry: ${new Date(this.metrics.nextRetryTime)}`)}this.transitionToHalfOpen()}const s=Date.now();try{const e=await Promise.race([t(),new Promise((t,e)=>setTimeout(()=>e(Error(`Circuit breaker timeout: ${this.config.timeout}ms`)),this.config.timeout))]),i=Date.now()-s;return this.recordSuccess(i),e}catch(t){const i=Date.now()-s;if(this.recordFailure(i),e)try{return await e()}catch(e){throw t}throw t}}recordSuccess(t){const e=Date.now();this.requestWindow.push({timestamp:e,success:!0,duration:t}),this.cleanupOldRequests(),this.updateMetrics(),this.metrics.lastSuccessTime=e,"half-open"===this.state&&(this.config.successThreshold>this.metrics.successes||this.transitionToClosed()),this.notifyListeners()}recordFailure(t){const e=Date.now();this.requestWindow.push({timestamp:e,success:!1,duration:t}),this.cleanupOldRequests(),this.updateMetrics(),this.metrics.lastFailureTime=e,"closed"!==this.state&&"half-open"!==this.state||this.shouldOpen()&&this.transitionToOpen(),this.notifyListeners()}shouldOpen(){return!(this.config.minRequests>this.metrics.requests||this.config.failureThreshold>this.metrics.failures&&this.config.maxFailureRate>this.metrics.failureRate&&"half-open"!==this.state)}transitionToClosed(){this.state="closed",this.metrics.state="closed",this.metrics.openTime=void 0,this.metrics.nextRetryTime=void 0,this.metrics.failures=0,this.metrics.successes=0}transitionToOpen(){this.state="open",this.metrics.state="open",this.metrics.openTime=Date.now(),this.metrics.nextRetryTime=Date.now()+this.config.recoveryTime}transitionToHalfOpen(){this.state="half-open",this.metrics.state="half-open",this.metrics.successes=0}cleanupOldRequests(){const t=Date.now()-this.config.windowSize;this.requestWindow=this.requestWindow.filter(e=>e.timestamp>t)}updateMetrics(){const t=this.requestWindow.length,e=this.requestWindow.filter(t=>t.success).length,s=t-e;if(this.metrics.requests=t,this.metrics.successes=e,this.metrics.failures=s,this.metrics.failureRate=t>0?s/t:0,this.requestWindow.length>0){const t=this.requestWindow.reduce((t,e)=>t+e.duration,0);this.metrics.averageResponseTime=t/this.requestWindow.length}}getMetrics(){return this.cleanupOldRequests(),this.updateMetrics(),{...this.metrics}}getState(){return this.state}forceState(t){this.state=t,this.metrics.state=t,"open"===t&&(this.metrics.openTime=Date.now(),this.metrics.nextRetryTime=Date.now()+this.config.recoveryTime),this.notifyListeners()}reset(){this.state="closed",this.requestWindow=[],this.metrics={requests:0,failures:0,successes:0,failureRate:0,averageResponseTime:0,state:"closed"},this.notifyListeners()}onStateChange(t){return this.listeners.push(t),()=>{const e=this.listeners.indexOf(t);e>-1&&this.listeners.splice(e,1)}}notifyListeners(){this.listeners.forEach(t=>{try{t(this.state,{...this.metrics})}catch(t){}})}updateConfig(t){this.config={...this.config,...t}}}class T{constructor(){this.circuitBreakers=new Map,this.featureConfigs=new Map,this.degradedFeatures=new Set,this.listeners=[],this.globalCircuitBreaker=new M("global",{failureThreshold:20,maxFailureRate:.8,recoveryTime:3e4,minRequests:10}),this.globalCircuitBreaker.onStateChange((t,e)=>{this.notifyListeners("global-state-change",{state:t,metrics:e}),"open"===t?this.enableEmergencyMode():"closed"===t&&this.disableEmergencyMode()})}registerFeature(t,e,s){this.featureConfigs.set(t,e);const i=new M(t,{failureThreshold:"critical"===e.priority?10:"high"===e.priority?5:3,maxFailureRate:"critical"===e.priority?.8:.5,recoveryTime:"critical"===e.priority?3e4:6e4,...s});return i.onStateChange((s,i)=>{this.handleFeatureStateChange(t,e,s,i)}),this.circuitBreakers.set(t,i),i}async executeProtected(t,e,s){if(!this.circuitBreakers.has(t))throw Error(`Feature ${t} not registered with circuit breaker`);const i=this.circuitBreakers.get(t),r=this.featureConfigs.get(t);if("open"===this.globalCircuitBreaker.getState()&&"critical"!==r.priority){if(s)return await s();throw Error("Global circuit breaker is OPEN. Only critical features allowed.")}return this.degradedFeatures.has(t)&&r.gracefulDegradation&&s?await s():await this.globalCircuitBreaker.execute(()=>i.execute(e,s),s)}handleFeatureStateChange(t,e,s,i){this.notifyListeners("feature-state-change",{featureName:t,feature:e,state:s,metrics:i}),"open"===s?(e.gracefulDegradation&&(this.degradedFeatures.add(t),this.notifyListeners("feature-degraded",{featureName:t,feature:e})),"critical"!==e.priority&&this.evaluateSystemHealth()):"closed"===s&&this.degradedFeatures.has(t)&&(this.degradedFeatures.delete(t),this.notifyListeners("feature-recovered",{featureName:t,feature:e}))}evaluateSystemHealth(){const t=this.circuitBreakers.size,e=Array.from(this.circuitBreakers.values()).filter(t=>"open"===t.getState()).length/t;e>.3?this.enableProgressiveDegradation():.1>e&&this.disableProgressiveDegradation()}enableEmergencyMode(){this.notifyListeners("emergency-mode-enabled",{timestamp:Date.now()}),this.featureConfigs.forEach((t,e)=>{"critical"!==t.priority&&this.degradedFeatures.add(e)})}disableEmergencyMode(){this.notifyListeners("emergency-mode-disabled",{timestamp:Date.now()}),this.degradedFeatures.forEach(t=>{const e=this.circuitBreakers.get(t);e&&"open"!==e.getState()&&this.degradedFeatures.delete(t)})}enableProgressiveDegradation(){this.notifyListeners("progressive-degradation-enabled",{timestamp:Date.now()}),this.featureConfigs.forEach((t,e)=>{"low"===t.priority&&t.gracefulDegradation&&this.degradedFeatures.add(e)})}disableProgressiveDegradation(){this.notifyListeners("progressive-degradation-disabled",{timestamp:Date.now()}),this.featureConfigs.forEach((t,e)=>{if("low"===t.priority){const t=this.circuitBreakers.get(e);t&&"open"!==t.getState()&&this.degradedFeatures.delete(e)}})}getSystemHealth(){const t=this.circuitBreakers.size,e=Array.from(this.circuitBreakers.values()).filter(t=>"open"===t.getState()).length,s=t-e,i=this.degradedFeatures.size;return{globalState:this.globalCircuitBreaker.getState(),featuresTotal:t,featuresHealthy:s,featuresFailed:e,featuresDegraded:i,emergencyMode:"open"===this.globalCircuitBreaker.getState(),progressiveDegradation:i>0}}getAllMetrics(){const t=new Map;return t.set("global",this.globalCircuitBreaker.getMetrics()),this.circuitBreakers.forEach((e,s)=>{t.set(s,e.getMetrics())}),t}getCircuitBreaker(t){return this.circuitBreakers.get(t)}isFeatureDegraded(t){return this.degradedFeatures.has(t)}resetAll(){this.globalCircuitBreaker.reset(),this.circuitBreakers.forEach(t=>t.reset()),this.degradedFeatures.clear()}onEvent(t){return this.listeners.push(t),()=>{const e=this.listeners.indexOf(t);e>-1&&this.listeners.splice(e,1)}}notifyListeners(t,e){this.listeners.forEach(s=>{try{s(t,e)}catch(t){}})}executeWithBreaker(t,e,s={}){const{priority:i="medium",degradeGracefully:r=!1,degradedResponse:n}=s;return this.registerFeature(t,e,{name:t,priority:i,fallbackEnabled:r,gracefulDegradation:r},r?()=>Promise.resolve(n):void 0)}updateGlobalConfig(t){this.globalCircuitBreaker.updateConfig(t)}getGlobalStats(){return{global:this.globalCircuitBreaker.getMetrics(),features:Object.fromEntries(this.getAllMetrics()),systemHealth:this.getSystemHealth(),degradedFeatures:Array.from(this.degradedFeatures)}}resetStats(){this.resetAll()}}class x{constructor(){this.tiers=new Map,this.indexedDB=null,this.localStorage=null,this.memoryStore=new Map,this.initialized=!1,this.compressionWorker=null,this.initializeTiers(),this.quotaManager=new E,this.initializeCompressionWorker()}initializeTiers(){this.tiers.set("hot",{name:"hot",maxSize:5242880,compressionEnabled:!1,encryptionEnabled:!1,retentionTime:3e5,priority:1}),this.tiers.set("warm",{name:"warm",maxSize:52428800,compressionEnabled:!0,encryptionEnabled:!1,retentionTime:864e5,priority:2}),this.tiers.set("cold",{name:"cold",maxSize:10485760,compressionEnabled:!0,encryptionEnabled:!0,retentionTime:6048e5,priority:3})}async initializeCompressionWorker(){if("undefined"!=typeof Worker)try{const t=new Blob(["\n          self.onmessage = function(e) {\n            const { action, data, id } = e.data;\n            \n            if (action === 'compress') {\n              // Simple compression simulation\n              const compressed = JSON.stringify(data);\n              self.postMessage({ id, result: compressed, compressed: true });\n            } else if (action === 'decompress') {\n              try {\n                const decompressed = JSON.parse(data);\n                self.postMessage({ id, result: decompressed, compressed: false });\n              } catch (error) {\n                self.postMessage({ id, error: error.message });\n              }\n            }\n          };\n        "],{type:"application/javascript"});this.compressionWorker=new Worker(URL.createObjectURL(t))}catch(t){}}async initialize(){this.initialized||(await Promise.all([this.initializeIndexedDB(),this.initializeLocalStorage(),this.quotaManager.initialize()]),this.startBackgroundCleanup(),this.initialized=!0)}async initializeIndexedDB(){if("undefined"!=typeof window&&window.indexedDB)return new Promise((t,e)=>{const s=indexedDB.open("ReviResilientStorage",1);s.onerror=()=>e(s.error),s.onsuccess=()=>{this.indexedDB=s.result,t()},s.onupgradeneeded=()=>{const t=s.result;t.objectStoreNames.contains("errors")||t.createObjectStore("errors",{keyPath:"id"}),t.objectStoreNames.contains("sessions")||t.createObjectStore("sessions",{keyPath:"id"}),t.objectStoreNames.contains("network")||t.createObjectStore("network",{keyPath:"id"}),t.objectStoreNames.contains("metadata")||t.createObjectStore("metadata",{keyPath:"key"})}})}initializeLocalStorage(){"undefined"!=typeof window&&window.localStorage&&(this.localStorage=window.localStorage)}async store(t,e,s={}){this.initialized||await this.initialize();const{priority:i="medium",ttl:r,forceSync:n=!1}=s,a=this.generateId(t),o=this.calculateSize(e),h=this.selectOptimalTier(i,o,n),c={id:a,data:e,priority:i,timestamp:Date.now(),size:o,compressed:!1,encrypted:!1,retryCount:0,tier:h.name,expiresAt:r?Date.now()+r:void 0,checksum:this.calculateChecksum(e)};return await this.storeInTier(c,h),a}selectOptimalTier(t,e,s){return this.tiers.get("critical"===t||s?"hot":"high"===t||10240>e?"warm":"cold")}async storeInTier(t,e){switch(await this.checkQuotaAvailable(e,t.size)||await this.makeSpace(e,t.size),e.name){case"hot":await this.storeInMemory(t);break;case"warm":await this.storeInIndexedDB(t,e);break;case"cold":await this.storeInLocalStorage(t,e)}}async storeInMemory(t){this.memoryStore.set(t.id,t)}async storeInIndexedDB(t,e){if(!this.indexedDB)throw Error("IndexedDB not available");if(e.compressionEnabled){const e=await this.compressData(t.data);e.compressed&&(t.data=e.data,t.compressed=!0,t.size=this.calculateSize(t.data))}return new Promise((e,s)=>{const i=this.indexedDB.transaction(["errors","sessions","network"],"readwrite").objectStore(this.getStoreNameFromId(t.id)).put(t);i.onsuccess=()=>e(),i.onerror=()=>s(i.error)})}async storeInLocalStorage(t,e){if(!this.localStorage)throw Error("LocalStorage not available");let s=t.data;if(e.compressionEnabled){const e=await this.compressData(s);e.compressed&&(s=e.data,t.compressed=!0)}e.encryptionEnabled&&(s=await this.encryptData(s),t.encrypted=!0),t.data=s,t.size=this.calculateSize(t.data);try{this.localStorage.setItem("revi_"+t.id,JSON.stringify(t))}catch(s){if(!(s instanceof Error&&"QuotaExceededError"===s.name))throw s;await this.makeSpace(e,t.size),this.localStorage.setItem("revi_"+t.id,JSON.stringify(t))}}async retrieve(t){this.initialized||await this.initialize();const e=["hot","warm","cold"];for(const s of e){const e=await this.retrieveFromTier(t,s);if(e){if(!this.validateItemIntegrity(e))continue;return"hot"!==s&&this.shouldPromote(e)&&await this.promoteItem(e),e}}return null}async retrieveFromTier(t,e){switch(e){case"hot":return this.memoryStore.get(t)||null;case"warm":return this.retrieveFromIndexedDB(t);case"cold":return this.retrieveFromLocalStorage(t)}}async retrieveFromIndexedDB(t){return this.indexedDB?new Promise((e,s)=>{const i=this.indexedDB.transaction(["errors","sessions","network"],"readonly").objectStore(this.getStoreNameFromId(t)).get(t);i.onsuccess=async()=>{const t=i.result;if(t&&t.compressed){const e=await this.decompressData(t.data);t.data=e,t.compressed=!1}e(t||null)},i.onerror=()=>s(i.error)}):null}async retrieveFromLocalStorage(t){if(!this.localStorage)return null;try{const e=this.localStorage.getItem("revi_"+t);if(!e)return null;const s=JSON.parse(e);if(s.encrypted&&(s.data=await this.decryptData(s.data),s.encrypted=!1),s.compressed){const t=await this.decompressData(s.data);s.data=t,s.compressed=!1}return s}catch(t){return null}}async getAllByType(t){this.initialized||await this.initialize();const e=[];for(const s of["hot","warm","cold"]){const i=await this.getAllFromTier(t,s);e.push(...i)}return e.sort((t,e)=>{const s={critical:0,high:1,medium:2,low:3},i=s[t.priority]-s[e.priority];return 0!==i?i:t.timestamp-e.timestamp})}async getAllFromTier(t,e){switch(e){case"hot":return Array.from(this.memoryStore.values()).filter(e=>e.id.startsWith(t));case"warm":return this.getAllFromIndexedDB(t);case"cold":return this.getAllFromLocalStorage(t)}}async getAllFromIndexedDB(t){return this.indexedDB?new Promise((e,s)=>{const i=this.indexedDB.transaction([this.getStoreName(t)],"readonly").objectStore(this.getStoreName(t)).getAll();i.onsuccess=async()=>{const t=i.result;for(const e of t)if(e.compressed){const t=await this.decompressData(e.data);e.data=t,e.compressed=!1}e(t)},i.onerror=()=>s(i.error)}):[]}async getAllFromLocalStorage(t){if(!this.localStorage)return[];const e=[];for(let s=0;this.localStorage.length>s;s++){const i=this.localStorage.key(s);if(i&&i.startsWith("revi_"+t))try{const t=this.localStorage.getItem(i);if(t){const s=JSON.parse(t);if(s.encrypted&&(s.data=await this.decryptData(s.data),s.encrypted=!1),s.compressed){const t=await this.decompressData(s.data);s.data=t,s.compressed=!1}e.push(s)}}catch(t){}}return e}async remove(t){this.memoryStore.delete(t),this.indexedDB&&this.indexedDB.transaction(["errors","sessions","network"],"readwrite").objectStore(this.getStoreNameFromId(t)).delete(t),this.localStorage&&this.localStorage.removeItem("revi_"+t)}async clear(){if(this.memoryStore.clear(),this.indexedDB){const t=this.indexedDB.transaction(["errors","sessions","network"],"readwrite");t.objectStore("errors").clear(),t.objectStore("sessions").clear(),t.objectStore("network").clear()}if(this.localStorage){const t=[];for(let e=0;this.localStorage.length>e;e++){const s=this.localStorage.key(e);s&&s.startsWith("revi_")&&t.push(s)}t.forEach(t=>this.localStorage.removeItem(t))}}async checkQuotaAvailable(t,e){return(await this.quotaManager.getUsage(t.name)).available>=e}async makeSpace(t,e){await this.cleanupExpiredItems(t),await this.checkQuotaAvailable(t,e)||await this.evictLowPriorityItems(t,e)}async cleanupExpiredItems(t){const e=Date.now();switch(t.name){case"hot":for(const[s,i]of this.memoryStore)(i.expiresAt&&e>i.expiresAt||e-i.timestamp>t.retentionTime)&&this.memoryStore.delete(s);break;case"warm":if(this.indexedDB){const e=["errors","sessions","network"];for(const s of e)await this.cleanupIndexedDBStore(s,t.retentionTime)}break;case"cold":this.localStorage&&await this.cleanupLocalStorage(t.retentionTime)}}async evictLowPriorityItems(t,e){const s={low:0,medium:1,high:2,critical:3};let i=0;if("hot"===t.name){const t=Array.from(this.memoryStore.values()).sort((t,e)=>{const i=s[t.priority]-s[e.priority];return 0!==i?i:t.timestamp-e.timestamp});for(const s of t){if(i>=e)break;this.memoryStore.delete(s.id),i+=s.size}}}generateId(t){return`${t}_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}calculateSize(t){return 2*JSON.stringify(t).length}calculateChecksum(t){const e=JSON.stringify(t);let s=0;for(let t=0;e.length>t;t++)s=(s<<5)-s+e.charCodeAt(t),s&=s;return""+s}validateItemIntegrity(t){return!t.checksum||this.calculateChecksum(t.data)===t.checksum}shouldPromote(t){return"critical"===t.priority||"high"===t.priority&&3e5>Date.now()-t.timestamp}async promoteItem(t){const e=this.tiers.get("hot");await this.storeInTier(t,e),await this.remove(t.id)}async compressData(t){if(this.compressionWorker)return new Promise(e=>{const s=""+Math.random(),i=t=>{t.data.id===s&&(this.compressionWorker.removeEventListener("message",i),e({data:t.data.result,compressed:t.data.compressed}))};this.compressionWorker.addEventListener("message",i),this.compressionWorker.postMessage({action:"compress",data:t,id:s})});try{const e=await l(t);return{data:e.data,compressed:e.compressed}}catch(e){return{data:t,compressed:!1}}}async decompressData(t){return this.compressionWorker?new Promise((e,s)=>{const i=""+Math.random(),r=t=>{t.data.id===i&&(this.compressionWorker.removeEventListener("message",r),t.data.error?s(Error(t.data.error)):e(t.data.result))};this.compressionWorker.addEventListener("message",r),this.compressionWorker.postMessage({action:"decompress",data:t,id:i})}):"string"==typeof t?JSON.parse(t):t}async encryptData(t){const e=JSON.stringify(t);return btoa(e)}async decryptData(t){try{const e=atob(t);return JSON.parse(e)}catch(t){throw Error("Failed to decrypt data")}}getStoreName(t){switch(t){case"error":default:return"errors";case"session":return"sessions";case"network":return"network"}}getStoreNameFromId(t){return t.startsWith("error_")?"errors":t.startsWith("session_")?"sessions":t.startsWith("network_")?"network":"errors"}async cleanupIndexedDBStore(t,e){}async cleanupLocalStorage(t){if(!this.localStorage)return;const e=Date.now(),s=[];for(let i=0;this.localStorage.length>i;i++){const r=this.localStorage.key(i);if(r&&r.startsWith("revi_"))try{const i=this.localStorage.getItem(r);i&&e-JSON.parse(i).timestamp>t&&s.push(r)}catch(t){s.push(r)}}s.forEach(t=>this.localStorage.removeItem(t))}startBackgroundCleanup(){setInterval(()=>{this.tiers.forEach(async t=>{await this.cleanupExpiredItems(t)})},3e5)}async storeData(t,e,s){const i=this.selectOptimalTier(s.priority,JSON.stringify(e).length),r=this.storageProviders.get(i);if(!r)throw Error(`Storage tier ${i} not available`);let n=e;s.compress&&(n=this.compressData(e)),await r.setItem(t,JSON.stringify({data:n,metadata:{priority:s.priority,tier:i,compressed:s.compress||!1,timestamp:Date.now()}}))}async getData(t){var e;for(const[s,i]of this.storageProviders)try{const s=await i.getItem(t);if(s){const t=JSON.parse(s);return(null===(e=t.metadata)||void 0===e?void 0:e.compressed)?this.decompressData(t.data):t.data}}catch(t){}return null}async deleteData(t){await Promise.all(Array.from(this.storageProviders.values()).map(e=>e.removeItem(t).catch(()=>{})))}async getAllDataByPattern(t){var e;const s=[],i=RegExp(t.replace("*",".*"));for(const[t,r]of this.storageProviders)try{for(let t=0;r.length>t;t++){const n=r.key(t);if(n&&i.test(n)){const t=await r.getItem(n);if(t){const i=JSON.parse(t);s.push({key:n,data:(null===(e=i.metadata)||void 0===e?void 0:e.compressed)?this.decompressData(i.data):i.data,metadata:i.metadata})}}}}catch(t){}return s}selectOptimalTier(t,e){return"critical"===t||"high"===t&&1e4>e?"hot":"low"===t||e>1e5?"cold":"warm"}compressData(t){return t}decompressData(t){return t}async getStats(){return{totalItems:0,totalSize:0,itemsByPriority:{critical:0,high:0,medium:0,low:0},itemsByTier:{hot:0,warm:0,cold:0},compressionRatio:.7,quotaUsage:await this.quotaManager.getTotalUsage(),tierUsage:{hot:{itemCount:0,sizeBytes:0,quotaUsed:0},warm:{itemCount:0,sizeBytes:0,quotaUsed:0},cold:{itemCount:0,sizeBytes:0,quotaUsed:0}}}}updateConfig(t){this.config={...this.config,...t}}resetStats(){}}class E{constructor(){this.quotas=new Map}async initialize(){if("storage"in navigator&&"estimate"in navigator.storage){const t=await navigator.storage.estimate(),e=t.quota||0,s=t.usage||0;this.quotas.set("global",{total:e,used:s,available:e-s,percentage:e>0?s/e*100:0})}}async getUsage(t){return this.quotas.get("global")||{total:0,used:0,available:0,percentage:0}}async getTotalUsage(){return this.quotas.get("global")||{total:0,used:0,available:0,percentage:0}}}class R{constructor(t,e){this.name=t,this.checkInterval=null,this.listeners=[],this.requestHistory=[],this.windowSize=6e4,this.isRunning=!1,this.config={interval:3e4,timeout:1e4,endpoint:"",method:"HEAD",expectedStatus:[200,204],retryCount:3,failureThreshold:3,recoveryThreshold:3,degradationThreshold:.1,critical:!1,...e},this.metrics=this.initializeMetrics()}initializeMetrics(){return{responseTime:[],successRate:1,errorRate:0,availability:1,lastCheck:0,consecutiveFailures:0,consecutiveSuccesses:0,averageResponseTime:0,p95ResponseTime:0,p99ResponseTime:0,totalRequests:0,totalErrors:0,uptime:0,downtime:0}}start(){this.isRunning||(this.isRunning=!0,this.scheduleCheck())}stop(){this.isRunning=!1,this.checkInterval&&(clearTimeout(this.checkInterval),this.checkInterval=null)}scheduleCheck(){this.isRunning&&(this.checkInterval=setTimeout(async()=>{await this.performHealthCheck(),this.scheduleCheck()},this.config.interval))}async performHealthCheck(){const t=Date.now();let e,s=!1,i=0;try{for(let t=0;this.config.retryCount>=t;t++)try{const t=Date.now(),e=await this.executeHealthCheck();if(i=Date.now()-t,this.config.expectedStatus.includes(e.status)){s=!0;break}throw Error("Unexpected status code: "+e.status)}catch(e){if(t===this.config.retryCount)throw e;await this.sleep(1e3*Math.pow(2,t))}}catch(s){e=s.message,i=Date.now()-t}this.recordCheckResult(s,i,e)}async executeHealthCheck(){const t=new AbortController,e=setTimeout(()=>t.abort(),this.config.timeout);try{return await fetch(this.config.endpoint,{method:this.config.method,signal:t.signal,cache:"no-cache",headers:{"User-Agent":"Revi-HealthMonitor/1.0"}})}finally{clearTimeout(e)}}recordCheckResult(t,e,s){const i=Date.now();this.requestHistory.push({timestamp:i,success:t,responseTime:e}),this.cleanupOldHistory(),this.updateMetrics(t,e),t?(this.metrics.consecutiveFailures=0,this.metrics.consecutiveSuccesses++):(this.metrics.consecutiveSuccesses=0,this.metrics.consecutiveFailures++),this.metrics.lastCheck=i;const r=this.calculateHealthStatus(s);this.notifyListeners(r)}cleanupOldHistory(){const t=Date.now()-this.windowSize;this.requestHistory=this.requestHistory.filter(e=>e.timestamp>t)}updateMetrics(t,e){this.metrics.totalRequests++,t||this.metrics.totalErrors++,this.metrics.responseTime.push(e),this.metrics.responseTime.length>100&&this.metrics.responseTime.shift();const s=this.requestHistory.length,i=this.requestHistory.filter(t=>t.success).length,r=s-i;this.metrics.successRate=s>0?i/s:1,this.metrics.errorRate=s>0?r/s:0;const n=this.metrics.totalRequests*this.config.interval;if(this.metrics.availability=n>0?1-this.metrics.totalErrors*this.config.interval/n:1,this.metrics.responseTime.length>0){const t=[...this.metrics.responseTime].sort((t,e)=>t-e);this.metrics.averageResponseTime=t.reduce((t,e)=>t+e)/t.length,this.metrics.p95ResponseTime=t[Math.floor(.95*t.length)],this.metrics.p99ResponseTime=t[Math.floor(.99*t.length)]}}calculateHealthStatus(t){let e="unknown",s="stable",i=.5;if(this.config.failureThreshold>this.metrics.consecutiveFailures?this.metrics.errorRate>this.config.degradationThreshold?(e="degraded",i=Math.min(.8,2*this.metrics.errorRate)):this.config.recoveryThreshold>this.metrics.consecutiveSuccesses||(e="healthy",i=Math.min(.95,this.metrics.consecutiveSuccesses/(2*this.config.recoveryThreshold))):(e="unhealthy",i=Math.min(.9,this.metrics.consecutiveFailures/(2*this.config.failureThreshold))),this.requestHistory.length>=10){const t=this.requestHistory.slice(-5),e=this.requestHistory.slice(-10,-5),i=t.filter(t=>t.success).length/t.length,r=e.filter(t=>t.success).length/e.length;i>r+.2?s="improving":r-.2>i&&(s="degrading")}return{status:e,lastChecked:this.metrics.lastCheck,responseTime:this.metrics.averageResponseTime,error:t,metrics:{...this.metrics},trend:s,confidence:i}}sleep(t){return new Promise(e=>setTimeout(e,t))}getHealthStatus(){return this.calculateHealthStatus()}getMetrics(){return{...this.metrics}}async forceCheck(){return await this.performHealthCheck(),this.getHealthStatus()}onStatusChange(t){return this.listeners.push(t),()=>{const e=this.listeners.indexOf(t);e>-1&&this.listeners.splice(e,1)}}notifyListeners(t){this.listeners.forEach(e=>{try{e(t)}catch(t){}})}updateConfig(t){const e=this.config.interval;this.config={...this.config,...t},this.isRunning&&e!==this.config.interval&&(this.stop(),this.start())}reset(){this.metrics=this.initializeMetrics(),this.requestHistory=[]}}class I{constructor(){this.regionalMonitors=new Map,this.primaryRegion=null,this.failoverHistory=[],this.listeners=[],this.adaptiveBehavior=new O}registerRegion(t,e,s,i){const r=new R("region-"+t,{endpoint:e,critical:1===s,...i});return this.primaryRegion&&1!==s||(this.primaryRegion=t),r.onStatusChange(e=>{this.handleRegionalStatusChange(t,e)}),this.regionalMonitors.set(t,r),r}startAll(){this.regionalMonitors.forEach(t=>t.start())}stopAll(){this.regionalMonitors.forEach(t=>t.stop())}handleRegionalStatusChange(t,e){this.notifyListeners("regional-status-change",{region:t,status:e}),t===this.primaryRegion&&"unhealthy"===e.status&&this.performFailover(t,"primary_unhealthy"),this.adaptiveBehavior.recordRegionalHealth(t,e)}performFailover(t,e){const s=Array.from(this.regionalMonitors.entries()).filter(([e,s])=>e!==t&&"unhealthy"!==s.getHealthStatus().status).sort(([,t],[,e])=>{const s=t.getHealthStatus(),i=e.getHealthStatus();return"healthy"===s.status&&"healthy"!==i.status?-1:"healthy"===i.status&&"healthy"!==s.status?1:(s.responseTime||1/0)-(i.responseTime||1/0)});if(s.length>0){const[i]=s[0];this.primaryRegion=i,this.failoverHistory.push({from:t,to:i,timestamp:Date.now(),reason:e}),this.notifyListeners("failover",{from:t,to:i,reason:e,timestamp:Date.now()}),this.adaptiveBehavior.recordFailover(t,i,e)}}getPrimaryRegion(){return this.primaryRegion}getAllRegionalHealth(){return Array.from(this.regionalMonitors.entries()).map(([t,e])=>{var s;return{region:t,endpoint:e.config.endpoint,status:e.getHealthStatus(),priority:t===this.primaryRegion?1:2,lastFailover:null===(s=this.failoverHistory.filter(e=>e.to===t).sort((t,e)=>e.timestamp-t.timestamp)[0])||void 0===s?void 0:s.timestamp}})}getFailoverHistory(){return[...this.failoverHistory]}getAdaptiveBehaviorRecommendations(){return this.adaptiveBehavior.getRecommendations()}forceFailover(t,e="manual"){this.regionalMonitors.has(t)&&this.performFailover(this.primaryRegion||"unknown",e)}onEvent(t){return this.listeners.push(t),()=>{const e=this.listeners.indexOf(t);e>-1&&this.listeners.splice(e,1)}}notifyListeners(t,e){this.listeners.forEach(s=>{try{s(t,e)}catch(t){}})}getGlobalStats(){const t=Array.from(this.regionalMonitors.values()).map(t=>t.getStats()),e=t.reduce((t,e)=>t+e.averageLatency,0)/t.length,s=t.reduce((t,e)=>t+e.errorRate,0)/t.length;return{regions:this.config.regions.length,endpoints:Object.keys(this.config.endpoints).length,primaryRegion:this.primaryRegion,totalChecks:t.reduce((t,e)=>t+e.totalChecks,0),averageLatency:e||0,averageErrorRate:s||0,failovers:this.failoverHistory.length,adaptiveBehavior:this.adaptiveBehavior.getRecommendations()}}resetStats(){this.regionalMonitors.forEach(t=>t.resetStats()),this.failoverHistory=[],this.adaptiveBehavior.reset()}updateConfig(t){this.config={...this.config,...t}}destroy(){this.regionalMonitors.forEach(t=>t.destroy()),this.regionalMonitors.clear(),this.listeners=[]}}class O{constructor(){this.regionalHealthHistory=new Map,this.failoverPatterns=[],this.adaptiveSettings={uploadFrequency:1e4,batchSize:25,retryAttempts:3,timeoutMultiplier:1}}recordRegionalHealth(t,e){this.regionalHealthHistory.has(t)||this.regionalHealthHistory.set(t,[]);const s=this.regionalHealthHistory.get(t);s.push(e),s.length>100&&s.shift(),this.updateAdaptiveSettings(t,e)}recordFailover(t,e,s){this.failoverPatterns.push({from:t,to:e,timestamp:Date.now(),reason:s}),this.failoverPatterns.length>50&&this.failoverPatterns.shift()}updateAdaptiveSettings(t,e){"unhealthy"===e.status?this.adaptiveSettings.uploadFrequency=Math.min(2*this.adaptiveSettings.uploadFrequency,6e4):"healthy"===e.status&&(this.adaptiveSettings.uploadFrequency=Math.max(.9*this.adaptiveSettings.uploadFrequency,5e3)),e.responseTime&&e.responseTime>5e3?this.adaptiveSettings.batchSize=Math.max(this.adaptiveSettings.batchSize-5,5):e.responseTime&&1e3>e.responseTime&&(this.adaptiveSettings.batchSize=Math.min(this.adaptiveSettings.batchSize+5,100)),e.metrics.errorRate>.3?this.adaptiveSettings.retryAttempts=Math.min(this.adaptiveSettings.retryAttempts+1,10):.05>e.metrics.errorRate&&(this.adaptiveSettings.retryAttempts=Math.max(this.adaptiveSettings.retryAttempts-1,1))}getRecommendations(){const t=[];let e=.7;return this.adaptiveSettings.uploadFrequency>3e4&&t.push("Reduced upload frequency due to poor API health"),15>this.adaptiveSettings.batchSize&&t.push("Reduced batch size due to slow response times"),this.adaptiveSettings.retryAttempts>5&&t.push("Increased retry attempts due to high error rates"),Array.from(this.regionalHealthHistory.values()).reduce((t,e)=>t+e.length,0)>50&&(e=Math.min(.95,e+.2)),{...this.adaptiveSettings,confidence:e,reasoning:t}}reset(){this.regionalHealthHistory.clear(),this.failoverPatterns=[],this.adaptiveSettings={uploadFrequency:1e4,batchSize:25,retryAttempts:3,timeoutMultiplier:1}}}class _{constructor(t,e={}){this.healthMonitor=null,this.currentSync=null,this.syncContext=null,this.listeners=[],this.abortController=null,this.syncHistory=[],this.storage=t,this.retryManager=new k({maxAttempts:5,baseDelay:2e3,maxDelay:3e4,enableJitter:!0}),this.config={batchSize:20,maxConcurrentBatches:3,priorityWeights:{critical:1,high:.8,medium:.5,low:.2},bandwidthThrottling:!0,progressiveSync:!0,conflictResolution:"timestamp-wins",maxSyncTime:3e5,resumeIncomplete:!0,...e}}initialize(t,e){e?this.healthMonitor=e:(this.healthMonitor=new R("sync-health",{endpoint:t+"/health",interval:3e4,timeout:1e4}),this.healthMonitor.start()),this.setupNetworkListeners()}setupNetworkListeners(){"undefined"!=typeof window&&(window.addEventListener("online",()=>{this.handleNetworkReconnection()}),document.addEventListener("visibilitychange",()=>{!document.hidden&&navigator.onLine&&this.handleNetworkReconnection()}))}async handleNetworkReconnection(){await this.sleep(2e3),this.healthMonitor&&"unhealthy"===(await this.healthMonitor.forceCheck()).status||this.currentSync||this.startIntelligentSync()}async startIntelligentSync(t){if(this.currentSync)return this.currentSync;this.syncContext={sessionId:this.generateSessionId(),deviceId:this.getDeviceId(),lastSyncTimestamp:this.getLastSyncTimestamp(),offlineDuration:Date.now()-this.getLastSyncTimestamp(),networkQuality:await this.assessNetworkQuality(),batteryLevel:this.getBatteryLevel(),isBackground:document.hidden,...t},this.abortController=new AbortController,this.currentSync=this.performIntelligentSync(this.syncContext);try{const t=await this.currentSync;return this.recordSyncHistory(t),t}finally{this.currentSync=null,this.syncContext=null,this.abortController=null}}async performIntelligentSync(t){const e={phase:"preparing",totalItems:0,syncedItems:0,failedItems:0,currentBatch:0,totalBatches:0,estimatedTimeRemaining:0,bytesTransferred:0,totalBytes:0,errors:[]};this.notifyProgress(e);try{const s=await this.prepareSyncPlan(t);return e.totalItems=s.totalItems,e.totalBatches=s.batches.length,e.totalBytes=s.totalBytes,e.phase="syncing",this.notifyProgress(e),Date.now(),await this.executeSyncBatches(s,e),s.conflicts.length>0&&await this.resolveConflicts(s.conflicts),e.phase="completed",e.estimatedTimeRemaining=0,this.notifyProgress(e),this.updateLastSyncTimestamp(),e}catch(t){throw e.phase="failed",e.errors.push(t.message),this.notifyProgress(e),t}}async prepareSyncPlan(t){const[e,s,i]=await Promise.all([this.storage.getAllByType("error"),this.storage.getAllByType("session"),this.storage.getAllByType("network")]),r=[...e,...s,...i].filter(e=>e.timestamp>t.lastSyncTimestamp);r.sort((t,e)=>{const s=this.config.priorityWeights[t.priority]-this.config.priorityWeights[e.priority];return 0!==s?-s:t.timestamp-e.timestamp});const n=this.calculateAdaptiveBatchSize(t),a=this.createIntelligentBatches(r,n),o=await this.detectConflicts(r),h=r.reduce((t,e)=>t+e.size,0);return{batches:a,totalItems:r.length,totalBytes:h,conflicts:o}}calculateAdaptiveBatchSize(t){let e=this.config.batchSize;switch(t.networkQuality){case"poor":e=Math.max(5,.3*e);break;case"good":e=Math.floor(.8*e);break;case"excellent":e=Math.floor(1.5*e)}return t.batteryLevel&&.2>t.batteryLevel&&(e=Math.max(3,.5*e)),t.isBackground&&(e=Math.max(5,.6*e)),t.offlineDuration>36e5&&(e=Math.max(10,.7*e)),Math.floor(e)}createIntelligentBatches(t,e){const s=[],i=new Map;return t.forEach(t=>{i.has(t.priority)||i.set(t.priority,[]),i.get(t.priority).push(t)}),["critical","high","medium","low"].forEach(t=>{const r=i.get(t)||[];for(let i=0;r.length>i;i+=e){const n=r.slice(i,i+e),a=n.reduce((t,e)=>t+e.size,0);s.push({items:n,priority:this.config.priorityWeights[t],estimatedBytes:a})}}),s}async executeSyncBatches(t,e){var s,i;const r=[];let n=0;for(let a=0;t.batches.length>a;a++){const o=t.batches[a];for(;n>=this.config.maxConcurrentBatches;)await Promise.race(r),n=r.filter(t=>this.isPromisePending(t)).length;if(null===(s=this.abortController)||void 0===s?void 0:s.signal.aborted)throw Error("Sync aborted");const h=this.syncBatch(o,a+1,e);r.push(h),n++,e.currentBatch=a+1,this.updateEstimatedTime(e,t),this.notifyProgress(e),this.config.bandwidthThrottling&&"poor"===(null===(i=this.syncContext)||void 0===i?void 0:i.networkQuality)&&await this.sleep(a%3*1e3)}await Promise.allSettled(r)}async syncBatch(t,e,s){try{const e=t.items.filter(t=>t.id.startsWith("error_")),i=t.items.filter(t=>t.id.startsWith("session_")),r=t.items.filter(t=>t.id.startsWith("network_"));await Promise.all([e.length>0?this.syncErrorItems(e):Promise.resolve(),i.length>0?this.syncSessionItems(i):Promise.resolve(),r.length>0?this.syncNetworkItems(r):Promise.resolve()]),s.syncedItems+=t.items.length,s.bytesTransferred+=t.estimatedBytes,await Promise.all(t.items.map(t=>this.storage.remove(t.id)))}catch(i){s.failedItems+=t.items.length,s.errors.push(`Batch ${e} failed: ${i.message}`)}}async syncErrorItems(t){const e={errors:t.map(t=>{var e;return{...t.data,client_timestamp:t.timestamp,retry_count:t.retryCount,offline_duration:(null===(e=this.syncContext)||void 0===e?void 0:e.offlineDuration)||0}})};return this.retryManager.executeWithRetry("sync-errors",async()=>{var t,s;const i=await fetch("/api/capture/error",{method:"POST",headers:{"Content-Type":"application/json","X-Sync-Session":(null===(t=this.syncContext)||void 0===t?void 0:t.sessionId)||""},body:JSON.stringify(e),signal:null===(s=this.abortController)||void 0===s?void 0:s.signal});if(!i.ok)throw Error("Error sync failed: "+i.status);return i.json()},{priority:"high",payloadSize:JSON.stringify(e).length,deduplicationKey:"errors-"+t.map(t=>t.id).join("-")})}async syncSessionItems(t){const e=new Map;t.forEach(t=>{const s=t.data.sessionId;e.has(s)||e.set(s,[]),e.get(s).push(t)});for(const[t,s]of e){const e={session_id:t,events:s.map(t=>({...t.data,client_timestamp:t.timestamp,retry_count:t.retryCount}))};await this.retryManager.executeWithRetry("sync-session-"+t,async()=>{var t,s;const i=await fetch("/api/capture/session-event",{method:"POST",headers:{"Content-Type":"application/json","X-Sync-Session":(null===(t=this.syncContext)||void 0===t?void 0:t.sessionId)||""},body:JSON.stringify(e),signal:null===(s=this.abortController)||void 0===s?void 0:s.signal});if(!i.ok)throw Error("Session sync failed: "+i.status);return i.json()},{priority:"medium",payloadSize:JSON.stringify(e).length,deduplicationKey:"session-"+t})}}async syncNetworkItems(t){const e={events:t.map(t=>({...t.data,client_timestamp:t.timestamp,retry_count:t.retryCount}))};return this.retryManager.executeWithRetry("sync-network",async()=>{var t,s;const i=await fetch("/api/capture/network-event",{method:"POST",headers:{"Content-Type":"application/json","X-Sync-Session":(null===(t=this.syncContext)||void 0===t?void 0:t.sessionId)||""},body:JSON.stringify(e),signal:null===(s=this.abortController)||void 0===s?void 0:s.signal});if(!i.ok)throw Error("Network sync failed: "+i.status);return i.json()},{priority:"low",payloadSize:JSON.stringify(e).length,deduplicationKey:"network-"+t.length})}async detectConflicts(t){const e=[];return t.forEach(t=>{t.retryCount>3&&e.push({localItem:t,conflictType:"timestamp",resolution:"pending",resolvedWith:"local"})}),e}async resolveConflicts(t){for(const e of t){switch(this.config.conflictResolution){case"client-wins":case"timestamp-wins":e.resolvedWith="local";break;case"server-wins":e.resolvedWith="server"}e.resolution="resolved"}}updateEstimatedTime(t,e){var s;if(t.syncedItems>0){const e=Date.now()-((null===(s=this.syncContext)||void 0===s?void 0:s.lastSyncTimestamp)||Date.now());t.estimatedTimeRemaining=Math.floor(e/t.syncedItems*(t.totalItems-t.syncedItems))}}cancelSync(){this.abortController&&this.abortController.abort()}getCurrentProgress(){return null}isSyncRunning(){return null!==this.currentSync}onProgress(t){return this.listeners.push(t),()=>{const e=this.listeners.indexOf(t);e>-1&&this.listeners.splice(e,1)}}notifyProgress(t){this.listeners.forEach(e=>{try{e({...t})}catch(t){}})}generateSessionId(){return`sync_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}getDeviceId(){let t=localStorage.getItem("revi_device_id");return t||(t=`device_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,localStorage.setItem("revi_device_id",t)),t}getLastSyncTimestamp(){const t=localStorage.getItem("revi_last_sync");return t?parseInt(t):0}updateLastSyncTimestamp(){localStorage.setItem("revi_last_sync",""+Date.now())}async assessNetworkQuality(){if(!this.healthMonitor)return"unknown";const t=this.healthMonitor.getHealthStatus();return t.responseTime&&1e3>t.responseTime&&t.metrics.successRate>.95?"excellent":t.responseTime&&3e3>t.responseTime&&t.metrics.successRate>.8?"good":.5>t.metrics.successRate?"poor":"unknown"}getBatteryLevel(){navigator}recordSyncHistory(t){var e;this.syncHistory.push({timestamp:Date.now(),duration:Date.now()-((null===(e=this.syncContext)||void 0===e?void 0:e.lastSyncTimestamp)||Date.now()),itemsSynced:t.syncedItems,success:"completed"===t.phase}),this.syncHistory.length>20&&this.syncHistory.shift()}isPromisePending(t){return!0}sleep(t){return new Promise(e=>setTimeout(e,t))}getSyncHistory(){return[...this.syncHistory]}updateConfig(t){this.config={...this.config,...t}}getConfig(){return{...this.config}}getStats(){return{activeSyncs:this.activeSyncs.size,syncHistory:this.syncHistory.length,lastSync:this.syncHistory.length>0?this.syncHistory[this.syncHistory.length-1]:null,totalSyncs:this.syncHistory.length,successfulSyncs:this.syncHistory.filter(t=>t.success).length}}resetStats(){this.syncHistory=[],this.activeSyncs.clear()}destroy(){this.activeSyncs.clear(),this.syncHistory=[]}}class C{constructor(t={}){this.requestMap=new Map,this.responseCache=new Map,this.pendingRequests=new Map,this.keyCleanupInterval=null,this.stats={totalRequests:0,deduplicatedRequests:0,cacheHits:0,activePendingRequests:0,memoryUsage:0,keyCleanups:0},this.config={keyTTL:3e5,maxConcurrentRequests:10,enableResponseCaching:!0,responseCacheTTL:6e4,enableRequestFingerprinting:!0,maxStoredKeys:1e3,...t},this.startKeyCleanup()}async executeIdempotent(t,e,s={}){this.stats.totalRequests++;const i=this.config.enableRequestFingerprinting?await this.generateRequestFingerprint(s):null;if(!s.bypassCache&&this.config.enableResponseCaching){const e=this.getCachedResponse(t);if(e)return this.stats.cacheHits++,e}const r=this.requestMap.get(t);if(r&&"pending"===r.status&&(this.stats.deduplicatedRequests++,r.promise))try{return await r.promise}catch(e){3>r.attempts?(r.attempts++,r.lastAttemptAt=Date.now()):this.requestMap.delete(t)}const n={key:t,fingerprint:i||{method:s.method||"unknown",url:s.url||"unknown",headers:s.headers||{},timestamp:Date.now()},status:"pending",attempts:1,createdAt:Date.now(),lastAttemptAt:Date.now()},a=Array.from(this.requestMap.values()).filter(t=>"pending"===t.status).length;if(a>=this.config.maxConcurrentRequests)throw Error(`Too many concurrent idempotent requests (${a}/${this.config.maxConcurrentRequests})`);const o=this.performIdempotentOperation(t,e,n);n.promise=o,this.requestMap.set(t,n),this.pendingRequests.set(t,o),this.updateStats();try{return await o}finally{this.pendingRequests.delete(t),this.updateStats()}}async performIdempotentOperation(t,e,s){try{const i=await e();return s.status="completed",s.response=i,s.completedAt=Date.now(),this.config.enableResponseCaching&&this.cacheResponse(t,i),i}catch(t){throw s.status="failed",s.error=t,s.completedAt=Date.now(),t}}async generateRequestFingerprint(t){const e={method:t.method||"GET",url:t.url||"",headers:this.normalizeHeaders(t.headers||{}),timestamp:Date.now()};return!t.body||"POST"!==t.method&&"PUT"!==t.method||(e.bodyHash=await this.hashRequestBody(t.body)),e}normalizeHeaders(t){const e={},s=["content-type","accept","authorization"];for(const[i,r]of Object.entries(t)){const t=i.toLowerCase();s.includes(t)&&(e[t]=r)}return e}async hashRequestBody(t){try{const e="string"==typeof t?t:JSON.stringify(t);let s=0;for(let t=0;e.length>t;t++)s=(s<<5)-s+e.charCodeAt(t),s&=s;return Math.abs(s).toString(16)}catch(t){return"hash-error"}}getCachedResponse(t){if(!this.config.enableResponseCaching)return null;const e=this.responseCache.get(t);return e?Date.now()-e.cachedAt>this.config.responseCacheTTL?(this.responseCache.delete(t),null):e.response:null}cacheResponse(t,e){if(this.config.enableResponseCaching&&(this.responseCache.set(t,{response:e,cachedAt:Date.now()}),this.responseCache.size>this.config.maxStoredKeys)){const t=this.responseCache.keys().next().value;t&&this.responseCache.delete(t)}}generateIdempotencyKey(t,e,s,i){const r=[t.toUpperCase(),e,i||"anonymous"];if(s)try{const t="string"==typeof s?s:JSON.stringify(s);r.push(t)}catch(t){r.push("body-serialize-error")}return r.join("|")}isPending(t){const e=this.requestMap.get(t);return"pending"===(null==e?void 0:e.status)||!1}getRequestInfo(t){return this.requestMap.get(t)||null}cancelRequest(t){const e=this.requestMap.get(t);return!(!e||"pending"!==e.status||(e.status="failed",e.error=Error("Request cancelled"),e.completedAt=Date.now(),this.pendingRequests.delete(t),this.updateStats(),0))}startKeyCleanup(){this.keyCleanupInterval=setInterval(()=>{this.cleanupExpiredEntries()},3e4)}cleanupExpiredEntries(){const t=Date.now();let e=0;for(const[s,i]of this.requestMap.entries())(t-i.createdAt>this.config.keyTTL||"pending"!==i.status)&&(this.requestMap.delete(s),e++);for(const[s,i]of this.responseCache.entries())t-i.cachedAt>this.config.responseCacheTTL&&(this.responseCache.delete(s),e++);if(this.requestMap.size>this.config.maxStoredKeys){const t=this.requestMap.size-this.config.maxStoredKeys,s=Array.from(this.requestMap.entries()).sort((t,e)=>t[1].createdAt-e[1].createdAt).slice(0,t).map(([t])=>t);for(const t of s)this.requestMap.delete(t),e++}this.stats.keyCleanups+=e,this.updateStats()}updateStats(){this.stats.activePendingRequests=this.pendingRequests.size,this.stats.memoryUsage=this.requestMap.size+this.responseCache.size}getStats(){return this.updateStats(),{...this.stats}}resetStats(){this.stats={totalRequests:0,deduplicatedRequests:0,cacheHits:0,activePendingRequests:0,memoryUsage:0,keyCleanups:0}}clear(){this.requestMap.clear(),this.responseCache.clear(),this.pendingRequests.clear(),this.resetStats()}updateConfig(t){this.config={...this.config,...t}}destroy(){this.keyCleanupInterval&&(clearInterval(this.keyCleanupInterval),this.keyCleanupInterval=null),this.clear()}}class A{constructor(t={}){this.adaptiveBehavior={currentMode:"normal",adaptationCount:0,lastAdaptation:0},this.performanceHistory=[],this.config={retry:{},circuitBreaker:{},storage:{},healthMonitor:{},sync:{},idempotency:{},enableAdaptiveBehavior:!0,performanceThresholds:{slowRequestMs:2e3,verySlowRequestMs:5e3,highErrorRate:.1,criticalErrorRate:.25},...t},this.retryManager=new k(this.config.retry),this.circuitBreakerManager=new T(this.config.circuitBreaker),this.storage=new x(this.config.storage),this.healthMonitor=new I(this.config.healthMonitor),this.syncManager=new _(this.config.sync),this.idempotencyManager=new C(this.config.idempotency),this.config.enableAdaptiveBehavior&&this.startAdaptiveBehaviorMonitoring()}async executeResilientRequest(t,e){const s=Date.now(),{feature:i,priority:r,idempotencyKey:n,region:a}=e;try{return await this.circuitBreakerManager.executeWithBreaker(i,async()=>n?await this.idempotencyManager.executeIdempotent(n,()=>this.executeWithRetryAndHealth(t,e),{method:"POST",url:i,priority:r,bypassCache:e.bypassCache}):await this.executeWithRetryAndHealth(t,e),{priority:r,region:a}),this.recordPerformance(s,!0,i),await t()}catch(n){throw this.recordPerformance(s,!1,i),this.shouldStoreForLaterSync(n,r)&&await this.storeForLaterSync(t,e,n),n}}async executeWithRetryAndHealth(t,e){const{feature:s,priority:i,payloadSize:r,region:n}=e,a=this.healthMonitor.getAdaptiveRecommendation(s,n),o=this.adaptRequestToHealth(e,a);return await this.retryManager.executeWithRetry(`${s}:${n||"default"}`,t,{priority:i,timeout:o.timeout,payloadSize:r,deduplicationKey:o.deduplicationKey})}adaptRequestToHealth(t,e){const s={...t};return e&&(e.adjustedTimeout&&(s.timeout=e.adjustedTimeout),e.useDeduplication&&!s.idempotencyKey&&(s.idempotencyKey=`auto-dedup:${t.feature}:${Date.now()}`)),s}shouldStoreForLaterSync(t,e){var s;return!("critical"===e||("TypeError"!==t.name||!t.message.includes("fetch"))&&!(null===(s=t.message)||void 0===s?void 0:s.includes("timeout"))&&500>t.status)}async storeForLaterSync(t,e,s){const i={operation:""+t,options:e,error:{message:s.message,name:s.name,stack:s.stack},timestamp:Date.now()};await this.storage.storeData(`failed-request:${e.feature}:${Date.now()}`,i,{priority:e.priority,compress:!0,encrypt:!1,tier:"high"===e.priority?"hot":"warm"})}async syncFailedRequests(){const t=await this.storage.getAllDataByPattern("failed-request:*");if(0!==t.length){await this.syncManager.performIntelligentSync("failed-requests",t.map(t=>{var e,s;return{id:t.key,data:t.data,priority:(null===(e=t.metadata)||void 0===e?void 0:e.priority)||"medium",size:JSON.stringify(t.data).length,timestamp:(null===(s=t.metadata)||void 0===s?void 0:s.timestamp)||Date.now(),dependencies:[]}}),{maxBatchSize:50,timeoutMs:3e4,priority:"high"});for(const e of t)await this.storage.deleteData(e.key)}}startAdaptiveBehaviorMonitoring(){setInterval(()=>{this.evaluateAndAdaptBehavior()},3e4)}evaluateAndAdaptBehavior(){if(!this.config.enableAdaptiveBehavior)return;const t=this.getRecentPerformance(3e5);if(0===t.length)return;const e=t.filter(t=>!t.success).length/t.length,s=t.reduce((t,e)=>t+e.duration,0)/t.length;let i="normal";this.config.performanceThresholds.criticalErrorRate>e?this.config.performanceThresholds.highErrorRate>e&&this.config.performanceThresholds.verySlowRequestMs>s&&this.config.performanceThresholds.slowRequestMs>s||(i="degraded"):i="emergency",i!==this.adaptiveBehavior.currentMode&&(this.applyAdaptiveBehaviorMode(i),this.adaptiveBehavior.currentMode=i,this.adaptiveBehavior.adaptationCount++,this.adaptiveBehavior.lastAdaptation=Date.now())}applyAdaptiveBehaviorMode(t){switch(t){case"emergency":this.retryManager.updateConfig({maxAttempts:2,baseDelay:5e3,retryBudget:20}),this.circuitBreakerManager.updateGlobalConfig({failureThreshold:3,recoveryTimeout:3e4,emergencyMode:!0});break;case"degraded":this.retryManager.updateConfig({maxAttempts:3,baseDelay:2e3,retryBudget:50}),this.circuitBreakerManager.updateGlobalConfig({failureThreshold:5,recoveryTimeout:15e3,emergencyMode:!1});break;case"normal":this.retryManager.updateConfig({maxAttempts:5,baseDelay:1e3,retryBudget:100}),this.circuitBreakerManager.updateGlobalConfig({failureThreshold:10,recoveryTimeout:1e4,emergencyMode:!1})}}recordPerformance(t,e,s){const i=Date.now()-t;this.performanceHistory.push({timestamp:Date.now(),duration:i,success:e,feature:s});const r=Date.now()-36e5;this.performanceHistory=this.performanceHistory.filter(t=>t.timestamp>r)}getRecentPerformance(t){const e=Date.now()-t;return this.performanceHistory.filter(t=>t.timestamp>e)}getStats(){return{retry:this.retryManager.getStats(),circuitBreaker:this.circuitBreakerManager.getGlobalStats(),storage:this.storage.getStats(),healthMonitor:this.healthMonitor.getGlobalStats(),sync:this.syncManager.getStats(),idempotency:this.idempotencyManager.getStats(),adaptiveBehavior:{...this.adaptiveBehavior}}}resetAllStats(){this.retryManager.resetStats(),this.circuitBreakerManager.resetStats(),this.storage.resetStats(),this.healthMonitor.resetStats(),this.syncManager.resetStats(),this.idempotencyManager.resetStats(),this.performanceHistory=[],this.adaptiveBehavior={currentMode:"normal",adaptationCount:0,lastAdaptation:0}}updateConfig(t){this.config={...this.config,...t},t.retry&&this.retryManager.updateConfig(t.retry),t.circuitBreaker&&this.circuitBreakerManager.updateGlobalConfig(t.circuitBreaker),t.storage&&this.storage.updateConfig(t.storage),t.healthMonitor&&this.healthMonitor.updateConfig(t.healthMonitor),t.sync&&this.syncManager.updateConfig(t.sync),t.idempotency&&this.idempotencyManager.updateConfig(t.idempotency)}destroy(){this.idempotencyManager.destroy(),this.healthMonitor.destroy(),this.syncManager.destroy()}}export{T as CircuitBreakerManager,m as DataManager,i as ErrorHandler,C as IdempotencyManager,_ as IntelligentSyncManager,D as Monitor,I as MultiRegionalHealthMonitor,n as NetworkMonitor,A as ResilienceCoordinator,x as ResilientStorage,k as RetryManager,r as SessionManager,D as default};
//# sourceMappingURL=index.esm.js.map
