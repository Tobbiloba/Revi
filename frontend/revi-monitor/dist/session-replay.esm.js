class t{constructor(t){this.nodeIdMap=new WeakMap,this.nodeMap=new Map,this.nextNodeId=1,this.isObserving=!1,this.config=t}takeSnapshot(){const t={timestamp:Date.now(),url:window.location.href,viewport:{width:window.innerWidth,height:window.innerHeight},scroll:{x:window.scrollX,y:window.scrollY},nodes:[],stylesheets:[],resources:[]};return t.nodes=this.serializeDocument(document),t.stylesheets=this.serializeStylesheets(),t.resources=this.serializeResources(),t}startObserving(t){this.isObserving||(this.onDOMChange=t,this.observer=new MutationObserver(this.handleMutations.bind(this)),this.observer.observe(document,{childList:!0,attributes:!0,characterData:!0,subtree:!0,attributeOldValue:!0,characterDataOldValue:!0}),this.isObserving=!0)}stopObserving(){this.observer&&(this.observer.disconnect(),this.observer=void 0),this.isObserving=!1,this.onDOMChange=void 0}serializeDocument(t){const e=t.doctype,i=[];if(e&&i.push({type:"document",tagName:"DOCTYPE",attributes:{name:e.name,publicId:e.publicId,systemId:e.systemId},id:this.getNodeId(e)}),t.documentElement){const e=this.serializeNode(t.documentElement);e&&i.push(e)}return i}serializeNode(t){if(this.shouldIgnoreNode(t))return null;const e=this.getNodeId(t),i={type:this.getNodeType(t),id:e};switch(t.nodeType){case Node.ELEMENT_NODE:const e=t;i.tagName=e.tagName.toLowerCase(),i.attributes=this.serializeAttributes(e),i.children=this.serializeChildren(e);break;case Node.TEXT_NODE:const s=t;i.textContent=this.shouldMaskText(s)?"[Masked]":s.textContent||"";break;case Node.COMMENT_NODE:i.textContent=t.textContent||"";break;default:return null}return i}serializeAttributes(t){const e={};for(let i=0;t.attributes.length>i;i++){const s=t.attributes[i],n=s.name.toLowerCase();this.shouldIgnoreAttribute(n,s.value)||(e[n]=this.shouldMaskAttribute(n,t)?"[Masked]":s.value)}return e}serializeChildren(t){const e=[];for(let i=0;t.childNodes.length>i;i++){const s=this.serializeNode(t.childNodes[i]);s&&e.push(s)}return e}serializeStylesheets(){const t=[];for(let e=0;e<document.styleSheets.length;e++){const i=document.styleSheets[e];try{let e="";i.href?e=`/* External stylesheet: ${i.href} */`:i.cssRules&&(e=Array.from(i.cssRules).map(t=>t.cssText).join("\n")),t.push({href:i.href||void 0,cssText:e,disabled:i.disabled})}catch(e){i.href&&t.push({href:i.href,cssText:`/* Could not access stylesheet: ${i.href} */`,disabled:i.disabled})}}return t}serializeResources(){const t=[];return document.querySelectorAll("img").forEach(e=>{e.src&&!this.shouldIgnoreResource(e.src)&&t.push({url:e.src,type:"image",failed:!e.complete||0===e.naturalWidth})}),document.querySelectorAll("*").forEach(e=>{const i=window.getComputedStyle(e).backgroundImage;if(i&&"none"!==i){const e=i.match(/url\(['"]?([^'")]+)['"]?\)/);e&&e[1]&&!this.shouldIgnoreResource(e[1])&&t.push({url:e[1],type:"image"})}}),t}handleMutations(t){t.forEach(t=>{const e=this.nodeIdMap.get(t.target);if(!e)return;const i={timestamp:Date.now(),type:t.type,target:e};switch(t.type){case"childList":t.addedNodes.length>0&&(i.addedNodes=Array.from(t.addedNodes).map(t=>this.serializeNode(t)).filter(t=>null!==t)),t.removedNodes.length>0&&(i.removedNodes=Array.from(t.removedNodes).map(t=>this.nodeIdMap.get(t)).filter(t=>void 0!==t));break;case"attributes":if(i.attributeName=t.attributeName||void 0,t.target.nodeType===Node.ELEMENT_NODE){const e=t.target,s=e.getAttribute(t.attributeName||"");i.attributeValue=this.shouldMaskAttribute(t.attributeName||"",e)?"[Masked]":s||""}i.oldValue=t.oldValue||void 0;break;case"characterData":i.attributeValue=this.shouldMaskText(t.target)?"[Masked]":t.target.textContent||"",i.oldValue=t.oldValue||void 0}this.onDOMChange&&this.onDOMChange(i)})}getNodeId(t){if(this.nodeIdMap.has(t))return this.nodeIdMap.get(t);const e=this.nextNodeId++;return this.nodeIdMap.set(t,e),this.nodeMap.set(e,t),e}getNodeType(t){switch(t.nodeType){case Node.ELEMENT_NODE:return"element";case Node.TEXT_NODE:return"text";case Node.COMMENT_NODE:return"comment";case Node.DOCUMENT_NODE:return"document";default:return"element"}}shouldIgnoreNode(t){var e;if(t.nodeType===Node.ELEMENT_NODE){const i=t,s=i.tagName.toLowerCase();if(["script","noscript","meta"].includes(s))return!0;if(i.hasAttribute("data-revi-ignore"))return!0;if(null===(e=this.config.replay)||void 0===e?void 0:e.blockSelector)try{if(i.matches(this.config.replay.blockSelector))return!0}catch(t){}}return!1}shouldIgnoreAttribute(t,e){return["data-revi-ignore","data-password","data-sensitive"].includes(t)}shouldMaskAttribute(t,e){var i;return!!(null===(i=this.config.privacy)||void 0===i?void 0:i.maskInputs)&&(!("input"!==e.tagName.toLowerCase()||!["password","email","tel"].includes(e.type))&&"value"===t)}shouldMaskText(t){var e,i,s,n;if(!(null===(e=this.config.replay)||void 0===e?void 0:e.maskAllText)&&!(null===(i=this.config.privacy)||void 0===i?void 0:i.maskInputs))return!1;const r=t.parentElement;if(!r)return!1;if(["input","textarea"].includes(r.tagName.toLowerCase()))return!0;if(null===(s=this.config.replay)||void 0===s?void 0:s.maskSelector)try{return r.matches(this.config.replay.maskSelector)}catch(t){return!1}return(null===(n=this.config.replay)||void 0===n?void 0:n.maskAllText)||!1}shouldIgnoreResource(t){try{const e=new URL(t,window.location.href);if("data:"===e.protocol)return!0;if(t.includes("?")){const t=new URLSearchParams(e.search),i=t.get("w")||t.get("width"),s=t.get("h")||t.get("height");if(i&&parseInt(i)>2e3)return!0;if(s&&parseInt(s)>2e3)return!0}return!1}catch(t){return!0}}}class e{constructor(t,e={}){this.originalMethods={},this.entries=[],this.isRecording=!1,this.sessionId=t,this.config={maxEntries:1e3,captureStackTrace:!0,serializeObjects:!0,maxObjectDepth:3,maxStringLength:1e4,ignoredLevels:[],...e}}start(){this.isRecording||(["log","info","warn","error","debug","trace"].forEach(t=>{if(this.config.ignoredLevels.includes(t))return;const e=console[t];this.originalMethods[t]=e,console[t]=(...i)=>{e.apply(console,i),this.recordEntry(t,i)}}),this.isRecording=!0)}stop(){this.isRecording&&(Object.entries(this.originalMethods).forEach(([t,e])=>{console[t]=e}),this.originalMethods={},this.isRecording=!1)}recordEntry(t,e){var i,s;try{const s={id:this.generateId(),timestamp:Date.now(),level:t,args:this.serializeArgs(e)};if(("error"===t||"warn"===t)&&this.config.captureStackTrace){const t=Error();t.stack&&(s.stack=this.cleanStackTrace(t.stack))}if("error"===t&&e[0]instanceof Error){const t=((null===(i=e[0].stack)||void 0===i?void 0:i.split("\n"))||[]).find(t=>t.includes(".js:")||t.includes(".ts:")||t.includes(".tsx:"));if(t){const e=t.match(/([^/]+):(\d+):(\d+)/);e&&(s.url=e[1],s.lineNumber=parseInt(e[2]),s.columnNumber=parseInt(e[3]))}}this.addEntry(s)}catch(t){null===(s=this.originalMethods.warn)||void 0===s||s.call(console,"ConsoleRecorder error:",t)}}serializeArgs(t){return t.map(t=>this.serializeValue(t,0))}serializeValue(t,e){if(e>this.config.maxObjectDepth)return"[Object too deep]";if(null==t)return t;if("string"==typeof t)return t.length>this.config.maxStringLength?t.substring(0,this.config.maxStringLength)+"...":t;if("number"==typeof t||"boolean"==typeof t)return t;if("function"==typeof t)return`[Function: ${t.name||"anonymous"}]`;if(t instanceof Error)return{name:t.name,message:t.message,stack:this.config.captureStackTrace?this.cleanStackTrace(t.stack||""):void 0};if(t instanceof Date)return{t:"Date",value:t.toISOString()};if(t instanceof RegExp)return{t:"RegExp",value:""+t};if(Array.isArray(t))return this.config.serializeObjects?t.slice(0,100).map(t=>this.serializeValue(t,e+1)):"[Array]";if("object"==typeof t){if(!this.config.serializeObjects)return"[Object]";try{const i={},s=Object.keys(t).slice(0,50);for(const n of s)try{i[n]=this.serializeValue(t[n],e+1)}catch(t){i[n]="[Unserializable]"}return Object.keys(t).length>50&&(i["..."]=`[${Object.keys(t).length-50} more keys]`),i}catch(t){return"[Unserializable Object]"}}return t+""}cleanStackTrace(t){return t.split("\n").filter(t=>!t.includes("console-recorder.ts")&&!t.includes("ConsoleRecorder")).slice(0,10).join("\n")}addEntry(t){this.entries.push(t),this.entries.length>this.config.maxEntries&&(this.entries=this.entries.slice(.8*-this.config.maxEntries))}generateId(){return`console-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}getEntries(t,e){let i=this.entries;return t&&(i=i.filter(e=>e.timestamp>=t)),e&&(i=i.filter(t=>e>=t.timestamp)),[...i]}getEntriesByLevel(t){return this.entries.filter(e=>e.level===t)}clear(){this.entries=[]}toSessionEvents(){return this.entries.map(t=>({session_id:this.sessionId,event_type:"console",data:{level:t.level,args:t.args,stack:t.stack,url:t.url,lineNumber:t.lineNumber,columnNumber:t.columnNumber,consoleId:t.id},timestamp:t.timestamp,url:t.url||window.location.href,user_agent:navigator.userAgent}))}exportData(){const t={};let e=1/0,i=-1/0;return this.entries.forEach(s=>{t[s.level]=(t[s.level]||0)+1,e=Math.min(e,s.timestamp),i=Math.max(i,s.timestamp)}),{sessionId:this.sessionId,config:this.config,entries:[...this.entries],stats:{totalEntries:this.entries.length,levelCounts:t,errorCount:t.error||0,warningCount:t.warn||0,timeRange:{start:e===1/0?0:e,end:i===-1/0?0:i}}}}generateInsights(){return{errorPatterns:this.findErrorPatterns(),performanceIssues:this.detectPerformanceIssues(),recommendations:this.generateRecommendations()}}findErrorPatterns(){const t=this.entries.filter(t=>"error"===t.level),e={};return t.forEach(t=>{let i="Unknown Error";if(t.args.length>0){const e=t.args[0];"string"==typeof e?i=e.replace(/\d+/g,"N").replace(/["'][^"']*["']/g,"STRING").replace(/\b\w+@\w+\.\w+/g,"EMAIL").replace(/https?:\/\/[^\s]+/g,"URL").substring(0,100):"object"==typeof e&&e.name&&(i=`${e.name}: ${e.message}`.substring(0,100))}e[i]||(e[i]=[]),e[i].push(t)}),Object.entries(e).sort(([,t],[,e])=>e.length-t.length).slice(0,10).map(([t,e])=>({pattern:t,count:e.length,examples:e.slice(0,3)}))}detectPerformanceIssues(){const t=[],e=this.entries.filter(t=>t.timestamp>Date.now()-6e4);e.length>100&&t.push({type:"Excessive Logging",severity:"medium",details:e.length+" console entries in the last minute may impact performance"});const i={};return this.entries.filter(t=>"error"===t.level).forEach(t=>{const e=JSON.stringify(t.args);i[e]=(i[e]||0)+1}),Object.entries(i).forEach(([e,i])=>{i>10&&t.push({type:"Repeated Error",severity:i>50?"high":"medium",details:`Same error occurred ${i} times`})}),this.entries.filter(t=>t.args.some(t=>"object"==typeof t&&null!==t&&!Array.isArray(t))).length>.5*this.entries.length&&t.push({type:"Object Logging",severity:"low",details:"High percentage of object logging may indicate memory leaks"}),t}generateRecommendations(){const t=[],e=this.exportData().stats;return e.errorCount>0&&t.push(`Found ${e.errorCount} console errors. Review error patterns and fix underlying issues.`),e.warningCount>2*e.errorCount&&t.push("High warning-to-error ratio suggests proactive error handling could prevent issues."),e.totalEntries>500&&t.push("Consider reducing console logging in production to improve performance."),e.levelCounts.debug&&e.levelCounts.debug>100&&t.push("Debug logs should be disabled in production environments."),0===t.length&&t.push("Console logging patterns look healthy."),t}}class i{constructor(t,e={}){this.data=[],this.config={radius:20,maxIntensity:100,gradient:{.4:"blue",.6:"cyan",.7:"lime",.8:"yellow",1:"red"},blur:15,minOpacity:0,maxOpacity:.6,...e},this.canvas=document.createElement("canvas"),this.canvas.style.position="absolute",this.canvas.style.top="0",this.canvas.style.left="0",this.canvas.style.pointerEvents="none",this.canvas.style.zIndex="9999",t.appendChild(this.canvas);const i=this.canvas.getContext("2d");if(!i)throw Error("Failed to get canvas context");this.ctx=i,this.resizeCanvas(),window.addEventListener("resize",()=>this.resizeCanvas())}resizeCanvas(){const t=this.canvas.parentElement.getBoundingClientRect();this.canvas.width=t.width,this.canvas.height=t.height,this.canvas.style.width=t.width+"px",this.canvas.style.height=t.height+"px"}addDataPoint(t,e,i,s){this.data.push({x:t,y:e,intensity:i,event_type:s,timestamp:Date.now()}),this.data.length>1e4&&(this.data=this.data.slice(-8e3))}generateFromEvents(t){this.data=[],t.forEach(t=>{var e,i,s,n,r,o;"click"===t.event_type&&(null===(e=t.data)||void 0===e?void 0:e.x)&&(null===(i=t.data)||void 0===i?void 0:i.y)?this.addDataPoint(t.data.x,t.data.y,10,"click"):"mousemove"===t.event_type&&(null===(s=t.data)||void 0===s?void 0:s.x)&&(null===(n=t.data)||void 0===n?void 0:n.y)?this.addDataPoint(t.data.x,t.data.y,2,"move"):"scroll"===t.event_type&&void 0!==(null===(r=t.data)||void 0===r?void 0:r.scrollX)&&void 0!==(null===(o=t.data)||void 0===o?void 0:o.scrollY)&&this.addDataPoint(t.data.scrollX||0,t.data.scrollY||0,5,"scroll")})}render(t){if(this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),0===this.data.length)return;const e=t?this.data.filter(e=>t.includes(e.event_type)):this.data,i=this.createIntensityMap(e),s=this.createGradient();this.renderHeatmap(i,s)}createIntensityMap(t){const e=document.createElement("canvas");e.width=this.canvas.width,e.height=this.canvas.height;const i=e.getContext("2d");return t.forEach(t=>{const e=this.config.radius,s=i.createRadialGradient(t.x,t.y,0,t.x,t.y,e);s.addColorStop(0,`rgba(0, 0, 0, ${Math.min(t.intensity/this.config.maxIntensity,1)})`),s.addColorStop(1,"rgba(0, 0, 0, 0)"),i.fillStyle=s,i.fillRect(t.x-e,t.y-e,2*e,2*e)}),i.filter=`blur(${this.config.blur}px)`,i.drawImage(e,0,0),i.getImageData(0,0,e.width,e.height)}createGradient(){const t=document.createElement("canvas");t.width=256,t.height=1;const e=t.getContext("2d"),i=e.createLinearGradient(0,0,256,0);return Object.entries(this.config.gradient).forEach(([t,e])=>{i.addColorStop(parseFloat(t),e)}),e.fillStyle=i,e.fillRect(0,0,256,1),e.getImageData(0,0,256,1)}renderHeatmap(t,e){const i=this.ctx.createImageData(t.width,t.height);for(let s=0;t.data.length>s;s+=4){const n=t.data[s+3];if(n>0){const t=4*Math.floor(n/255*255);i.data[s]=e.data[t],i.data[s+1]=e.data[t+1],i.data[s+2]=e.data[t+2],i.data[s+3]=Math.floor(n*this.config.maxOpacity)}}this.ctx.putImageData(i,0,0)}clear(){this.data=[],this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)}destroy(){this.clear(),this.canvas.parentElement&&this.canvas.parentElement.removeChild(this.canvas),window.removeEventListener("resize",()=>this.resizeCanvas())}exportData(){const t={};let e=1/0,i=-1/0,s=1/0,n=-1/0,r=1/0,o=-1/0;return this.data.forEach(a=>{t[a.event_type]=(t[a.event_type]||0)+1,e=Math.min(e,a.x),i=Math.max(i,a.x),s=Math.min(s,a.y),n=Math.max(n,a.y),r=Math.min(r,a.timestamp),o=Math.max(o,a.timestamp)}),{config:this.config,data:[...this.data],stats:{totalEvents:this.data.length,eventTypes:t,timeRange:{start:r,end:o},bounds:{minX:e,maxX:i,minY:s,maxY:n}}}}generateInsights(){return{hotSpots:this.findHotSpots(),clickPatterns:this.analyzeClickPatterns(),userBehavior:this.analyzeUserBehavior()}}findHotSpots(){const t=[],e=2*this.config.radius;return this.data.forEach(i=>{let s=!1;for(const n of t)if(e>=Math.sqrt(Math.pow(i.x-n.x,2)+Math.pow(i.y-n.y,2))){n.x=(n.x*n.count+i.x)/(n.count+1),n.y=(n.y*n.count+i.y)/(n.count+1),n.intensity+=i.intensity,n.count++,s=!0;break}s||t.push({x:i.x,y:i.y,intensity:i.intensity,count:1})}),t.filter(t=>t.count>=3).sort((t,e)=>e.intensity-t.intensity).slice(0,10).map(t=>({x:Math.round(t.x),y:Math.round(t.y),intensity:Math.round(t.intensity),radius:Math.min(e,5*t.count)}))}analyzeClickPatterns(){const t=this.data.filter(t=>"click"===t.event_type),e={};for(let i=0;t.length-1>i;i++){const s=t[i],n=t[i+1];if(5e3>n.timestamp-s.timestamp){const t=`(${Math.round(s.x)},${Math.round(s.y)}) -> (${Math.round(n.x)},${Math.round(n.y)})`;e[t]=(e[t]||0)+1}}return Object.entries(e).sort(([,t],[,e])=>e-t).slice(0,5).map(([t,e])=>({pattern:t,frequency:e}))}analyzeUserBehavior(){const t=this.data.filter(t=>"click"===t.event_type),e=this.data.filter(t=>"scroll"===t.event_type),i=[...this.data].sort((t,e)=>e.intensity-t.intensity),s=i.slice(0,Math.floor(.5*i.length)),n=Math.min(...s.map(t=>t.x)),r=Math.max(...s.map(t=>t.x)),o=Math.min(...s.map(t=>t.y)),a=Math.max(...s.map(t=>t.y)),h=e.length>0?Math.max(...e.map(t=>t.y))/this.canvas.height:0,c=Math.min(100,2*t.length+50*h+.1*this.data.filter(t=>"move"===t.event_type).length);return{mostActiveArea:{x:Math.round(n),y:Math.round(o),width:Math.round(r-n),height:Math.round(a-o)},averageClicksPerSession:Math.round(t.length),scrollDepth:Math.round(100*h)/100,engagementScore:Math.round(c)}}}class s{constructor(s,n){var r,o,a,h,c,l,u,d,v,p,m,f,y,g,w,b,M;if(this.heatmapGenerator=null,this.events=[],this.consoleLogs=[],this.networkRequests=new Map,this.isRecording=!1,this.originalConsole={},this.config=s,this.sessionId=n,this.startTime=Date.now(),this.domSerializer=new t(s),this.consoleRecorder=new e(n,{maxEntries:(null===(r=s.replay)||void 0===r?void 0:r.maxConsoleEntries)||1e3,captureStackTrace:!1!==(null===(o=s.replay)||void 0===o?void 0:o.captureStackTrace),serializeObjects:!1!==(null===(a=s.replay)||void 0===a?void 0:a.serializeObjects),maxObjectDepth:(null===(h=s.replay)||void 0===h?void 0:h.maxObjectDepth)||3,maxStringLength:(null===(c=s.replay)||void 0===c?void 0:c.maxStringLength)||1e4,ignoredLevels:(null===(l=s.replay)||void 0===l?void 0:l.ignoredConsoleLevels)||[]}),(null===(u=this.config.replay)||void 0===u?void 0:u.enabled)&&(this.setupReplay(),(null===(v=null===(d=this.config.replay)||void 0===d?void 0:d.heatmaps)||void 0===v?void 0:v.enabled)&&"undefined"!=typeof document)){const t=document.body||document.documentElement;t&&(this.heatmapGenerator=new i(t,{radius:(null===(m=null===(p=s.replay)||void 0===p?void 0:p.heatmaps)||void 0===m?void 0:m.radius)||20,maxIntensity:(null===(y=null===(f=s.replay)||void 0===f?void 0:f.heatmaps)||void 0===y?void 0:y.maxIntensity)||100,blur:(null===(w=null===(g=s.replay)||void 0===g?void 0:g.heatmaps)||void 0===w?void 0:w.blur)||15,maxOpacity:(null===(M=null===(b=s.replay)||void 0===b?void 0:b.heatmaps)||void 0===M?void 0:M.maxOpacity)||.6}))}}startRecording(){var t;!this.isRecording&&(null===(t=this.config.replay)||void 0===t?void 0:t.enabled)&&(this.isRecording=!0,this.takeFullSnapshot(),this.domSerializer.startObserving(this.handleDOMChange.bind(this)),this.consoleRecorder.start(),this.setupNetworkCapture(),this.setupInteractionTracking(),setInterval(()=>{this.isRecording&&this.takeFullSnapshot()},6e4))}stopRecording(){this.isRecording&&(this.isRecording=!1,this.domSerializer.stopObserving(),this.consoleRecorder.stop(),this.restoreOriginalNetwork(),this.heatmapGenerator&&(this.heatmapGenerator.destroy(),this.heatmapGenerator=null))}getReplayData(){const t=this.consoleRecorder.getEntries(),e=this.consoleRecorder.generateInsights();let i,s;return this.heatmapGenerator&&(i=this.heatmapGenerator.exportData().data,s=this.heatmapGenerator.generateInsights()),{events:[...this.events],console_logs:t,network_requests:Array.from(this.networkRequests.values()),heatmap_data:i,session_info:{session_id:this.sessionId,start_time:this.startTime,duration:Date.now()-this.startTime,page_url:window.location.href},analytics:{console_insights:e,heatmap_insights:s}}}clearReplayData(){this.events=[],this.consoleLogs=[],this.networkRequests.clear(),this.consoleRecorder.clear(),this.heatmapGenerator&&this.heatmapGenerator.clear()}setupReplay(){if("undefined"==typeof window)return;let t;document.addEventListener("visibilitychange",()=>{this.addCustomEvent("visibility_change",{hidden:document.hidden})}),window.addEventListener("focus",()=>{this.addCustomEvent("window_focus",{})}),window.addEventListener("blur",()=>{this.addCustomEvent("window_blur",{})}),window.addEventListener("resize",()=>{this.addCustomEvent("viewport_change",{width:window.innerWidth,height:window.innerHeight})}),window.addEventListener("scroll",()=>{clearTimeout(t),t=setTimeout(()=>{this.heatmapGenerator&&this.heatmapGenerator.addDataPoint(window.scrollX||0,window.scrollY||0,5,"scroll"),this.addCustomEvent("scroll",{x:window.scrollX,y:window.scrollY})},100)},{passive:!0})}takeFullSnapshot(){if(this.isRecording)try{const t=this.domSerializer.takeSnapshot();this.addEvent({type:"full_snapshot",timestamp:Date.now(),data:t})}catch(t){}}handleDOMChange(t){this.isRecording&&this.addEvent({type:"incremental_snapshot",timestamp:t.timestamp,data:{source:"mutation",...t}})}renderHeatmap(t){this.heatmapGenerator&&this.heatmapGenerator.render(t)}toggleHeatmap(t){this.heatmapGenerator&&(t?this.heatmapGenerator.render():this.heatmapGenerator.clear())}getHeatmapInsights(){var t;return(null===(t=this.heatmapGenerator)||void 0===t?void 0:t.generateInsights())||null}setupNetworkCapture(){if(void 0!==window.fetch&&(this.originalFetch=window.fetch,window.fetch=async(t,e)=>{const i=Date.now(),s=this.generateRequestId(),n=t instanceof Request?t.url:""+t,r=(null==e?void 0:e.method)||(t instanceof Request?t.method:"GET");this.isRecording&&this.networkRequests.set(s,{timestamp:i,id:s,method:r,url:n,requestHeaders:this.getRequestHeaders(e,t),requestBody:await this.serializeRequestBody(e,t)});try{const n=await this.originalFetch(t,e),r=Date.now()-i;if(this.isRecording){const t=this.networkRequests.get(s);if(t&&(t.status=n.status,t.duration=r,t.responseHeaders=this.getResponseHeaders(n),this.shouldCaptureResponseBody(n)))try{const e=n.clone();t.responseBody=await e.text()}catch(t){}}return n}catch(t){const e=Date.now()-i;if(this.isRecording){const t=this.networkRequests.get(s);t&&(t.duration=e,t.failed=!0)}throw t}}),"undefined"!=typeof XMLHttpRequest){this.originalXMLHttpRequest=XMLHttpRequest;const t=this;window.XMLHttpRequest=function(){const e=new t.originalXMLHttpRequest,i=t.generateRequestId();let s="GET",n="",r=0;const o=e.open,a=e.send;return e.open=function(t,e,...i){return s=t,n=""+e,o.call(this,t,e,...i)},e.send=function(e){return r=Date.now(),t.isRecording&&t.networkRequests.set(i,{timestamp:r,id:i,method:s,url:n,requestBody:e}),a.call(this,e)},e.addEventListener("loadend",()=>{const s=Date.now()-r;if(t.isRecording){const n=t.networkRequests.get(i);n&&(n.status=e.status,n.duration=s,n.failed=0===e.status||e.status>=400,t.shouldCaptureXHRResponse(e)&&(n.responseBody=e.responseText))}}),e}}}setupInteractionTracking(){["mousedown","mouseup","click","dblclick","mousemove"].forEach(t=>{document.addEventListener(t,e=>{if(this.isRecording&&("mousemove"!==t||.1>=Math.random())){if(this.heatmapGenerator){let i=1;"click"===t?i=10:"mousemove"===t?i=2:"mousedown"===t&&(i=5),this.heatmapGenerator.addDataPoint(e.clientX,e.clientY,i,"click"===t?"click":"move")}this.addEvent({type:"incremental_snapshot",timestamp:Date.now(),data:{source:"mouse",type:t,x:e.clientX,y:e.clientY,id:this.getElementId(e.target)}})}},{capture:!0,passive:!0})}),document.addEventListener("keydown",t=>{this.isRecording&&(this.shouldIgnoreKeystroke(t)||this.addEvent({type:"incremental_snapshot",timestamp:Date.now(),data:{source:"keyboard",type:"keydown",key:this.sanitizeKey(t.key),code:t.code,id:this.getElementId(t.target)}}))},{capture:!0,passive:!0})}addEvent(t){this.events.push(t),this.events.length>1e4&&(this.events=this.events.slice(-8e3))}addCustomEvent(t,e){this.addEvent({type:"custom",timestamp:Date.now(),data:{type:t,...e}})}serializeConsoleArgs(t){return t.map(t=>{try{return"object"==typeof t&&null!==t?JSON.parse(JSON.stringify(t)):t}catch(t){return"[Unserializable Object]"}})}generateRequestId(){return Date.now().toString(36)+Math.random().toString(36).substr(2)}getRequestHeaders(t,e){const i={};return(null==t?void 0:t.headers)&&(t.headers instanceof Headers?t.headers.forEach((t,e)=>{i[e]=t}):Array.isArray(t.headers)?t.headers.forEach(([t,e])=>{i[t]=e}):Object.assign(i,t.headers)),e instanceof Request&&e.headers.forEach((t,e)=>{i[e]=t}),i}getResponseHeaders(t){const e={};return t.headers.forEach((t,i)=>{e[i]=t}),e}async serializeRequestBody(t,e){let i=null==t?void 0:t.body;if(e instanceof Request&&!i)try{i=await e.clone().text()}catch(t){return null}if(!i)return null;if("string"==typeof i)return i.length>1e4?i.substring(0,1e4)+"...[truncated]":i;if(i instanceof FormData){const t={};return i.forEach((e,i)=>{t[i]=e instanceof File?`[File: ${e.name}]`:e}),t}return"[Binary Data]"}shouldCaptureResponseBody(t){const e=t.headers.get("content-type")||"",i=parseInt(t.headers.get("content-length")||"0");return e.includes("application/json")||e.includes("text/")||i>0&&1e5>i}shouldCaptureXHRResponse(t){const e=t.getResponseHeader("content-type")||"";return e.includes("application/json")||e.includes("text/")||t.responseText&&1e5>t.responseText.length}getElementId(t){return t?Math.random():void 0}shouldIgnoreKeystroke(t){const e=t.target;if(e&&e.tagName){if("input"===e.tagName.toLowerCase()&&"password"===e.type)return!0;if(e.hasAttribute("data-revi-ignore"))return!0}return!1}sanitizeKey(t){return 1===t.length&&/[a-zA-Z0-9]/.test(t)?"*":t}restoreOriginalNetwork(){this.originalFetch&&(window.fetch=this.originalFetch),this.originalXMLHttpRequest&&(window.XMLHttpRequest=this.originalXMLHttpRequest)}}export{s as SessionReplayManager};
//# sourceMappingURL=session-replay.esm.js.map
