class t{constructor(t){this.nodeIdMap=new WeakMap,this.nodeMap=new Map,this.nextNodeId=1,this.isObserving=!1,this.layoutShiftEntries=[],this.computedStyleCache=new WeakMap,this.setupPerformanceObserver(),this.setupStylesheetTracking()}takeEnhancedSnapshot(){performance.now();const t={timestamp:Date.now(),url:window.location.href,title:document.title,viewport:{width:window.innerWidth,height:window.innerHeight,devicePixelRatio:window.devicePixelRatio,scrollX:window.scrollX,scrollY:window.scrollY},nodes:[],stylesheets:[],resources:[],performance:this.capturePerformanceMetrics(),environment:this.captureEnvironmentInfo()};return t.nodes=this.serializeDocumentEnhanced(document),t.stylesheets=this.serializeStylesheetsEnhanced(),t.resources=this.serializeResourcesEnhanced(),performance.now(),t}startEnhancedObserving(t){this.isObserving||(this.onDOMChange=t,this.observer=new MutationObserver(this.handleEnhancedMutations.bind(this)),this.observer.observe(document,{childList:!0,attributes:!0,characterData:!0,subtree:!0,attributeOldValue:!0,characterDataOldValue:!0,attributeFilter:void 0}),"undefined"!=typeof ResizeObserver&&(this.resizeObserver=new ResizeObserver(this.handleResizeChanges.bind(this)),this.resizeObserver.observe(document.documentElement)),this.isObserving=!0)}stopEnhancedObserving(){this.observer&&(this.observer.disconnect(),this.observer=void 0),this.resizeObserver&&(this.resizeObserver.disconnect(),this.resizeObserver=void 0),this.performanceObserver&&this.performanceObserver.disconnect(),this.isObserving=!1,this.onDOMChange=void 0}serializeDocumentEnhanced(t){const e=[];if(t.doctype&&e.push(this.serializeDoctype(t.doctype)),t.documentElement){const i=this.serializeNodeEnhanced(t.documentElement);i&&e.push(i)}return e}serializeNodeEnhanced(t){if(this.shouldIgnoreNode(t))return null;const e={id:this.getNodeId(t),type:this.getNodeType(t),renderTime:performance.now()};switch(t.nodeType){case Node.ELEMENT_NODE:const i=t;e.tagName=i.tagName.toLowerCase(),e.attributes=this.serializeAttributesEnhanced(i),e.computedStyles=this.captureComputedStyles(i),e.inlineStyles=this.captureInlineStyles(i),e.boundingRect=i.getBoundingClientRect(),e.visibility=this.captureVisibilityInfo(i),e.interactionState=this.captureInteractionState(i),this.isFormElement(i)&&(e.inputValue=this.captureInputValue(i),e.selectedOptions=this.captureSelectedOptions(i)),(i.scrollWidth>i.clientWidth||i.scrollHeight>i.clientHeight)&&(e.scrollPosition={x:i.scrollLeft,y:i.scrollTop}),e.children=this.serializeChildrenEnhanced(i);break;case Node.TEXT_NODE:const s=t;e.textContent=this.shouldMaskText(s)?"[Masked Text]":s.textContent||"";break;case Node.COMMENT_NODE:e.textContent=t.textContent||"";break;default:return null}return e}captureComputedStyles(t){if(this.computedStyleCache.has(t))return this.computedStyleCache.get(t);const e=window.getComputedStyle(t),i={};return["display","position","top","right","bottom","left","width","height","margin","margin-top","margin-right","margin-bottom","margin-left","padding","padding-top","padding-right","padding-bottom","padding-left","border","border-width","border-style","border-color","border-radius","box-sizing","overflow","overflow-x","overflow-y","z-index","flex","flex-direction","flex-wrap","justify-content","align-items","align-self","flex-grow","flex-shrink","flex-basis","order","grid","grid-template","grid-area","justify-self","align-self","font","font-family","font-size","font-weight","font-style","line-height","text-align","text-decoration","text-transform","letter-spacing","word-spacing","color","text-shadow","background","background-color","background-image","background-size","background-position","background-repeat","background-attachment","opacity","visibility","transform","filter","backdrop-filter","box-shadow","clip-path","transition","animation","will-change","cursor","pointer-events","user-select","resize"].forEach(t=>{const s=e.getPropertyValue(t);s&&"initial"!==s&&"inherit"!==s&&(i[t]=s)}),this.computedStyleCache.set(t,i),i}captureInlineStyles(t){const e={};if(t instanceof HTMLElement&&t.style.length>0)for(let i=0;t.style.length>i;i++){const s=t.style.item(i),n=t.style.getPropertyValue(s),r=t.style.getPropertyPriority(s);e[s]=r?`${n} !${r}`:n}return e}captureVisibilityInfo(t){const e=window.getComputedStyle(t),i=t.getBoundingClientRect();return{visible:i.width>0&&i.height>0&&"hidden"!==e.visibility,opacity:parseFloat(e.opacity),display:e.display,zIndex:parseInt(e.zIndex)||0}}captureInteractionState(t){const e={focused:document.activeElement===t,hovered:t.matches(":hover"),pressed:t.matches(":active"),disabled:t instanceof HTMLElement&&t.hasAttribute("disabled")};return t instanceof HTMLInputElement?"checkbox"!==t.type&&"radio"!==t.type||(e.checked=t.checked):t instanceof HTMLSelectElement&&(e.selected=-1!==t.selectedIndex),e}captureInputValue(t){return t instanceof HTMLInputElement?"password"===t.type||t.hasAttribute("data-sensitive")?"[Masked]":t.value:t instanceof HTMLTextAreaElement||t instanceof HTMLSelectElement?t.value:void 0}captureSelectedOptions(t){if(t instanceof HTMLSelectElement&&t.multiple){const e=[];for(let i=0;t.options.length>i;i++)t.options[i].selected&&e.push(t.options[i].value);return e}}serializeStylesheetsEnhanced(){const t=[];for(let e=0;e<document.styleSheets.length;e++)try{const i=document.styleSheets[e],s=this.processStylesheet(i);s&&t.push(s)}catch(t){}return t}processStylesheet(t){try{const e=[];if(t.cssRules)for(let i=0;t.cssRules.length>i;i++){const s=this.processCSSRule(t.cssRules[i]);s&&e.push(s)}return{href:t.href||void 0,cssText:this.extractCSSText(t),disabled:t.disabled,media:t.media.mediaText,title:t.title||void 0,type:t.type,origin:"author",rules:e,size:this.estimateStylesheetSize(t)}}catch(t){return null}}processCSSRule(t){const e={type:t.type,cssText:t.cssText};return t instanceof CSSStyleRule?(e.selectorText=t.selectorText,e.declarations=this.extractDeclarations(t.style),e.specificity=this.calculateSpecificity(t.selectorText)):t instanceof CSSMediaRule&&(e.media=t.media.mediaText),e}extractDeclarations(t){const e=[];for(let i=0;t.length>i;i++){const s=t.item(i),n=t.getPropertyValue(s),r=t.getPropertyPriority(s);e.push({property:s,value:n,priority:r,important:"important"===r})}return e}calculateSpecificity(t){return 100*(t.match(/#[^\s\+>~\.\[:]+/g)||[]).length+10*((t.match(/\.[^\s\+>~\.\[:]+/g)||[]).length+(t.match(/\[[^\]]+\]/g)||[]).length+(t.match(/:[^\s\+>~\.\[:]+/g)||[]).length)+(t.match(/[^\s\+>~\.\[:]+/g)||[]).length}serializeResourcesEnhanced(){const t=[],e=new Set;return document.querySelectorAll("img").forEach(i=>{e.has(i.src)||(e.add(i.src),t.push(this.createImageResource(i)))}),"performance"in window&&performance.getEntriesByType&&performance.getEntriesByType("resource").forEach(i=>{e.has(i.name)||(e.add(i.name),t.push(this.createResourceFromPerformanceEntry(i)))}),t}createImageResource(t){return{url:t.src,type:"image",dimensions:{width:t.naturalWidth,height:t.naturalHeight},size:void 0,failed:!t.complete||0===t.naturalWidth}}createResourceFromPerformanceEntry(t){return{url:t.name,type:this.inferResourceType(t.name),size:t.transferSize,loadTime:t.responseEnd-t.requestStart,fromCache:0===t.transferSize&&t.decodedBodySize>0}}handleEnhancedMutations(t){t.forEach(t=>{var e;const i={timestamp:Date.now(),type:t.type,target:this.getNodeId(t.target),oldValue:t.oldValue||void 0,renderingTime:performance.now()};switch(t.type){case"childList":t.addedNodes.length>0&&(i.addedNodes=Array.from(t.addedNodes).map(t=>this.serializeNodeEnhanced(t)).filter(t=>null!==t)),t.removedNodes.length>0&&(i.removedNodes=Array.from(t.removedNodes).map(t=>this.getNodeId(t)).filter(t=>void 0!==t));break;case"attributes":i.attributeName=t.attributeName||void 0,t.target instanceof Element&&(i.attributeValue=t.target.getAttribute(t.attributeName)||void 0,"class"===t.attributeName?i.classChanges=this.analyzeClassChanges(t.oldValue,i.attributeValue):"style"===t.attributeName&&(i.styleChanges=this.analyzeStyleChanges(t.target)))}i.visualChange=this.analyzeVisualImpact(t),null===(e=this.onDOMChange)||void 0===e||e.call(this,i)})}setupPerformanceObserver(){"undefined"!=typeof PerformanceObserver&&(this.performanceObserver=new PerformanceObserver(t=>{t.getEntries().forEach(t=>{"layout-shift"===t.entryType&&this.layoutShiftEntries.push(t)})}),this.performanceObserver.observe({entryTypes:["layout-shift","paint","measure"]}))}setupStylesheetTracking(){new MutationObserver(t=>{t.forEach(t=>{t.addedNodes.forEach(t=>{t instanceof HTMLLinkElement&&"stylesheet"===t.rel||HTMLStyleElement})})}).observe(document.head,{childList:!0})}capturePerformanceMetrics(){var t;if(!("performance"in window))return;const e=performance.getEntriesByType("navigation")[0],i=performance.getEntriesByType("paint");return{domContentLoaded:(null==e?void 0:e.domContentLoadedEventEnd)||0,loadComplete:(null==e?void 0:e.loadEventEnd)||0,paintTimings:i.reduce((t,e)=>(t[e.name]=e.startTime,t),{}),layoutShifts:[...this.layoutShiftEntries],memoryUsage:(null===(t=performance.memory)||void 0===t?void 0:t.usedJSHeapSize)||0}}captureEnvironmentInfo(){return{userAgent:navigator.userAgent,language:navigator.language,timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,colorScheme:window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light",reducedMotion:window.matchMedia("(prefers-reduced-motion: reduce)").matches}}shouldIgnoreNode(t){return!1}getNodeType(t){switch(t.nodeType){case Node.ELEMENT_NODE:return"element";case Node.TEXT_NODE:return"text";case Node.COMMENT_NODE:return"comment";case Node.DOCUMENT_NODE:return"document";case Node.DOCUMENT_TYPE_NODE:return"doctype";default:return"element"}}getNodeId(t){if(!this.nodeIdMap.has(t)){const e=this.nextNodeId++;this.nodeIdMap.set(t,e),this.nodeMap.set(e,t)}return this.nodeIdMap.get(t)}serializeDoctype(t){return{id:this.getNodeId(t),type:"doctype",tagName:"DOCTYPE",attributes:{name:t.name,publicId:t.publicId,systemId:t.systemId}}}serializeAttributesEnhanced(t){const e={};for(let i=0;t.attributes.length>i;i++){const s=t.attributes[i],n=s.name.toLowerCase();this.shouldIgnoreAttribute(n,s.value)||(e[n]=this.shouldMaskAttribute(n,t)?"[Masked]":s.value)}return e}serializeChildrenEnhanced(t){const e=[];for(let i=0;t.childNodes.length>i;i++){const s=this.serializeNodeEnhanced(t.childNodes[i]);s&&e.push(s)}return e}shouldMaskText(t){var e,i;const s=t.parentElement;if(!s)return!1;const n=null===(e=s.tagName)||void 0===e?void 0:e.toLowerCase(),r=null===(i=s.type)||void 0===i?void 0:i.toLowerCase();return"input"===n&&"password"===r||s.hasAttribute("data-sensitive")||null!==s.closest("[data-sensitive]")}isFormElement(t){const e=t.tagName.toLowerCase();return["input","textarea","select"].includes(e)}shouldIgnoreAttribute(t,e){return t.startsWith("on")||"style"===t&&e.length>1e3}shouldMaskAttribute(t,e){return"value"===t&&"password"===e.type||e.hasAttribute("data-sensitive")}handleResizeChanges(t){t.forEach(t=>{var e;const i={timestamp:Date.now(),type:"attributes",target:this.getNodeId(t.target),attributeName:"resize",renderingTime:performance.now(),visualChange:{affectedArea:t.contentRect,significance:"moderate"}};null===(e=this.onDOMChange)||void 0===e||e.call(this,i)})}analyzeClassChanges(t,e){const i=t?t.split(/\s+/).filter(Boolean):[],s=e?e.split(/\s+/).filter(Boolean):[];return{added:s.filter(t=>!i.includes(t)),removed:i.filter(t=>!s.includes(t))}}analyzeStyleChanges(t){return[]}analyzeVisualImpact(t){if(t.target instanceof Element){const e=t.target.getBoundingClientRect();return{affectedArea:e,significance:e.width*e.height>1e4?"major":e.width*e.height>1e3?"moderate":"minor"}}}extractCSSText(t){try{if(t.cssRules)return Array.from(t.cssRules).map(t=>t.cssText).join("\n")}catch(t){}return""}estimateStylesheetSize(t){return this.extractCSSText(t).length}inferResourceType(t){var e;switch(null===(e=t.split(".").pop())||void 0===e?void 0:e.toLowerCase()){case"jpg":case"jpeg":case"png":case"gif":case"svg":case"webp":return"image";case"woff":case"woff2":case"ttf":case"otf":return"font";case"mp4":case"webm":case"ogg":return"media";case"js":return"script";case"css":return"stylesheet";default:return"fetch"}}}class e{constructor(t,e={}){this.originalMethods={},this.entries=[],this.isRecording=!1,this.sessionId=t,this.config={maxEntries:1e3,captureStackTrace:!0,serializeObjects:!0,maxObjectDepth:3,maxStringLength:1e4,ignoredLevels:[],...e}}start(){this.isRecording||(["log","info","warn","error","debug","trace"].forEach(t=>{if(this.config.ignoredLevels.includes(t))return;const e=console[t];this.originalMethods[t]=e,console[t]=(...i)=>{e.apply(console,i),this.recordEntry(t,i)}}),this.isRecording=!0)}stop(){this.isRecording&&(Object.entries(this.originalMethods).forEach(([t,e])=>{console[t]=e}),this.originalMethods={},this.isRecording=!1)}recordEntry(t,e){var i,s;try{const s={id:this.generateId(),timestamp:Date.now(),level:t,args:this.serializeArgs(e)};if(("error"===t||"warn"===t)&&this.config.captureStackTrace){const t=Error();t.stack&&(s.stack=this.cleanStackTrace(t.stack))}if("error"===t&&e[0]instanceof Error){const t=((null===(i=e[0].stack)||void 0===i?void 0:i.split("\n"))||[]).find(t=>t.includes(".js:")||t.includes(".ts:")||t.includes(".tsx:"));if(t){const e=t.match(/([^/]+):(\d+):(\d+)/);e&&(s.url=e[1],s.lineNumber=parseInt(e[2]),s.columnNumber=parseInt(e[3]))}}this.addEntry(s)}catch(t){null===(s=this.originalMethods.warn)||void 0===s||s.call(console,"ConsoleRecorder error:",t)}}serializeArgs(t){return t.map(t=>this.serializeValue(t,0))}serializeValue(t,e){if(e>this.config.maxObjectDepth)return"[Object too deep]";if(null==t)return t;if("string"==typeof t)return t.length>this.config.maxStringLength?t.substring(0,this.config.maxStringLength)+"...":t;if("number"==typeof t||"boolean"==typeof t)return t;if("function"==typeof t)return`[Function: ${t.name||"anonymous"}]`;if(t instanceof Error)return{name:t.name,message:t.message,stack:this.config.captureStackTrace?this.cleanStackTrace(t.stack||""):void 0};if(t instanceof Date)return{t:"Date",value:t.toISOString()};if(t instanceof RegExp)return{t:"RegExp",value:""+t};if(Array.isArray(t))return this.config.serializeObjects?t.slice(0,100).map(t=>this.serializeValue(t,e+1)):"[Array]";if("object"==typeof t){if(!this.config.serializeObjects)return"[Object]";try{const i={},s=Object.keys(t).slice(0,50);for(const n of s)try{i[n]=this.serializeValue(t[n],e+1)}catch(t){i[n]="[Unserializable]"}return Object.keys(t).length>50&&(i["..."]=`[${Object.keys(t).length-50} more keys]`),i}catch(t){return"[Unserializable Object]"}}return t+""}cleanStackTrace(t){return t.split("\n").filter(t=>!t.includes("console-recorder.ts")&&!t.includes("ConsoleRecorder")).slice(0,10).join("\n")}addEntry(t){this.entries.push(t),this.entries.length>this.config.maxEntries&&(this.entries=this.entries.slice(.8*-this.config.maxEntries))}generateId(){return`console-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}getEntries(t,e){let i=this.entries;return t&&(i=i.filter(e=>e.timestamp>=t)),e&&(i=i.filter(t=>e>=t.timestamp)),[...i]}getEntriesByLevel(t){return this.entries.filter(e=>e.level===t)}clear(){this.entries=[]}toSessionEvents(){return this.entries.map(t=>({sessionId:this.sessionId,type:"console",data:{level:t.level,args:t.args,stack:t.stack,url:t.url,lineNumber:t.lineNumber,columnNumber:t.columnNumber,consoleId:t.id,originalUrl:t.url||window.location.href,userAgent:navigator.userAgent},timestamp:t.timestamp}))}exportData(){const t={};let e=1/0,i=-1/0;return this.entries.forEach(s=>{t[s.level]=(t[s.level]||0)+1,e=Math.min(e,s.timestamp),i=Math.max(i,s.timestamp)}),{sessionId:this.sessionId,config:this.config,entries:[...this.entries],stats:{totalEntries:this.entries.length,levelCounts:t,errorCount:t.error||0,warningCount:t.warn||0,timeRange:{start:e===1/0?0:e,end:i===-1/0?0:i}}}}generateInsights(){return{errorPatterns:this.findErrorPatterns(),performanceIssues:this.detectPerformanceIssues(),recommendations:this.generateRecommendations()}}findErrorPatterns(){const t=this.entries.filter(t=>"error"===t.level),e={};return t.forEach(t=>{let i="Unknown Error";if(t.args.length>0){const e=t.args[0];"string"==typeof e?i=e.replace(/\d+/g,"N").replace(/["'][^"']*["']/g,"STRING").replace(/\b\w+@\w+\.\w+/g,"EMAIL").replace(/https?:\/\/[^\s]+/g,"URL").substring(0,100):"object"==typeof e&&e.name&&(i=`${e.name}: ${e.message}`.substring(0,100))}e[i]||(e[i]=[]),e[i].push(t)}),Object.entries(e).sort(([,t],[,e])=>e.length-t.length).slice(0,10).map(([t,e])=>({pattern:t,count:e.length,examples:e.slice(0,3)}))}detectPerformanceIssues(){const t=[],e=this.entries.filter(t=>t.timestamp>Date.now()-6e4);e.length>100&&t.push({type:"Excessive Logging",severity:"medium",details:e.length+" console entries in the last minute may impact performance"});const i={};return this.entries.filter(t=>"error"===t.level).forEach(t=>{const e=JSON.stringify(t.args);i[e]=(i[e]||0)+1}),Object.entries(i).forEach(([,e])=>{e>10&&t.push({type:"Repeated Error",severity:e>50?"high":"medium",details:`Same error occurred ${e} times`})}),this.entries.filter(t=>t.args.some(t=>"object"==typeof t&&null!==t&&!Array.isArray(t))).length>.5*this.entries.length&&t.push({type:"Object Logging",severity:"low",details:"High percentage of object logging may indicate memory leaks"}),t}generateRecommendations(){const t=[],e=this.exportData().stats;return e.errorCount>0&&t.push(`Found ${e.errorCount} console errors. Review error patterns and fix underlying issues.`),e.warningCount>2*e.errorCount&&t.push("High warning-to-error ratio suggests proactive error handling could prevent issues."),e.totalEntries>500&&t.push("Consider reducing console logging in production to improve performance."),e.levelCounts.debug&&e.levelCounts.debug>100&&t.push("Debug logs should be disabled in production environments."),0===t.length&&t.push("Console logging patterns look healthy."),t}}class i{constructor(t,e={}){this.data=[],this.config={radius:20,maxIntensity:100,gradient:{.4:"blue",.6:"cyan",.7:"lime",.8:"yellow",1:"red"},blur:15,minOpacity:0,maxOpacity:.6,...e},this.canvas=document.createElement("canvas"),this.canvas.style.position="absolute",this.canvas.style.top="0",this.canvas.style.left="0",this.canvas.style.pointerEvents="none",this.canvas.style.zIndex="9999",t.appendChild(this.canvas);const i=this.canvas.getContext("2d");if(!i)throw Error("Failed to get canvas context");this.ctx=i,this.resizeCanvas(),window.addEventListener("resize",()=>this.resizeCanvas())}resizeCanvas(){const t=this.canvas.parentElement.getBoundingClientRect();this.canvas.width=t.width,this.canvas.height=t.height,this.canvas.style.width=t.width+"px",this.canvas.style.height=t.height+"px"}addDataPoint(t,e,i,s){this.data.push({x:t,y:e,intensity:i,event_type:s,timestamp:Date.now()}),this.data.length>1e4&&(this.data=this.data.slice(-8e3))}generateFromEvents(t){this.data=[],t.forEach(t=>{var e,i,s,n,r,o;"click"===t.type&&(null===(e=t.data)||void 0===e?void 0:e.x)&&(null===(i=t.data)||void 0===i?void 0:i.y)?this.addDataPoint(t.data.x,t.data.y,10,"click"):"mousemove"===t.type&&(null===(s=t.data)||void 0===s?void 0:s.x)&&(null===(n=t.data)||void 0===n?void 0:n.y)?this.addDataPoint(t.data.x,t.data.y,2,"move"):"scroll"===t.type&&void 0!==(null===(r=t.data)||void 0===r?void 0:r.scrollX)&&void 0!==(null===(o=t.data)||void 0===o?void 0:o.scrollY)&&this.addDataPoint(t.data.scrollX||0,t.data.scrollY||0,5,"scroll")})}render(t){if(this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),0===this.data.length)return;const e=t?this.data.filter(e=>t.includes(e.event_type)):this.data,i=this.createIntensityMap(e),s=this.createGradient();this.renderHeatmap(i,s)}createIntensityMap(t){const e=document.createElement("canvas");e.width=this.canvas.width,e.height=this.canvas.height;const i=e.getContext("2d");return t.forEach(t=>{const e=this.config.radius,s=i.createRadialGradient(t.x,t.y,0,t.x,t.y,e);s.addColorStop(0,`rgba(0, 0, 0, ${Math.min(t.intensity/this.config.maxIntensity,1)})`),s.addColorStop(1,"rgba(0, 0, 0, 0)"),i.fillStyle=s,i.fillRect(t.x-e,t.y-e,2*e,2*e)}),i.filter=`blur(${this.config.blur}px)`,i.drawImage(e,0,0),i.getImageData(0,0,e.width,e.height)}createGradient(){const t=document.createElement("canvas");t.width=256,t.height=1;const e=t.getContext("2d"),i=e.createLinearGradient(0,0,256,0);return Object.entries(this.config.gradient).forEach(([t,e])=>{i.addColorStop(parseFloat(t),e)}),e.fillStyle=i,e.fillRect(0,0,256,1),e.getImageData(0,0,256,1)}renderHeatmap(t,e){const i=this.ctx.createImageData(t.width,t.height);for(let s=0;t.data.length>s;s+=4){const n=t.data[s+3];if(n>0){const t=4*Math.floor(n/255*255);i.data[s]=e.data[t],i.data[s+1]=e.data[t+1],i.data[s+2]=e.data[t+2],i.data[s+3]=Math.floor(n*this.config.maxOpacity)}}this.ctx.putImageData(i,0,0)}clear(){this.data=[],this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)}destroy(){this.clear(),this.canvas.parentElement&&this.canvas.parentElement.removeChild(this.canvas),window.removeEventListener("resize",()=>this.resizeCanvas())}exportData(){const t={};let e=1/0,i=-1/0,s=1/0,n=-1/0,r=1/0,o=-1/0;return this.data.forEach(a=>{t[a.event_type]=(t[a.event_type]||0)+1,e=Math.min(e,a.x),i=Math.max(i,a.x),s=Math.min(s,a.y),n=Math.max(n,a.y),r=Math.min(r,a.timestamp),o=Math.max(o,a.timestamp)}),{config:this.config,data:[...this.data],stats:{totalEvents:this.data.length,eventTypes:t,timeRange:{start:r,end:o},bounds:{minX:e,maxX:i,minY:s,maxY:n}}}}generateInsights(){return{hotSpots:this.findHotSpots(),clickPatterns:this.analyzeClickPatterns(),userBehavior:this.analyzeUserBehavior()}}findHotSpots(){const t=[],e=2*this.config.radius;return this.data.forEach(i=>{let s=!1;for(const n of t)if(e>=Math.sqrt(Math.pow(i.x-n.x,2)+Math.pow(i.y-n.y,2))){n.x=(n.x*n.count+i.x)/(n.count+1),n.y=(n.y*n.count+i.y)/(n.count+1),n.intensity+=i.intensity,n.count++,s=!0;break}s||t.push({x:i.x,y:i.y,intensity:i.intensity,count:1})}),t.filter(t=>t.count>=3).sort((t,e)=>e.intensity-t.intensity).slice(0,10).map(t=>({x:Math.round(t.x),y:Math.round(t.y),intensity:Math.round(t.intensity),radius:Math.min(e,5*t.count)}))}analyzeClickPatterns(){const t=this.data.filter(t=>"click"===t.event_type),e={};for(let i=0;t.length-1>i;i++){const s=t[i],n=t[i+1];if(5e3>n.timestamp-s.timestamp){const t=`(${Math.round(s.x)},${Math.round(s.y)}) -> (${Math.round(n.x)},${Math.round(n.y)})`;e[t]=(e[t]||0)+1}}return Object.entries(e).sort(([,t],[,e])=>e-t).slice(0,5).map(([t,e])=>({pattern:t,frequency:e}))}analyzeUserBehavior(){const t=this.data.filter(t=>"click"===t.event_type),e=this.data.filter(t=>"scroll"===t.event_type),i=[...this.data].sort((t,e)=>e.intensity-t.intensity),s=i.slice(0,Math.floor(.5*i.length)),n=Math.min(...s.map(t=>t.x)),r=Math.max(...s.map(t=>t.x)),o=Math.min(...s.map(t=>t.y)),a=Math.max(...s.map(t=>t.y)),h=e.length>0?Math.max(...e.map(t=>t.y))/this.canvas.height:0,c=Math.min(100,2*t.length+50*h+.1*this.data.filter(t=>"move"===t.event_type).length);return{mostActiveArea:{x:Math.round(n),y:Math.round(o),width:Math.round(r-n),height:Math.round(a-o)},averageClicksPerSession:Math.round(t.length),scrollDepth:Math.round(100*h)/100,engagementScore:Math.round(c)}}}class s{constructor(s,n){var r,o,a,h,c,l,d,u,p,m,f,g,v,y,w,b,M;if(this.heatmapGenerator=null,this.events=[],this.consoleLogs=[],this.networkRequests=new Map,this.isRecording=!1,this.originalConsole={},this.config=s,this.sessionId=n,this.startTime=Date.now(),this.domSerializer=new t(s),this.consoleRecorder=new e(n,{maxEntries:(null===(r=s.replay)||void 0===r?void 0:r.maxConsoleEntries)||1e3,captureStackTrace:!1!==(null===(o=s.replay)||void 0===o?void 0:o.captureStackTrace),serializeObjects:!1!==(null===(a=s.replay)||void 0===a?void 0:a.serializeObjects),maxObjectDepth:(null===(h=s.replay)||void 0===h?void 0:h.maxObjectDepth)||3,maxStringLength:(null===(c=s.replay)||void 0===c?void 0:c.maxStringLength)||1e4,ignoredLevels:(null===(l=s.replay)||void 0===l?void 0:l.ignoredConsoleLevels)||[]}),(null===(d=this.config.replay)||void 0===d?void 0:d.enabled)&&(this.setupReplay(),(null===(p=null===(u=this.config.replay)||void 0===u?void 0:u.heatmaps)||void 0===p?void 0:p.enabled)&&"undefined"!=typeof document)){const t=document.body||document.documentElement;t&&(this.heatmapGenerator=new i(t,{radius:(null===(f=null===(m=s.replay)||void 0===m?void 0:m.heatmaps)||void 0===f?void 0:f.radius)||20,maxIntensity:(null===(v=null===(g=s.replay)||void 0===g?void 0:g.heatmaps)||void 0===v?void 0:v.maxIntensity)||100,blur:(null===(w=null===(y=s.replay)||void 0===y?void 0:y.heatmaps)||void 0===w?void 0:w.blur)||15,maxOpacity:(null===(M=null===(b=s.replay)||void 0===b?void 0:b.heatmaps)||void 0===M?void 0:M.maxOpacity)||.6}))}}startRecording(){var t;!this.isRecording&&(null===(t=this.config.replay)||void 0===t?void 0:t.enabled)&&(this.isRecording=!0,this.takeFullSnapshot(),this.domSerializer.startEnhancedObserving(this.handleDOMChange.bind(this)),this.consoleRecorder.start(),this.setupNetworkCapture(),this.setupInteractionTracking(),setInterval(()=>{this.isRecording&&this.takeFullSnapshot()},6e4))}stopRecording(){this.isRecording&&(this.isRecording=!1,this.domSerializer.stopEnhancedObserving(),this.consoleRecorder.stop(),this.restoreOriginalNetwork(),this.heatmapGenerator&&(this.heatmapGenerator.destroy(),this.heatmapGenerator=null))}getReplayData(){const t=this.consoleRecorder.getEntries(),e=this.consoleRecorder.generateInsights();let i,s;return this.heatmapGenerator&&(i=this.heatmapGenerator.exportData().data,s=this.heatmapGenerator.generateInsights()),{events:[...this.events],console_logs:t,network_requests:Array.from(this.networkRequests.values()),heatmap_data:i,session_info:{session_id:this.sessionId,start_time:this.startTime,duration:Date.now()-this.startTime,page_url:window.location.href},analytics:{console_insights:e,heatmap_insights:s}}}clearReplayData(){this.events=[],this.consoleLogs=[],this.networkRequests.clear(),this.consoleRecorder.clear(),this.heatmapGenerator&&this.heatmapGenerator.clear()}setupReplay(){if("undefined"==typeof window)return;let t;document.addEventListener("visibilitychange",()=>{this.addCustomEvent("visibility_change",{hidden:document.hidden})}),window.addEventListener("focus",()=>{this.addCustomEvent("window_focus",{})}),window.addEventListener("blur",()=>{this.addCustomEvent("window_blur",{})}),window.addEventListener("resize",()=>{this.addCustomEvent("viewport_change",{width:window.innerWidth,height:window.innerHeight})}),window.addEventListener("scroll",()=>{clearTimeout(t),t=setTimeout(()=>{this.heatmapGenerator&&this.heatmapGenerator.addDataPoint(window.scrollX||0,window.scrollY||0,5,"scroll"),this.addCustomEvent("scroll",{x:window.scrollX,y:window.scrollY})},100)},{passive:!0})}takeFullSnapshot(){if(this.isRecording)try{const t=this.domSerializer.takeEnhancedSnapshot();this.addEvent({type:"full_snapshot",timestamp:Date.now(),data:t})}catch(t){}}handleDOMChange(t){this.isRecording&&this.addEvent({type:"incremental_snapshot",timestamp:t.timestamp,data:{source:"mutation",...t}})}renderHeatmap(t){this.heatmapGenerator&&this.heatmapGenerator.render(t)}toggleHeatmap(t){this.heatmapGenerator&&(t?this.heatmapGenerator.render():this.heatmapGenerator.clear())}getHeatmapInsights(){var t;return(null===(t=this.heatmapGenerator)||void 0===t?void 0:t.generateInsights())||null}setupNetworkCapture(){if(void 0!==window.fetch&&(this.originalFetch=window.fetch,window.fetch=async(t,e)=>{const i=Date.now(),s=this.generateRequestId(),n=t instanceof Request?t.url:""+t,r=(null==e?void 0:e.method)||(t instanceof Request?t.method:"GET");this.isRecording&&this.networkRequests.set(s,{timestamp:i,id:s,method:r,url:n,requestHeaders:this.getRequestHeaders(e,t),requestBody:await this.serializeRequestBody(e,t)});try{const n=await this.originalFetch(t,e),r=Date.now()-i;if(this.isRecording){const t=this.networkRequests.get(s);if(t&&(t.status=n.status,t.duration=r,t.responseHeaders=this.getResponseHeaders(n),this.shouldCaptureResponseBody(n)))try{const e=n.clone();t.responseBody=await e.text()}catch(t){}}return n}catch(t){const e=Date.now()-i;if(this.isRecording){const t=this.networkRequests.get(s);t&&(t.duration=e,t.failed=!0)}throw t}}),"undefined"!=typeof XMLHttpRequest){this.originalXMLHttpRequest=XMLHttpRequest;const t=this;window.XMLHttpRequest=function(){const e=new t.originalXMLHttpRequest,i=t.generateRequestId();let s="GET",n="",r=0;const o=e.open,a=e.send;return e.open=function(t,e,...i){return s=t,n=""+e,o.call(this,t,e,...i)},e.send=function(e){return r=Date.now(),t.isRecording&&t.networkRequests.set(i,{timestamp:r,id:i,method:s,url:n,requestBody:e}),a.call(this,e)},e.addEventListener("loadend",()=>{const s=Date.now()-r;if(t.isRecording){const n=t.networkRequests.get(i);n&&(n.status=e.status,n.duration=s,n.failed=0===e.status||e.status>=400,t.shouldCaptureXHRResponse(e)&&(n.responseBody=e.responseText))}}),e}}}setupInteractionTracking(){["mousedown","mouseup","click","dblclick","mousemove"].forEach(t=>{document.addEventListener(t,e=>{if(this.isRecording&&("mousemove"!==t||.1>=Math.random())){if(this.heatmapGenerator){let i=1;"click"===t?i=10:"mousemove"===t?i=2:"mousedown"===t&&(i=5),this.heatmapGenerator.addDataPoint(e.clientX,e.clientY,i,"click"===t?"click":"move")}this.addEvent({type:"incremental_snapshot",timestamp:Date.now(),data:{source:"mouse",type:t,x:e.clientX,y:e.clientY,id:this.getElementId(e.target)}})}},{capture:!0,passive:!0})}),document.addEventListener("keydown",t=>{this.isRecording&&(this.shouldIgnoreKeystroke(t)||this.addEvent({type:"incremental_snapshot",timestamp:Date.now(),data:{source:"keyboard",type:"keydown",key:this.sanitizeKey(t.key),code:t.code,id:this.getElementId(t.target)}}))},{capture:!0,passive:!0})}addEvent(t){this.events.push(t),this.events.length>1e4&&(this.events=this.events.slice(-8e3))}addCustomEvent(t,e){this.addEvent({type:"custom",timestamp:Date.now(),data:{type:t,...e}})}serializeConsoleArgs(t){return t.map(t=>{try{return"object"==typeof t&&null!==t?JSON.parse(JSON.stringify(t)):t}catch(t){return"[Unserializable Object]"}})}generateRequestId(){return Date.now().toString(36)+Math.random().toString(36).substr(2)}getRequestHeaders(t,e){const i={};return(null==t?void 0:t.headers)&&(t.headers instanceof Headers?t.headers.forEach((t,e)=>{i[e]=t}):Array.isArray(t.headers)?t.headers.forEach(([t,e])=>{i[t]=e}):Object.assign(i,t.headers)),e instanceof Request&&e.headers.forEach((t,e)=>{i[e]=t}),i}getResponseHeaders(t){const e={};return t.headers.forEach((t,i)=>{e[i]=t}),e}async serializeRequestBody(t,e){let i=null==t?void 0:t.body;if(e instanceof Request&&!i)try{i=await e.clone().text()}catch(t){return null}if(!i)return null;if("string"==typeof i)return i.length>1e4?i.substring(0,1e4)+"...[truncated]":i;if(i instanceof FormData){const t={};return i.forEach((e,i)=>{t[i]=e instanceof File?`[File: ${e.name}]`:e}),t}return"[Binary Data]"}shouldCaptureResponseBody(t){const e=t.headers.get("content-type")||"",i=parseInt(t.headers.get("content-length")||"0");return e.includes("application/json")||e.includes("text/")||i>0&&1e5>i}shouldCaptureXHRResponse(t){const e=t.getResponseHeader("content-type")||"";return e.includes("application/json")||e.includes("text/")||t.responseText&&1e5>t.responseText.length}getElementId(t){return t?Math.random():void 0}shouldIgnoreKeystroke(t){const e=t.target;if(e&&e.tagName){if("input"===e.tagName.toLowerCase()&&"password"===e.type)return!0;if(e.hasAttribute("data-revi-ignore"))return!0}return!1}sanitizeKey(t){return 1===t.length&&/[a-zA-Z0-9]/.test(t)?"*":t}restoreOriginalNetwork(){this.originalFetch&&(window.fetch=this.originalFetch),this.originalXMLHttpRequest&&(window.XMLHttpRequest=this.originalXMLHttpRequest)}}export{s as SessionReplayManager};
//# sourceMappingURL=session-replay.esm.js.map
